(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const c of a)if(c.type==="childList")for(const d of c.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&o(d)}).observe(document,{childList:!0,subtree:!0});function e(a){const c={};return a.integrity&&(c.integrity=a.integrity),a.referrerPolicy&&(c.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?c.credentials="include":a.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function o(a){if(a.ep)return;a.ep=!0;const c=e(a);fetch(a.href,c)}})();const dn={line:{_useStick:!0,radius:.05,doubleBondScaling:1.5,tripleBondScaling:1},stick:{radius:.25}},Go=500;function Ae(n){const s=dn[n];return s&&s._useStick?"stick":n}function W(n){const s=dn[n];if(s&&s._useStick){const{_useStick:e,...o}=s;return{stick:o}}return{[n]:s||{}}}let Ge=[];function un(){return{backgroundOpacity:0,borderThickness:0,fontColor:document.body.dataset.theme==="light"?"#000000":"#FFFFFF",fontSize:12,bold:!0}}function fn(n,s){Ge.push({text:n,position:s}),T.addLabel(n,{position:s,...un()})}function pn(){T.removeAllLabels(),Ge=[]}function mn(){if(Ge.length===0)return;T.removeAllLabels();const n=un();for(const s of Ge)T.addLabel(s.text,{position:s.position,...n});T.render()}let T=null,he=null;function Wo(n){he=document.createElement("div"),he.id="viewer-canvas",he.style.width="100%",he.style.height="100%",n.appendChild(he),T=$3Dmol.createViewer(he,{backgroundColor:"#000000",antialias:!0});const s=4e-4,e=250,o=.1;he.addEventListener("wheel",d=>{d.preventDefault(),d.stopPropagation();const h=1-d.deltaY*s;T.zoom(h);const u=T.getView();u[3]>e?(u[3]=e,T.setView(u)):u[3]<o&&(u[3]=o,T.setView(u)),T.render()},{capture:!0,passive:!1});let a=null;return new ResizeObserver(()=>{a||(a=requestAnimationFrame(()=>{T.resize(),T.render(),a=null}))}).observe(n),T}function L(){return T}async function hn(n){const s=`https://files.rcsb.org/download/${n}.pdb`,e=await fetch(s);if(!e.ok)throw new Error(`Failed to fetch PDB "${n}": ${e.status} ${e.statusText}`);const o=await e.text(),a=T.addModel(o,"pdb");return T.setStyle({model:a},W("line")),T.zoomTo(),Ct(),T.render(),a}function gn(n,s){const e=T.addModel(n,s);return T.setStyle({model:e},W("line")),T.zoomTo(),Ct(),T.render(),e}function Xt(n){return T.selectedAtoms(n||{})}function Ko(n){const s=n.map(o=>[...o]),e=[[1,0,0],[0,1,0],[0,0,1]];for(let o=0;o<50;o++){let a=0,c=1,d=Math.abs(s[0][1]);if(Math.abs(s[0][2])>d&&(a=0,c=2,d=Math.abs(s[0][2])),Math.abs(s[1][2])>d&&(a=1,c=2,d=Math.abs(s[1][2])),d<1e-10)break;const h=s[a][a]-s[c][c];let u;if(Math.abs(h)<1e-10)u=1;else{const C=h/(2*s[a][c]);u=1/(Math.abs(C)+Math.sqrt(C*C+1)),C<0&&(u=-u)}const m=1/Math.sqrt(u*u+1),p=u*m,b=s[a][a]+u*s[a][c],g=s[c][c]-u*s[a][c];s[a][c]=0,s[c][a]=0,s[a][a]=b,s[c][c]=g;for(let C=0;C<3;C++){if(C===a||C===c)continue;const w=m*s[C][a]+p*s[C][c],y=-p*s[C][a]+m*s[C][c];s[C][a]=w,s[a][C]=w,s[C][c]=y,s[c][C]=y}for(let C=0;C<3;C++){const w=m*e[C][a]+p*e[C][c],y=-p*e[C][a]+m*e[C][c];e[C][a]=w,e[C][c]=y}}return{eigenvalues:[s[0][0],s[1][1],s[2][2]],eigenvectors:[[e[0][0],e[1][0],e[2][0]],[e[0][1],e[1][1],e[2][1]],[e[0][2],e[1][2],e[2][2]]]}}function Zo(n){const s=n[0][0]+n[1][1]+n[2][2];let e,o,a,c;if(s>0){const d=2*Math.sqrt(s+1);e=.25*d,o=(n[2][1]-n[1][2])/d,a=(n[0][2]-n[2][0])/d,c=(n[1][0]-n[0][1])/d}else if(n[0][0]>n[1][1]&&n[0][0]>n[2][2]){const d=2*Math.sqrt(1+n[0][0]-n[1][1]-n[2][2]);e=(n[2][1]-n[1][2])/d,o=.25*d,a=(n[0][1]+n[1][0])/d,c=(n[0][2]+n[2][0])/d}else if(n[1][1]>n[2][2]){const d=2*Math.sqrt(1+n[1][1]-n[0][0]-n[2][2]);e=(n[0][2]-n[2][0])/d,o=(n[0][1]+n[1][0])/d,a=.25*d,c=(n[1][2]+n[2][1])/d}else{const d=2*Math.sqrt(1+n[2][2]-n[0][0]-n[1][1]);e=(n[1][0]-n[0][1])/d,o=(n[0][2]+n[2][0])/d,a=(n[1][2]+n[2][1])/d,c=.25*d}return[o,a,c,e]}function we(n){const s=T.selectedAtoms(n||{});if(s.length<2){T.zoomTo(n||{}),T.render();return}const e=s.length;let o=0,a=0,c=0;for(const A of s)o+=A.x,a+=A.y,c+=A.z;o/=e,a/=e,c/=e;const d=[[0,0,0],[0,0,0],[0,0,0]];for(const A of s){const B=A.x-o,O=A.y-a,M=A.z-c;d[0][0]+=B*B,d[0][1]+=B*O,d[0][2]+=B*M,d[1][1]+=O*O,d[1][2]+=O*M,d[2][2]+=M*M}d[1][0]=d[0][1],d[2][0]=d[0][2],d[2][1]=d[1][2];const{eigenvalues:h,eigenvectors:u}=Ko(d),m=[0,1,2].sort((A,B)=>h[B]-h[A]),p=u[m[0]],b=u[m[1]];let g=u[m[2]];const C=[p[1]*b[2]-p[2]*b[1],p[2]*b[0]-p[0]*b[2],p[0]*b[1]-p[1]*b[0]];C[0]*g[0]+C[1]*g[1]+C[2]*g[2]<0&&(g=[-g[0],-g[1],-g[2]]);const y=Zo([p,b,g]);T.zoomTo(n||{});const S=T.getView();S[4]=y[0],S[5]=y[1],S[6]=y[2],S[7]=y[3],T.setView(S),T.render()}let ze=[],dt=!1,ut=null,ft=null;function Ct(){ft&&T&&T.setClickable({},!0,function(n,s,e){ft(n,s,e)})}function bn(n){ft=n,Ct(),T.render()}function be(){if(dt&&ut){T.removeAllShapes(),dt=!1,ut=null,T.render();return}if(ze.length!==0){for(const n of ze)T.removeShape(n);ze=[],T.render()}}function ye(n){const s=T.selectedAtoms(n);if(s.length>=Go){T.addStyle(n,{sphere:{radius:.4,color:"yellow",opacity:.35}}),dt=!0,ut=n,T.render();return}for(const e of s){const o=T.addSphere({center:{x:e.x,y:e.y,z:e.z},radius:.5,color:"#FFFF00",alpha:.5});ze.push(o)}T.render()}const Qt=["atoms","residues","chains","molecules"];function Yo(n,s){let e="atoms",o=!0,a=!0,c=!1,d="dark",h=null,u=null,m=null;function p(){h&&(h.remove(),h=null),u&&(u.classList.remove("active"),u=null),b()}function b(){m&&(m.remove(),m=null)}function g(x,{checked:I=!1,onClick:R}={}){const U=document.createElement("div");return U.className="menubar-dropdown-item",I&&U.classList.add("checked"),U.textContent=x,U.addEventListener("click",Z=>{Z.stopPropagation(),R&&R(U)}),U}function C(){const x=document.createElement("div");return x.className="menubar-dropdown",x.appendChild(g("Load...",{onClick:()=>{p(),s.onLoad&&s.onLoad()}})),x.appendChild(g("Export Image...",{onClick:()=>{p(),s.onExport&&s.onExport()}})),x}function w(x,I){const R=document.createElement("div");R.className="menubar-dropdown-section-header",R.textContent=I,x.appendChild(R)}function y(x){const I=document.createElement("div");I.className="menubar-dropdown-separator",x.appendChild(I)}function S(){const x=document.createElement("div");x.className="menubar-dropdown",w(x,"Selections");const I=[{label:"Protein",value:"protein"},{label:"Ligand",value:"ligand"},{label:"Backbone",value:"backbone"},{label:"Side Chains",value:"sidechains"}];for(const Z of I)x.appendChild(g(Z.label,{onClick:()=>{p(),s.onSelect&&s.onSelect(Z.value)}}));y(x),w(x,"Expand");const R=[{label:"Residues",value:"residues"},{label:"Chains",value:"chains"},{label:"Molecules",value:"molecules"},{label:"Near Atoms (5Å)",value:"nearAtoms"},{label:"Near Residues (5Å)",value:"nearResidues"}];for(const Z of R)x.appendChild(g(Z.label,{onClick:()=>{p(),s.onExpand&&s.onExpand(Z.value)}}));y(x),w(x,"Action");const U=[{label:"Center",value:"center"},{label:"Zoom",value:"zoom"}];for(const Z of U)x.appendChild(g(Z.label,{onClick:()=>{p(),s.onSelectionAction&&s.onSelectionAction(Z.value)}}));return x}function A(){const x=document.createElement("div");x.className="menubar-dropdown";const I=[{label:"Simple",value:"simple"},{label:"Sites",value:"sites"},{label:"Ball-and-Stick",value:"ball-and-stick"}];for(const R of I)x.appendChild(g(R.label,{onClick:()=>{p(),s.onView&&s.onView(R.value)}}));return x}function B(){const x=document.createElement("div");x.className="menubar-dropdown";const I=g("Sidebar",{checked:o,onClick:ee=>{o=!o,ee.classList.toggle("checked",o),p(),s.onToggleSidebar&&s.onToggleSidebar()}});x.appendChild(I);const R=g("Terminal",{checked:a,onClick:ee=>{a=!a,ee.classList.toggle("checked",a),p(),s.onToggleTerminal&&s.onToggleTerminal()}});x.appendChild(R);const U=document.createElement("div");U.className="menubar-dropdown-separator",x.appendChild(U);const Z=g("Compact Menu",{checked:c,onClick:ee=>{c=!c,ee.classList.toggle("checked",c),p(),s.onToggleCompact&&s.onToggleCompact(c)}});x.appendChild(Z),y(x),w(x,"Theme");const pe=[{label:"Dark",value:"dark"},{label:"Light",value:"light"}];for(const ee of pe)x.appendChild(g(ee.label,{checked:d===ee.value,onClick:()=>{d=ee.value,p(),s.onThemeChange&&s.onThemeChange(ee.value)}}));return x}const O={File:C,View:A,Select:S,Window:B},M=[];for(const x of Object.keys(O)){const I=document.createElement("div");I.className="menubar-item",I.textContent=x,I.addEventListener("click",R=>{if(R.stopPropagation(),u===I){p();return}p();const U=O[x]();I.appendChild(U),I.classList.add("active"),h=U,u=I}),n.appendChild(I),M.push(I)}const q=document.createElement("div");q.className="menubar-mode-picker";const J=document.createElement("span");J.textContent=e.charAt(0).toUpperCase()+e.slice(1),q.appendChild(J);const K=document.createElement("span");K.className="menubar-mode-arrow",K.textContent="▼",q.appendChild(K),q.addEventListener("click",x=>{if(x.stopPropagation(),u===q){p();return}p();const I=document.createElement("div");I.className="menubar-dropdown",I.style.right="0",I.style.left="auto";for(const R of Qt){const U=R.charAt(0).toUpperCase()+R.slice(1);I.appendChild(g(U,{checked:R===e,onClick:()=>{e=R,J.textContent=U,p(),s.onSelectionMode&&s.onSelectionMode(R)}}))}q.appendChild(I),h=I,u=q}),n.appendChild(q);const G=document.createElement("div");return G.className="menubar-hamburger",G.textContent="☰",G.style.display="none",G.addEventListener("click",x=>{if(x.stopPropagation(),m){b();return}const I=document.createElement("div");I.className="menubar-dropdown menubar-hamburger-dropdown";for(const R of Object.keys(O)){const U=document.createElement("div");U.className="menubar-hamburger-menu-item";const Z=document.createElement("span");Z.textContent=R,U.appendChild(Z);const pe=document.createElement("span");pe.className="menubar-hamburger-arrow",pe.textContent="▶",U.appendChild(pe);const ee=O[R]();ee.className="menubar-hamburger-submenu",U.appendChild(ee),I.appendChild(U)}G.appendChild(I),m=I}),n.insertBefore(G,n.firstChild),document.addEventListener("click",()=>{p()}),document.addEventListener("keydown",x=>{x.key==="Escape"&&p()}),{getElement(){return n},setSelectionMode(x){Qt.includes(x)&&(e=x,J.textContent=x.charAt(0).toUpperCase()+x.slice(1))},setTheme(x){(x==="dark"||x==="light")&&(d=x)},setCompact(x){if(c=x,x){G.style.display="";for(const I of M)I.style.display="none"}else{G.style.display="none";for(const I of M)I.style.display="";b()}}}}const vn=[{label:"Cyan",hex:"#00FFFF"},{label:"Pink",hex:"#FFC0CB"},{label:"Turquoise",hex:"#30D5C8"},{label:"Teal",hex:"#008080"},{label:"Sage",hex:"#B2AC88"},{label:"Lavender",hex:"#E6E6FA"},{label:"Aquamarine",hex:"#7FFFD4"},{label:"Pale Turquoise",hex:"#AFEEEE"},{label:"Light Pink",hex:"#FFB6C1"},{label:"Robin's Egg",hex:"#00CCCC"},{label:"Cerulean",hex:"#007BA7"},{label:"Periwinkle",hex:"#CCCCFF"},{label:"Orange Cream",hex:"#FDE4CF"},{label:"Peach",hex:"#FFCFD2"},{label:"Purple Blue",hex:"#A3C4F3"},{label:"Light Blue",hex:"#8EECF5"},{label:"Marine",hex:"#98F5E1"},{label:"Pastel Blue",hex:"#90DBF4"}],Cn=[{label:"Red",hex:"#FF0000"},{label:"Coral",hex:"#FF7F50"},{label:"Salmon",hex:"#FA8072"},{label:"Rose",hex:"#FF007F"},{label:"Light Coral",hex:"#F08080"},{label:"Peach",hex:"#FFCFD2"},{label:"Orange",hex:"#FFA500"},{label:"Light Orange",hex:"#FFA07A"},{label:"Orange Cream",hex:"#FDE4CF"},{label:"Mustard",hex:"#FFDB58"},{label:"Yellow",hex:"#FFFF00"},{label:"Light Yellow",hex:"#FFFFE0"},{label:"Green",hex:"#00FF00"},{label:"Light Green",hex:"#90EE90"},{label:"Pastel Green",hex:"#B9FBC0"},{label:"Feijoa",hex:"#A5D785"},{label:"Sage",hex:"#B2AC88"},{label:"Marine",hex:"#98F5E1"},{label:"Cyan",hex:"#00FFFF"},{label:"Teal",hex:"#008080"},{label:"Turquoise",hex:"#30D5C8"},{label:"Aquamarine",hex:"#7FFFD4"},{label:"Pale Turquoise",hex:"#AFEEEE"},{label:"Robin's Egg",hex:"#00CCCC"},{label:"Blue",hex:"#0000FF"},{label:"Cerulean",hex:"#007BA7"},{label:"Pastel Blue",hex:"#90DBF4"},{label:"Light Blue",hex:"#8EECF5"},{label:"Purple Blue",hex:"#A3C4F3"},{label:"Periwinkle",hex:"#CCCCFF"},{label:"Purple",hex:"#800080"},{label:"Magenta",hex:"#FF00FF"},{label:"Light Purple",hex:"#F1C0E8"},{label:"Pastel Purple",hex:"#CFBAF0"},{label:"Lavender",hex:"#E6E6FA"},{label:"Pink",hex:"#FFC0CB"},{label:"Light Pink",hex:"#FFB6C1"},{label:"Canary",hex:"#FBF8CC"},{label:"White",hex:"#FFFFFF"},{label:"Grey",hex:"#808080"}],ke={pastel:{label:"Pastel",colors:["#A3C4F3","#B9FBC0","#FFCFD2","#FDE4CF","#CFBAF0","#FBF8CC","#90DBF4","#F1C0E8","#98F5E1","#8EECF5"]},bright:{label:"Pastel (Bright)",colors:["#FF6B6B","#4ECDC4","#FFE66D","#95E1D3","#F38181","#AA96DA","#FCE38A","#A8E6CF","#FF8B94","#DCD6F7"]},dark:{label:"Pastel (Dark)",colors:["#4682B4","#2E8B57","#CD5C5C","#DAA520","#6A5ACD","#20B2AA","#BC8F8F","#8FBC8F","#DB7093","#B8860B"]},rainbow:{label:"Rainbow",colors:["#FF0000","#FF7F00","#FFFF00","#00FF00","#00FFFF","#0000FF","#8B00FF","#FF00FF"]},coolwarm:{label:"Coolwarm",colors:["#3B4CC0","#6788EE","#88BBFF","#AADDFF","#DDDDDD","#FFBBAA","#FF8866","#EE5533","#C03030"]},primary:{label:"Primary Colors",colors:["#FF0000","#0000FF","#FFFF00","#00FF00","#FFA500","#800080","#00FFFF","#FF00FF"]}},wt=[{key:"cool",helix:"#90DBF4",sheet:"#F1C0E8",loop:"#FFCFD2"},{key:"warm",helix:"#FF8B94",sheet:"#8EECF5",loop:"#D3D3D3"},{key:"default",helix:"#FF0080",sheet:"#FFC800",loop:"#FFFFFF"},{key:"classic",helix:"#FF8B94",sheet:"#FCE38A",loop:"#B9FBC0"}],Jt={min:10,max:50};function wn(n,s){const u=s-n;return function(m){const p=u>0?Math.max(0,Math.min(1,(m.b-n)/u)):0,b=Math.round(144+p*111),g=Math.round(219+p*-80),C=Math.round(244+p*-96);return b<<16|g<<8|C}}let Re=null,pt=null,Ue=null;function ce(){Re&&(Re.remove(),Re=null),pt=null,Ue&&(Ue(),Ue=null)}function ot(n,s,e){if(pt===n){ce();return}ce();const o=document.createElement("div");o.className="popup-menu";for(const b of s)if(b.separator){const g=document.createElement("div");g.className="popup-menu-separator",o.appendChild(g)}else if(b.submenu==="element-swatches"){const g=document.createElement("div");g.className="popup-menu-item popup-menu-has-submenu";const C=document.createElement("span");C.textContent=b.label,g.appendChild(C);const w=document.createElement("span");w.className="popup-menu-arrow",w.textContent="▶",g.appendChild(w);const y=document.createElement("div");y.className="popup-menu-submenu";const S=document.createElement("div");S.className="popup-menu-submenu-item",S.textContent="Standard",S.addEventListener("click",O=>{O.stopPropagation(),ce(),e(b.value)}),y.appendChild(S);const A=document.createElement("div");A.className="popup-menu-separator",y.appendChild(A);const B=document.createElement("div");B.className="swatch-grid";for(const O of vn){const M=document.createElement("div");M.className="swatch-cell",M.style.backgroundColor=O.hex,M.title=`${O.label} (${O.hex})`,M.addEventListener("click",q=>{q.stopPropagation(),ce(),e(b.value+":"+O.hex)}),B.appendChild(M)}y.appendChild(B),g.appendChild(y),o.appendChild(g)}else if(b.submenu==="solid-swatches"){const g=document.createElement("div");g.className="popup-menu-item popup-menu-has-submenu";const C=document.createElement("span");C.textContent=b.label,g.appendChild(C);const w=document.createElement("span");w.className="popup-menu-arrow",w.textContent="▶",g.appendChild(w);const y=document.createElement("div");y.className="popup-menu-submenu";const S=document.createElement("div");S.className="swatch-grid";for(const A of Cn){const B=document.createElement("div");B.className="swatch-cell",B.style.backgroundColor=A.hex,B.title=`${A.label} (${A.hex})`,B.addEventListener("click",O=>{O.stopPropagation(),ce(),e(A.hex)}),S.appendChild(B)}y.appendChild(S),g.appendChild(y),o.appendChild(g)}else if(b.submenu==="chain-palettes"){const g=document.createElement("div");g.className="popup-menu-item popup-menu-has-submenu";const C=document.createElement("span");C.textContent=b.label,g.appendChild(C);const w=document.createElement("span");w.className="popup-menu-arrow",w.textContent="▶",g.appendChild(w);const y=document.createElement("div");y.className="popup-menu-submenu";for(const[S,A]of Object.entries(ke)){const B=document.createElement("div");B.className="popup-menu-submenu-item",B.textContent=A.label,B.addEventListener("click",O=>{O.stopPropagation(),ce(),e("chain:"+S)}),y.appendChild(B)}g.appendChild(y),o.appendChild(g)}else if(b.submenu==="ss-palettes"){const g=document.createElement("div");g.className="popup-menu-item popup-menu-has-submenu";const C=document.createElement("span");C.textContent=b.label,g.appendChild(C);const w=document.createElement("span");w.className="popup-menu-arrow",w.textContent="▶",g.appendChild(w);const y=document.createElement("div");y.className="popup-menu-submenu";for(const S of wt){const A=document.createElement("div");A.className="popup-menu-submenu-item ss-palette-item";const B=document.createElement("span");B.textContent="Helix",B.style.color=S.helix,A.appendChild(B),A.appendChild(document.createTextNode(" – "));const O=document.createElement("span");O.textContent="Sheet",O.style.color=S.sheet,A.appendChild(O),A.appendChild(document.createTextNode(" – "));const M=document.createElement("span");M.textContent="Loop",M.style.color=S.loop,A.appendChild(M),A.addEventListener("click",q=>{q.stopPropagation(),ce(),e("ss:"+S.key)}),y.appendChild(A)}g.appendChild(y),o.appendChild(g)}else{const g=document.createElement("div");g.className="popup-menu-item",g.textContent=b.label,g.addEventListener("click",C=>{C.stopPropagation(),ce(),e(b.value)}),o.appendChild(g)}document.body.appendChild(o),Re=o,pt=n;const a=n.getBoundingClientRect(),c=o.getBoundingClientRect(),d=window.innerHeight;let h;const u=d-a.bottom;u>=c.height||u>=a.top?h=a.bottom:h=a.top-c.height,o.style.position="absolute",o.style.top=`${h+window.scrollY}px`;let m=a.left+window.scrollX;if(m+c.width>window.innerWidth&&(m=a.right+window.scrollX-c.width),m<0&&(m=0),o.style.left=`${m}px`,m+c.width+160>window.innerWidth)for(const b of o.querySelectorAll(".popup-menu-submenu"))b.classList.add("popup-menu-submenu-left");function p(b){!o.contains(b.target)&&b.target!==n&&ce()}requestAnimationFrame(()=>{document.addEventListener("click",p,!0)}),Ue=()=>{document.removeEventListener("click",p,!0)}}const Xo=[{label:"Rename...",value:"rename"},{label:"Delete",value:"delete"},{separator:!0},{label:"Center",value:"center"},{label:"Zoom",value:"zoom"}],Qo={S:"onSelectionShow",H:"onSelectionHide",L:"onSelectionLabel",C:"onSelectionColor"},en={A:{callbackKey:"onAction",items:[{label:"Rename...",value:"rename"},{label:"Duplicate",value:"duplicate"},{label:"Delete",value:"delete"},{separator:!0},{label:"Center",value:"center"},{label:"Orient",value:"orient"},{label:"Zoom",value:"zoom"}]},S:{callbackKey:"onShow",items:[{label:"Cartoon",value:"cartoon"},{label:"Sticks",value:"stick"},{label:"Lines",value:"line"},{label:"Spheres",value:"sphere"},{label:"Surface",value:"surface"},{label:"Cross",value:"cross"},{separator:!0},{label:"Simple",value:"view:simple"},{label:"Sites",value:"view:sites"},{label:"Ball-and-Stick",value:"view:ball-and-stick"}]},H:{callbackKey:"onHide",items:[{label:"Everything",value:"everything"},{separator:!0},{label:"Cartoon",value:"cartoon"},{label:"Sticks",value:"stick"},{label:"Lines",value:"line"},{label:"Spheres",value:"sphere"},{label:"Surface",value:"surface"},{label:"Cross",value:"cross"}]},L:{callbackKey:"onLabel",items:[{label:"Atom Name",value:"atom"},{label:"Residue Name",value:"resn"},{label:"Chain ID",value:"chain"},{label:"Element",value:"elem"},{label:"Index",value:"index"},{separator:!0},{label:"Clear",value:"clear"}]},C:{callbackKey:"onColor",items:[{label:"Solid",value:"solid",submenu:"solid-swatches"},{label:"By Element",value:"element",submenu:"element-swatches"},{label:"By Chain",value:"chain",submenu:"chain-palettes"},{label:"By SS",value:"ss",submenu:"ss-palettes"},{label:"By B-Factor",value:"bfactor"}]}};function Jo(n,s){n.classList.add("sidebar");function e(a,c){const d=document.createElement("div");d.className="sidebar-object",c.visible||d.classList.add("dimmed"),d.addEventListener("click",()=>{s.onToggleVisibility(a)});const h=document.createElement("div");h.className="sidebar-object-status",c.visible&&h.classList.add("active"),d.appendChild(h);const u=document.createElement("span");u.className="sidebar-object-name",u.textContent=a,d.appendChild(u);const m=document.createElement("div");m.className="sidebar-buttons";for(const p of["A","S","H","L","C"]){const b=document.createElement("button");b.className="sidebar-btn",b.textContent=p;const g=en[p];b.addEventListener("click",C=>{C.stopPropagation(),ot(b,g.items,w=>{w.startsWith("view:")&&s.onView?s.onView(a,w.slice(5)):s[g.callbackKey](a,w)})}),m.appendChild(b)}return d.appendChild(m),d}function o(a,c){const d=document.createElement("div");d.className="sidebar-object sidebar-selection",c.visible||d.classList.add("dimmed"),d.addEventListener("click",()=>{s.onToggleSelectionVisibility(a)});const h=document.createElement("div");h.className="sidebar-object-status",c.visible&&h.classList.add("active"),d.appendChild(h);const u=document.createElement("span");u.className="sidebar-object-name",u.textContent=`(${a})`,d.appendChild(u);const m=document.createElement("div");m.className="sidebar-buttons";const p=document.createElement("button");p.className="sidebar-btn",p.textContent="A",p.addEventListener("click",b=>{b.stopPropagation(),ot(p,Xo,g=>{s.onSelectionAction(a,g)})}),m.appendChild(p);for(const b of["S","H","L","C"]){const g=document.createElement("button");g.className="sidebar-btn",g.textContent=b;const C=en[b],w=Qo[b];g.addEventListener("click",y=>{y.stopPropagation(),ot(g,C.items,S=>{S.startsWith("view:")&&s.onSelectionView?s.onSelectionView(a,S.slice(5)):s[w](a,S)})}),m.appendChild(g)}return d.appendChild(m),d}return{refresh(a){const c=new Set;for(const[u,m]of a.objects){c.add("obj:"+u);let p=n.querySelector(`[data-kind="object"][data-name="${CSS.escape(u)}"]`);if(p){p.classList.toggle("dimmed",!m.visible);const b=p.querySelector(".sidebar-object-status");b&&b.classList.toggle("active",m.visible)}else{p=e(u,m),p.dataset.kind="object",p.dataset.name=u;const b=n.querySelector(".sidebar-separator");b?n.insertBefore(p,b):n.appendChild(p)}}const d=a.selections.size>0;let h=n.querySelector(".sidebar-separator");d&&!h?(h=document.createElement("div"),h.className="sidebar-separator",n.appendChild(h)):!d&&h&&h.remove();for(const[u,m]of a.selections){c.add("sel:"+u);let p=n.querySelector(`[data-kind="selection"][data-name="${CSS.escape(u)}"]`);if(!p)p=o(u,m),p.dataset.kind="selection",p.dataset.name=u,n.appendChild(p);else{p.classList.toggle("dimmed",!m.visible);const b=p.querySelector(".sidebar-object-status");b&&b.classList.toggle("active",m.visible)}}for(const u of[...n.querySelectorAll("[data-kind]")]){const m=u.dataset.kind==="object"?"obj:":"sel:";c.has(m+u.dataset.name)||u.remove()}},hide(){n.classList.add("hidden")},show(){n.classList.remove("hidden")},getElement(){return n}}}const el=100,tl=1e3;function nl(n){const s=[];let e=-1,o=null,a=null;const c=document.createElement("div");c.className="terminal-output";const d=document.createElement("div");d.className="terminal-input-row";const h=document.createElement("span");h.className="terminal-prompt",h.textContent=">";const u=document.createElement("textarea");u.className="terminal-input",u.rows=1;const m=document.createElement("button");m.className="terminal-send",m.textContent="Send";const p=document.createElement("button");p.className="terminal-collapse",p.textContent="▾",d.appendChild(h),d.appendChild(u),d.appendChild(m),d.appendChild(p),n.appendChild(c),n.appendChild(d);function b(){u.style.height="auto",u.style.height=Math.min(u.scrollHeight,96)+"px"}function g(){u.style.height=""}u.addEventListener("input",b);function C(){const w=u.value;w.trim()!==""&&(s.push(w),s.length>el&&s.shift(),e=-1,u.value="",g(),o&&o(w))}return u.addEventListener("keydown",w=>{if(w.key==="Tab"){if(w.preventDefault(),!a)return;const y=u.value,S=u.selectionStart,A=y.substring(0,S),B=y.substring(S),O=!A.includes(" ");let M;if(O)M=0;else for(M=Math.max(A.lastIndexOf(","),A.lastIndexOf(" "))+1;M<S&&A[M]===" ";)M++;const q=A.substring(M);if(!q)return;const J=a(q,O);if(!J||J.length===0)return;if(J.length===1){const K=J[0];u.value=A.substring(0,M)+K+" "+B;const G=M+K.length+1;u.selectionStart=u.selectionEnd=G}else{let K=J[0];for(let G=1;G<J.length;G++){let x=0;for(;x<K.length&&x<J[G].length&&K[x]===J[G][x];)x++;K=K.substring(0,x)}if(K.length>q.length){u.value=A.substring(0,M)+K+B;const G=M+K.length;u.selectionStart=u.selectionEnd=G}}b();return}if(w.key==="Enter"&&!w.shiftKey){w.preventDefault(),C();return}if(w.key==="ArrowUp"){const y=u.value.includes(`
`),S=u.selectionStart===0&&u.selectionEnd===0;(!y||S)&&s.length>0&&(w.preventDefault(),e===-1?e=s.length-1:e>0&&e--,u.value=s[e],b());return}if(w.key==="ArrowDown"){const y=u.value.includes(`
`),S=u.selectionStart===0&&u.selectionEnd===0;(!y||S)&&e!==-1&&(w.preventDefault(),e<s.length-1?(e++,u.value=s[e]):(e=-1,u.value=""),b());return}}),m.addEventListener("click",C),p.addEventListener("click",()=>{const w=c.classList.toggle("collapsed");p.textContent=w?"▸":"▾"}),{print(w,y){const S=document.createElement("div");for(S.className="terminal-line"+(y?" "+y:""),S.textContent=w,c.appendChild(S);c.childElementCount>tl;)c.removeChild(c.firstChild);c.scrollTop=c.scrollHeight},clear(){c.innerHTML=""},getElement(){return n},onCommand(w){o=w},setCompleter(w){a=w},hide(){n.style.display="none"},show(){n.style.display=""}}}const z={objects:new Map,selections:new Map,selectionMode:"atoms",activeSelection:null,settings:{bgColor:"#000000",theme:"dark",userSetBgColor:!1},_listeners:[]};function oe(){for(const n of z._listeners)n(z)}function Q(){oe()}function k(){return z}function Ne(n,s,e){let o=n;if(z.objects.has(o)){let a=2;for(;z.objects.has(`${n}_${a}`);)a++;o=`${n}_${a}`}return z.objects.set(o,{model:s,modelIndex:e,visible:!0,representations:new Set(["line"])}),oe(),o}function yn(n){z.objects.delete(n),oe()}function sl(n){const s=z.objects.get(n);return s&&(s.visible=!s.visible,oe()),s}function rl(n){z.selectionMode=n,oe()}function De(n,s,e,o){z.selections.set(n,{expression:s,spec:e,atomCount:o,visible:!0}),oe()}function yt(n){z.selections.delete(n),oe()}function En(n,s){const e=z.selections.get(n);if(!e)return!1;if(z.selections.has(s))throw new Error(`A selection named "${s}" already exists`);return z.selections.delete(n),z.selections.set(s,e),oe(),!0}function Sn(n,s){const e=z.objects.get(n);if(!e)return!1;if(z.objects.has(s))throw new Error(`An object named "${s}" already exists`);return z.objects.delete(n),z.objects.set(s,e),oe(),!0}function ol(n){const s=z.selections.get(n);return s&&(s.visible=!s.visible,oe()),s}function mt(n){const s=new Set(n);let e=!1;const o=[];for(const[a,c]of z.selections)if(c.spec&&Array.isArray(c.spec.index)){const d=c.spec.index.filter(h=>!s.has(h));d.length!==c.spec.index.length&&(e=!0,d.length===0?o.push(a):(c.spec={index:d},c.atomCount=d.length))}for(const a of o)z.selections.delete(a);if(z.activeSelection&&Array.isArray(z.activeSelection.index)){const a=z.activeSelection.index.filter(c=>!s.has(c));a.length===0?(z.activeSelection=null,e=!0):a.length!==z.activeSelection.index.length&&(z.activeSelection={index:a},e=!0)}e&&oe()}function We(n){z.activeSelection=n,oe()}function ll(n){z._listeners.push(n)}function al(n){const s=n.trim(),e=s.indexOf(" ");return e===-1?{name:s.toLowerCase(),args:""}:{name:s.substring(0,e).toLowerCase(),args:s.substring(e+1).trim()}}function te(n){return n?n.split(",").map(s=>s.trim()).filter(s=>s.length>0):[]}function il(){const n=new Map;return{register(s,{handler:e,usage:o,help:a}){n.set(s.toLowerCase(),{handler:e,usage:o,help:a})},execute(s,e){const{name:o,args:a}=al(s);let c=n.get(o);if(!c){const d=[...n.keys()].filter(h=>h.startsWith(o));if(d.length===1)c=n.get(d[0]);else throw d.length>1?new Error(`Ambiguous command "${o}": ${d.join(", ")}`):new Error(`Error: unknown command '${o}'`)}return c.handler(a,e)},list(){return[...n.keys()].sort()},getHelp(s){const e=n.get(s.toLowerCase());return e?{usage:e.usage,help:e.help}:null},has(s){return n.has(s.toLowerCase())},completions(s){const e=s.toLowerCase();return[...n.keys()].filter(o=>o.startsWith(e)).sort()}}}function cl({viewer:n,terminal:s,sidebar:e,state:o}){return{viewer:n,terminal:s,sidebar:e,state:o}}let lt=!1;function dl(n){n.register("fetch",{handler:async(s,e)=>{const o=s.trim().toUpperCase();if(!/^[A-Z0-9]{4}$/.test(o))throw new Error("Usage: fetch <pdb_id> (must be a 4-character PDB ID)");if(lt)throw new Error("A fetch is already in progress. Please wait.");lt=!0;try{e.terminal.print(`Fetching PDB ${o}...`,"info");const a=await hn(o),c=a.getID?a.getID():null,d=Ne(o,a,c);e.terminal.print(`Loaded ${o} as "${d}"`,"result")}catch(a){throw new Error(`Failed to fetch ${o}: ${a.message}`)}finally{lt=!1}},usage:"fetch <pdb_id>",help:"Fetch a structure from the RCSB PDB by ID."}),n.register("load",{handler:(s,e)=>{const o=document.createElement("input");o.type="file",o.style.display="none",o.accept=".pdb,.sdf,.mol2,.xyz,.cube,.pqr,.gro,.cif,.mmcif",o.onchange=a=>{const c=a.target.files[0];if(!c)return;const d=c.name.split(".").pop().toLowerCase(),h=new FileReader;h.onload=u=>{try{const m=gn(u.target.result,d),p=m.getID?m.getID():null,b=c.name.replace(/\.[^.]+$/,""),g=Ne(b,m,p);e.terminal.print(`Loaded "${c.name}" as "${g}"`,"result")}catch(m){e.terminal.print(`Error loading file: ${m.message}`,"error")}},h.onerror=()=>{var u;e.terminal.print(`Error reading file: ${((u=h.error)==null?void 0:u.message)||"unknown error"}`,"error")},h.readAsText(c)},o.click()},usage:"load",help:"Open a file picker to load a local molecular structure file."})}function ul(n,s){function e(){this.constructor=n}e.prototype=s.prototype,n.prototype=new e}function ge(n,s,e,o){var a=Error.call(this,n);return Object.setPrototypeOf&&Object.setPrototypeOf(a,ge.prototype),a.expected=s,a.found=e,a.location=o,a.name="SyntaxError",a}ul(ge,Error);function at(n,s,e){return e=e||" ",n.length>s?n:(s-=n.length,e+=e.repeat(s),n+e.slice(0,s))}ge.prototype.format=function(n){var s="Error: "+this.message;if(this.location){var e=null,o;for(o=0;o<n.length;o++)if(n[o].source===this.location.source){e=n[o].text.split(/\r\n|\n|\r/g);break}var a=this.location.start,c=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(a):a,d=this.location.source+":"+c.line+":"+c.column;if(e){var h=this.location.end,u=at("",c.line.toString().length," "),m=e[a.line-1],p=a.line===h.line?h.column:m.length+1,b=p-a.column||1;s+=`
 --> `+d+`
`+u+` |
`+c.line+" | "+m+`
`+u+" | "+at("",a.column-1," ")+at("",b,"^")}else s+=`
 at `+d}return s};ge.buildMessage=function(n,s){var e={literal:function(m){return'"'+a(m.text)+'"'},class:function(m){var p=m.parts.map(function(b){return Array.isArray(b)?c(b[0])+"-"+c(b[1]):c(b)});return"["+(m.inverted?"^":"")+p.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(m){return m.description}};function o(m){return m.charCodeAt(0).toString(16).toUpperCase()}function a(m){return m.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(p){return"\\x0"+o(p)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(p){return"\\x"+o(p)})}function c(m){return m.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(p){return"\\x0"+o(p)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(p){return"\\x"+o(p)})}function d(m){return e[m.type](m)}function h(m){var p=m.map(d),b,g;if(p.sort(),p.length>0){for(b=1,g=1;b<p.length;b++)p[b-1]!==p[b]&&(p[g]=p[b],g++);p.length=g}switch(p.length){case 1:return p[0];case 2:return p[0]+" or "+p[1];default:return p.slice(0,-1).join(", ")+", or "+p[p.length-1]}}function u(m){return m?'"'+a(m)+'"':"end of input"}return"Expected "+h(n)+" but "+u(s)+" found."};function ht(n,s){s=s!==void 0?s:{};var e={},o=s.grammarSource,a={Selection:Ut},c=Ut,d="around",h="xaround",u="beyond",m="(",p=")",b="byres",g="bychain",C="name",w="resn",y="resi",S="index",A="-",B="chain",O="elem",M="//",q="/",J="protein",K="ligand",G="water",x="solvent",I="organic",R="backbone",U="bb",Z="sidechain",pe="sc",ee="metals",Nn="metal",Dn="nonpolar_hydrogen",Bn="apolarh",jn="polar_hydrogen",Tn="polarh",In="heavy",Pn="hydrogen",On="h",_n="helix",Mn="sheet",Hn="turn",zn="loop",Rn="all",Un="none",qn="and",Vn="or",Gn="not",Wn="xor",Ft="+",At='"',Lt=">=",kt="<=",Kn=">",Zn="<",Yn=".",de=/^[0-9]/,Nt=/^[^"]/,Dt=/^[a-zA-Z0-9*?_\-]/,Xn=/^[a-zA-Z0-9]/,Qn=/^[a-zA-Z]/,Jn=/^[a-z]/,es=/^[a-zA-Z0-9_]/,Be=/^[ \t\n\r]/,Bt=D("around",!0),jt=D("xaround",!0),Tt=D("beyond",!0),ts=D("(",!1),ns=D(")",!1),ss=D("byres",!0),rs=D("bychain",!0),os=D("name",!0),ls=D("resn",!0),as=D("resi",!0),is=D("index",!0),It=D("-",!1),cs=D("chain",!0),ds=D("elem",!0),us=D("//",!1),et=D("/",!1),ue=fe([["0","9"]],!1,!1),fs=D("protein",!0),ps=D("ligand",!0),ms=D("water",!0),hs=D("solvent",!0),gs=D("organic",!0),bs=D("backbone",!0),vs=D("bb",!0),Cs=D("sidechain",!0),ws=D("sc",!0),ys=D("metals",!0),Es=D("metal",!0),Ss=D("nonpolar_hydrogen",!0),$s=D("apolarh",!0),xs=D("polar_hydrogen",!0),Fs=D("polarh",!0),As=D("heavy",!0),Ls=D("hydrogen",!0),ks=D("h",!0),Ns=D("helix",!0),Ds=D("sheet",!0),Bs=D("turn",!0),js=D("loop",!0),Ts=D("all",!0),Is=D("none",!0),Ps=D("and",!0),Os=D("or",!0),_s=D("not",!0),Ms=D("xor",!0),Pt=D("+",!1),Ot=D('"',!1),_t=fe(['"'],!0,!1),Mt=fe([["a","z"],["A","Z"],["0","9"],"*","?","_","-"],!1,!1),Hs=D(">=",!1),zs=D("<=",!1),Rs=D(">",!1),Us=D("<",!1),qs=D(".",!1),Vs=fe([["a","z"],["A","Z"],["0","9"]],!1,!1),Gs=fe([["a","z"],["A","Z"]],!1,!1),Ws=fe([["a","z"]],!1,!1),Ks=fe([["a","z"],["A","Z"],["0","9"],"_"],!1,!1),Zs=zt("optional whitespace"),je=fe([" ","	",`
`,"\r"],!1,!1),Ys=zt("required whitespace"),Xs=function(t){return t},Qs=function(t,l){return l.length===0?t:{type:"xor",children:[t,...l.map(f=>f[3])]}},Js=function(t,l){return l.length===0?t:{type:"or",children:[t,...l.map(f=>f[3])]}},er=function(t,l){return l.length===0?t:{type:"and",children:[t,...l.map(f=>f[3])]}},tr=function(t){return{type:"not",child:t}},nr=function(t,l,i){return{type:l,radius:i,child:t}},sr=function(){return"around"},rr=function(){return"xaround"},or=function(){return"beyond"},lr=function(t){return t},ar=function(t){return{type:"byres",child:t}},ir=function(t){return{type:"bychain",child:t}},cr=function(t,l){return{type:"around",radius:t,child:l}},dr=function(t,l){return{type:"xaround",radius:t,child:l}},ur=function(t,l){return{type:"beyond",radius:t,child:l}},fr=function(t){return{type:"name",values:t}},pr=function(t){return{type:"resn",values:t}},mr=function(t){return{type:"resi",...t}},hr=function(t){return{type:"index",...t}},gr=function(t,l){return{op:t,value:l}},br=function(t,l){return{op:"range",low:t,high:l}},vr=function(t){return{op:"==",value:t}},Cr=function(t){return{type:"chain",value:t}},wr=function(t){return{type:"elem",value:t}},yr=function(t,l){const i=[];return t&&i.push({type:"chain",value:t}),l.resi!==null&&l.resi!==void 0&&i.push({type:"resi",op:"==",value:l.resi}),l.name&&i.push({type:"name",values:[l.name]}),i.length===0&&so("Empty macro specifier"),i.length===1?i[0]:{type:"and",children:i}},Er=function(t,l){return{resi:t,name:l||null}},Sr=function(t){return{resi:null,name:t||null}},$r=function(t){return{resi:null,name:t}},xr=function(){return{resi:null,name:null}},Fr=function(t){return parseInt(t.join(""),10)},Ar=function(){return{type:"protein"}},Lr=function(){return{type:"ligand"}},kr=function(){return{type:"water"}},Nr=function(){return{type:"solvent"}},Dr=function(){return{type:"organic"}},Br=function(){return{type:"backbone"}},jr=function(){return{type:"sidechain"}},Tr=function(){return{type:"metal"}},Ir=function(){return{type:"nonpolar_hydrogen"}},Pr=function(){return{type:"polar_hydrogen"}},Or=function(){return{type:"heavy"}},_r=function(){return{type:"hydrogen"}},Mr=function(){return{type:"helix"}},Hr=function(){return{type:"sheet"}},zr=function(){return{type:"turn"}},Rr=function(){return{type:"loop"}},Ur=function(){return{type:"all"}},qr=function(){return{type:"none"}},Ht=function(t,l){return l},Vr=function(t,l){return[t,...l]},Gr=function(t){return t.join("")},Wr=function(t){return t.join("")},Kr=function(){return">="},Zr=function(){return"<="},Yr=function(){return">"},Xr=function(){return"<"},Qr=function(t){return parseInt(t.join(""),10)},Jr=function(t,l,i){return"."+i.join("")},eo=function(t,l,i){return parseFloat((t||"")+l.join("")+(i||""))},to=function(t){return t},no=function(t,l){return t+(l||"")},r=s.peg$currPos|0,F=r,ve=[{line:1,column:1}],le=r,Te=s.peg$maxFailExpected||[],v=s.peg$silentFails|0,Ee;if(s.startRule){if(!(s.startRule in a))throw new Error(`Can't start parsing from rule "`+s.startRule+'".');c=a[s.startRule]}function so(t,l){throw l=l!==void 0?l:tt(F,r),oo(t,l)}function D(t,l){return{type:"literal",text:t,ignoreCase:l}}function fe(t,l,i){return{type:"class",parts:t,inverted:l,ignoreCase:i}}function ro(){return{type:"end"}}function zt(t){return{type:"other",description:t}}function Rt(t){var l=ve[t],i;if(l)return l;if(t>=ve.length)i=ve.length-1;else for(i=t;!ve[--i];);for(l=ve[i],l={line:l.line,column:l.column};i<t;)n.charCodeAt(i)===10?(l.line++,l.column=1):l.column++,i++;return ve[t]=l,l}function tt(t,l,i){var f=Rt(t),E=Rt(l),j={source:o,start:{offset:t,line:f.line,column:f.column},end:{offset:l,line:E.line,column:E.column}};return j}function $(t){r<le||(r>le&&(le=r,Te=[]),Te.push(t))}function oo(t,l){return new ge(t,null,null,l)}function lo(t,l,i){return new ge(ge.buildMessage(t,l),t,l,i)}function Ut(){var t,l;return t=r,Y(),l=qt(),l!==e?(Y(),F=t,t=Xs(l)):(r=t,t=e),t}function qt(){var t,l,i,f,E,j,_,V;if(t=r,l=nt(),l!==e){for(i=[],f=r,E=Y(),j=Kt(),j!==e?(_=Y(),V=nt(),V!==e?(E=[E,j,_,V],f=E):(r=f,f=e)):(r=f,f=e);f!==e;)i.push(f),f=r,E=Y(),j=Kt(),j!==e?(_=Y(),V=nt(),V!==e?(E=[E,j,_,V],f=E):(r=f,f=e)):(r=f,f=e);F=t,t=Qs(l,i)}else r=t,t=e;return t}function nt(){var t,l,i,f,E,j,_,V;if(t=r,l=st(),l!==e){for(i=[],f=r,E=Y(),j=Wt(),j!==e?(_=Y(),V=st(),V!==e?(E=[E,j,_,V],f=E):(r=f,f=e)):(r=f,f=e);f!==e;)i.push(f),f=r,E=Y(),j=Wt(),j!==e?(_=Y(),V=st(),V!==e?(E=[E,j,_,V],f=E):(r=f,f=e)):(r=f,f=e);F=t,t=Js(l,i)}else r=t,t=e;return t}function st(){var t,l,i,f,E,j,_,V;if(t=r,l=Ie(),l!==e){for(i=[],f=r,E=Y(),j=Gt(),j!==e?(_=Y(),V=Ie(),V!==e?(E=[E,j,_,V],f=E):(r=f,f=e)):(r=f,f=e);f!==e;)i.push(f),f=r,E=Y(),j=Gt(),j!==e?(_=Y(),V=Ie(),V!==e?(E=[E,j,_,V],f=E):(r=f,f=e)):(r=f,f=e);F=t,t=er(l,i)}else r=t,t=e;return t}function Ie(){var t,l,i,f;return t=r,l=Ro(),l!==e?(i=X(),i!==e?(f=Ie(),f!==e?(F=t,t=tr(f)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e),t===e&&(t=ao()),t}function ao(){var t,l,i,f,E,j;return t=r,l=me(),l!==e?(i=X(),i!==e?(f=io(),f!==e?(E=X(),E!==e?(j=_e(),j!==e?(F=t,t=nr(l,f,j)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e),t===e&&(t=me()),t}function io(){var t,l,i,f;return t=r,l=n.substr(r,6),l.toLowerCase()===d?r+=6:(l=e,v===0&&$(Bt)),l!==e?(i=r,v++,f=P(),v--,f===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=sr()):(r=t,t=e)):(r=t,t=e),t===e&&(t=r,l=n.substr(r,7),l.toLowerCase()===h?r+=7:(l=e,v===0&&$(jt)),l!==e?(i=r,v++,f=P(),v--,f===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=rr()):(r=t,t=e)):(r=t,t=e),t===e&&(t=r,l=n.substr(r,6),l.toLowerCase()===u?r+=6:(l=e,v===0&&$(Tt)),l!==e?(i=r,v++,f=P(),v--,f===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=or()):(r=t,t=e)):(r=t,t=e))),t}function me(){var t,l,i,f;return t=r,n.charCodeAt(r)===40?(l=m,r++):(l=e,v===0&&$(ts)),l!==e?(Y(),i=qt(),i!==e?(Y(),n.charCodeAt(r)===41?(f=p,r++):(f=e,v===0&&$(ns)),f!==e?(F=t,t=lr(i)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e),t===e&&(t=co(),t===e&&(t=uo(),t===e&&(t=fo(),t===e&&(t=po(),t===e&&(t=mo(),t===e&&(t=ho(),t===e&&(t=go(),t===e&&(t=bo(),t===e&&(t=Co(),t===e&&(t=wo(),t===e&&(t=vo(),t===e&&(t=yo(),t===e&&(t=Bo(),t===e&&(t=jo(),t===e&&(t=To(),t===e&&(t=Io(),t===e&&(t=$o(),t===e&&(t=xo(),t===e&&(t=Fo(),t===e&&(t=Ao(),t===e&&(t=Lo(),t===e&&(t=ko(),t===e&&(t=No(),t===e&&(t=Do(),t===e&&(t=Po(),t===e&&(t=Oo(),t===e&&(t=_o(),t===e&&(t=Mo(),t===e&&(t=Ho(),t===e&&(t=zo())))))))))))))))))))))))))))))),t}function co(){var t,l,i,f,E;return t=r,l=n.substr(r,5),l.toLowerCase()===b?r+=5:(l=e,v===0&&$(ss)),l!==e?(i=r,v++,f=P(),v--,f===e?i=void 0:(r=i,i=e),i!==e?(f=X(),f!==e?(E=me(),E!==e?(F=t,t=ar(E)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e),t}function uo(){var t,l,i,f,E;return t=r,l=n.substr(r,7),l.toLowerCase()===g?r+=7:(l=e,v===0&&$(rs)),l!==e?(i=r,v++,f=P(),v--,f===e?i=void 0:(r=i,i=e),i!==e?(f=X(),f!==e?(E=me(),E!==e?(F=t,t=ir(E)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e),t}function fo(){var t,l,i,f,E,j,_;return t=r,l=n.substr(r,6),l.toLowerCase()===d?r+=6:(l=e,v===0&&$(Bt)),l!==e?(i=r,v++,f=P(),v--,f===e?i=void 0:(r=i,i=e),i!==e?(f=X(),f!==e?(E=_e(),E!==e?(j=X(),j!==e?(_=me(),_!==e?(F=t,t=cr(E,_)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e),t}function po(){var t,l,i,f,E,j,_;return t=r,l=n.substr(r,7),l.toLowerCase()===h?r+=7:(l=e,v===0&&$(jt)),l!==e?(i=r,v++,f=P(),v--,f===e?i=void 0:(r=i,i=e),i!==e?(f=X(),f!==e?(E=_e(),E!==e?(j=X(),j!==e?(_=me(),_!==e?(F=t,t=dr(E,_)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e),t}function mo(){var t,l,i,f,E,j,_;return t=r,l=n.substr(r,6),l.toLowerCase()===u?r+=6:(l=e,v===0&&$(Tt)),l!==e?(i=r,v++,f=P(),v--,f===e?i=void 0:(r=i,i=e),i!==e?(f=X(),f!==e?(E=_e(),E!==e?(j=X(),j!==e?(_=me(),_!==e?(F=t,t=ur(E,_)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e),t}function ho(){var t,l,i,f,E;return t=r,l=n.substr(r,4),l.toLowerCase()===C?r+=4:(l=e,v===0&&$(os)),l!==e?(i=r,v++,f=P(),v--,f===e?i=void 0:(r=i,i=e),i!==e?(f=X(),f!==e?(E=Zt(),E!==e?(F=t,t=fr(E)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e),t}function go(){var t,l,i,f,E;return t=r,l=n.substr(r,4),l.toLowerCase()===w?r+=4:(l=e,v===0&&$(ls)),l!==e?(i=r,v++,f=P(),v--,f===e?i=void 0:(r=i,i=e),i!==e?(f=X(),f!==e?(E=Zt(),E!==e?(F=t,t=pr(E)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e),t}function bo(){var t,l,i,f,E;return t=r,l=n.substr(r,4),l.toLowerCase()===y?r+=4:(l=e,v===0&&$(as)),l!==e?(i=r,v++,f=P(),v--,f===e?i=void 0:(r=i,i=e),i!==e?(f=X(),f!==e?(E=Vt(),E!==e?(F=t,t=mr(E)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e),t}function vo(){var t,l,i,f,E;return t=r,l=n.substr(r,5),l.toLowerCase()===S?r+=5:(l=e,v===0&&$(is)),l!==e?(i=r,v++,f=P(),v--,f===e?i=void 0:(r=i,i=e),i!==e?(f=X(),f!==e?(E=Vt(),E!==e?(F=t,t=hr(E)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e),t}function Vt(){var t,l,i,f;return t=r,l=qo(),l!==e?(i=Y(),f=Oe(),f!==e?(F=t,t=gr(l,f)):(r=t,t=e)):(r=t,t=e),t===e&&(t=r,l=Oe(),l!==e?(n.charCodeAt(r)===45?(i=A,r++):(i=e,v===0&&$(It)),i!==e?(f=Oe(),f!==e?(F=t,t=br(l,f)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e),t===e&&(t=r,l=Oe(),l!==e&&(F=t,l=vr(l)),t=l)),t}function Co(){var t,l,i,f,E;return t=r,l=n.substr(r,5),l.toLowerCase()===B?r+=5:(l=e,v===0&&$(cs)),l!==e?(i=r,v++,f=P(),v--,f===e?i=void 0:(r=i,i=e),i!==e?(f=X(),f!==e?(E=Yt(),E!==e?(F=t,t=Cr(E)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e),t}function wo(){var t,l,i,f,E;return t=r,l=n.substr(r,4),l.toLowerCase()===O?r+=4:(l=e,v===0&&$(ds)),l!==e?(i=r,v++,f=P(),v--,f===e?i=void 0:(r=i,i=e),i!==e?(f=X(),f!==e?(E=Vo(),E!==e?(F=t,t=wr(E)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e),t}function yo(){var t,l,i,f,E;return t=r,n.substr(r,2)===M?(l=M,r+=2):(l=e,v===0&&$(us)),l!==e?(i=Yt(),i===e&&(i=null),n.charCodeAt(r)===47?(f=q,r++):(f=e,v===0&&$(et)),f!==e?(E=Eo(),E!==e?(F=t,t=yr(i,E)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e),t}function Eo(){var t,l,i,f;return t=r,l=So(),l!==e?(n.charCodeAt(r)===47?(i=q,r++):(i=e,v===0&&$(et)),i!==e?(f=Pe(),f===e&&(f=null),F=t,t=Er(l,f)):(r=t,t=e)):(r=t,t=e),t===e&&(t=r,n.charCodeAt(r)===47?(l=q,r++):(l=e,v===0&&$(et)),l!==e?(i=Pe(),i===e&&(i=null),F=t,t=Sr(i)):(r=t,t=e),t===e&&(t=r,l=Pe(),l!==e&&(F=t,l=$r(l)),t=l,t===e&&(t=r,l="",F=t,l=xr(),t=l))),t}function So(){var t,l,i;if(t=r,l=[],i=n.charAt(r),de.test(i)?r++:(i=e,v===0&&$(ue)),i!==e)for(;i!==e;)l.push(i),i=n.charAt(r),de.test(i)?r++:(i=e,v===0&&$(ue));else l=e;return l!==e&&(F=t,l=Fr(l)),t=l,t}function $o(){var t,l,i,f;return t=r,l=n.substr(r,7),l.toLowerCase()===J?r+=7:(l=e,v===0&&$(fs)),l!==e?(i=r,v++,f=P(),v--,f===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=Ar()):(r=t,t=e)):(r=t,t=e),t}function xo(){var t,l,i,f;return t=r,l=n.substr(r,6),l.toLowerCase()===K?r+=6:(l=e,v===0&&$(ps)),l!==e?(i=r,v++,f=P(),v--,f===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=Lr()):(r=t,t=e)):(r=t,t=e),t}function Fo(){var t,l,i,f;return t=r,l=n.substr(r,5),l.toLowerCase()===G?r+=5:(l=e,v===0&&$(ms)),l!==e?(i=r,v++,f=P(),v--,f===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=kr()):(r=t,t=e)):(r=t,t=e),t}function Ao(){var t,l,i,f;return t=r,l=n.substr(r,7),l.toLowerCase()===x?r+=7:(l=e,v===0&&$(hs)),l!==e?(i=r,v++,f=P(),v--,f===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=Nr()):(r=t,t=e)):(r=t,t=e),t}function Lo(){var t,l,i,f;return t=r,l=n.substr(r,7),l.toLowerCase()===I?r+=7:(l=e,v===0&&$(gs)),l!==e?(i=r,v++,f=P(),v--,f===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=Dr()):(r=t,t=e)):(r=t,t=e),t}function ko(){var t,l,i,f;return t=r,l=n.substr(r,8),l.toLowerCase()===R?r+=8:(l=e,v===0&&$(bs)),l===e&&(l=n.substr(r,2),l.toLowerCase()===U?r+=2:(l=e,v===0&&$(vs))),l!==e?(i=r,v++,f=P(),v--,f===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=Br()):(r=t,t=e)):(r=t,t=e),t}function No(){var t,l,i,f;return t=r,l=n.substr(r,9),l.toLowerCase()===Z?r+=9:(l=e,v===0&&$(Cs)),l===e&&(l=n.substr(r,2),l.toLowerCase()===pe?r+=2:(l=e,v===0&&$(ws))),l!==e?(i=r,v++,f=P(),v--,f===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=jr()):(r=t,t=e)):(r=t,t=e),t}function Do(){var t,l,i,f;return t=r,l=n.substr(r,6),l.toLowerCase()===ee?r+=6:(l=e,v===0&&$(ys)),l===e&&(l=n.substr(r,5),l.toLowerCase()===Nn?r+=5:(l=e,v===0&&$(Es))),l!==e?(i=r,v++,f=P(),v--,f===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=Tr()):(r=t,t=e)):(r=t,t=e),t}function Bo(){var t,l,i,f;return t=r,l=n.substr(r,17),l.toLowerCase()===Dn?r+=17:(l=e,v===0&&$(Ss)),l===e&&(l=n.substr(r,7),l.toLowerCase()===Bn?r+=7:(l=e,v===0&&$($s))),l!==e?(i=r,v++,f=P(),v--,f===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=Ir()):(r=t,t=e)):(r=t,t=e),t}function jo(){var t,l,i,f;return t=r,l=n.substr(r,14),l.toLowerCase()===jn?r+=14:(l=e,v===0&&$(xs)),l===e&&(l=n.substr(r,6),l.toLowerCase()===Tn?r+=6:(l=e,v===0&&$(Fs))),l!==e?(i=r,v++,f=P(),v--,f===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=Pr()):(r=t,t=e)):(r=t,t=e),t}function To(){var t,l,i,f;return t=r,l=n.substr(r,5),l.toLowerCase()===In?r+=5:(l=e,v===0&&$(As)),l!==e?(i=r,v++,f=P(),v--,f===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=Or()):(r=t,t=e)):(r=t,t=e),t}function Io(){var t,l,i,f;return t=r,l=n.substr(r,8),l.toLowerCase()===Pn?r+=8:(l=e,v===0&&$(Ls)),l===e&&(l=n.charAt(r),l.toLowerCase()===On?r++:(l=e,v===0&&$(ks))),l!==e?(i=r,v++,f=P(),v--,f===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=_r()):(r=t,t=e)):(r=t,t=e),t}function Po(){var t,l,i,f;return t=r,l=n.substr(r,5),l.toLowerCase()===_n?r+=5:(l=e,v===0&&$(Ns)),l!==e?(i=r,v++,f=P(),v--,f===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=Mr()):(r=t,t=e)):(r=t,t=e),t}function Oo(){var t,l,i,f;return t=r,l=n.substr(r,5),l.toLowerCase()===Mn?r+=5:(l=e,v===0&&$(Ds)),l!==e?(i=r,v++,f=P(),v--,f===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=Hr()):(r=t,t=e)):(r=t,t=e),t}function _o(){var t,l,i,f;return t=r,l=n.substr(r,4),l.toLowerCase()===Hn?r+=4:(l=e,v===0&&$(Bs)),l!==e?(i=r,v++,f=P(),v--,f===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=zr()):(r=t,t=e)):(r=t,t=e),t}function Mo(){var t,l,i,f;return t=r,l=n.substr(r,4),l.toLowerCase()===zn?r+=4:(l=e,v===0&&$(js)),l!==e?(i=r,v++,f=P(),v--,f===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=Rr()):(r=t,t=e)):(r=t,t=e),t}function Ho(){var t,l,i,f;return t=r,l=n.substr(r,3),l.toLowerCase()===Rn?r+=3:(l=e,v===0&&$(Ts)),l!==e?(i=r,v++,f=P(),v--,f===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=Ur()):(r=t,t=e)):(r=t,t=e),t}function zo(){var t,l,i,f;return t=r,l=n.substr(r,4),l.toLowerCase()===Un?r+=4:(l=e,v===0&&$(Is)),l!==e?(i=r,v++,f=P(),v--,f===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=qr()):(r=t,t=e)):(r=t,t=e),t}function Gt(){var t,l,i,f;return t=r,l=n.substr(r,3),l.toLowerCase()===qn?r+=3:(l=e,v===0&&$(Ps)),l!==e?(i=r,v++,f=P(),v--,f===e?i=void 0:(r=i,i=e),i!==e?(l=[l,i],t=l):(r=t,t=e)):(r=t,t=e),t}function Wt(){var t,l,i,f;return t=r,l=n.substr(r,2),l.toLowerCase()===Vn?r+=2:(l=e,v===0&&$(Os)),l!==e?(i=r,v++,f=P(),v--,f===e?i=void 0:(r=i,i=e),i!==e?(l=[l,i],t=l):(r=t,t=e)):(r=t,t=e),t}function Ro(){var t,l,i,f;return t=r,l=n.substr(r,3),l.toLowerCase()===Gn?r+=3:(l=e,v===0&&$(_s)),l!==e?(i=r,v++,f=P(),v--,f===e?i=void 0:(r=i,i=e),i!==e?(l=[l,i],t=l):(r=t,t=e)):(r=t,t=e),t}function Kt(){var t,l,i,f;return t=r,l=n.substr(r,3),l.toLowerCase()===Wn?r+=3:(l=e,v===0&&$(Ms)),l!==e?(i=r,v++,f=P(),v--,f===e?i=void 0:(r=i,i=e),i!==e?(l=[l,i],t=l):(r=t,t=e)):(r=t,t=e),t}function Zt(){var t,l,i,f,E,j;if(t=r,l=rt(),l!==e){for(i=[],f=r,n.charCodeAt(r)===43?(E=Ft,r++):(E=e,v===0&&$(Pt)),E!==e?(j=rt(),j!==e?(F=f,f=Ht(l,j)):(r=f,f=e)):(r=f,f=e);f!==e;)i.push(f),f=r,n.charCodeAt(r)===43?(E=Ft,r++):(E=e,v===0&&$(Pt)),E!==e?(j=rt(),j!==e?(F=f,f=Ht(l,j)):(r=f,f=e)):(r=f,f=e);F=t,t=Vr(l,i)}else r=t,t=e;return t}function rt(){var t;return t=Uo(),t===e&&(t=Pe()),t}function Uo(){var t,l,i,f;if(t=r,n.charCodeAt(r)===34?(l=At,r++):(l=e,v===0&&$(Ot)),l!==e){for(i=[],f=n.charAt(r),Nt.test(f)?r++:(f=e,v===0&&$(_t));f!==e;)i.push(f),f=n.charAt(r),Nt.test(f)?r++:(f=e,v===0&&$(_t));n.charCodeAt(r)===34?(f=At,r++):(f=e,v===0&&$(Ot)),f!==e?(F=t,t=Gr(i)):(r=t,t=e)}else r=t,t=e;return t}function Pe(){var t,l,i;if(t=r,l=[],i=n.charAt(r),Dt.test(i)?r++:(i=e,v===0&&$(Mt)),i!==e)for(;i!==e;)l.push(i),i=n.charAt(r),Dt.test(i)?r++:(i=e,v===0&&$(Mt));else l=e;return l!==e&&(F=t,l=Wr(l)),t=l,t}function qo(){var t,l;return t=r,n.substr(r,2)===Lt?(l=Lt,r+=2):(l=e,v===0&&$(Hs)),l!==e&&(F=t,l=Kr()),t=l,t===e&&(t=r,n.substr(r,2)===kt?(l=kt,r+=2):(l=e,v===0&&$(zs)),l!==e&&(F=t,l=Zr()),t=l,t===e&&(t=r,n.charCodeAt(r)===62?(l=Kn,r++):(l=e,v===0&&$(Rs)),l!==e&&(F=t,l=Yr()),t=l,t===e&&(t=r,n.charCodeAt(r)===60?(l=Zn,r++):(l=e,v===0&&$(Us)),l!==e&&(F=t,l=Xr()),t=l))),t}function Oe(){var t,l,i;if(t=r,l=[],i=n.charAt(r),de.test(i)?r++:(i=e,v===0&&$(ue)),i!==e)for(;i!==e;)l.push(i),i=n.charAt(r),de.test(i)?r++:(i=e,v===0&&$(ue));else l=e;return l!==e&&(F=t,l=Qr(l)),t=l,t}function _e(){var t,l,i,f,E,j,_;if(t=r,n.charCodeAt(r)===45?(l=A,r++):(l=e,v===0&&$(It)),l===e&&(l=null),i=[],f=n.charAt(r),de.test(f)?r++:(f=e,v===0&&$(ue)),f!==e)for(;f!==e;)i.push(f),f=n.charAt(r),de.test(f)?r++:(f=e,v===0&&$(ue));else i=e;if(i!==e){if(f=r,n.charCodeAt(r)===46?(E=Yn,r++):(E=e,v===0&&$(qs)),E!==e){for(j=[],_=n.charAt(r),de.test(_)?r++:(_=e,v===0&&$(ue));_!==e;)j.push(_),_=n.charAt(r),de.test(_)?r++:(_=e,v===0&&$(ue));F=f,f=Jr(l,i,j)}else r=f,f=e;f===e&&(f=null),F=t,t=eo(l,i,f)}else r=t,t=e;return t}function Yt(){var t,l;return t=r,l=n.charAt(r),Xn.test(l)?r++:(l=e,v===0&&$(Vs)),l!==e&&(F=t,l=to(l)),t=l,t}function Vo(){var t,l,i;return t=r,l=n.charAt(r),Qn.test(l)?r++:(l=e,v===0&&$(Gs)),l!==e?(i=n.charAt(r),Jn.test(i)?r++:(i=e,v===0&&$(Ws)),i===e&&(i=null),F=t,t=no(l,i)):(r=t,t=e),t}function P(){var t;return t=n.charAt(r),es.test(t)?r++:(t=e,v===0&&$(Ks)),t}function Y(){var t,l;for(v++,t=[],l=n.charAt(r),Be.test(l)?r++:(l=e,v===0&&$(je));l!==e;)t.push(l),l=n.charAt(r),Be.test(l)?r++:(l=e,v===0&&$(je));return v--,l=e,v===0&&$(Zs),t}function X(){var t,l;if(v++,t=[],l=n.charAt(r),Be.test(l)?r++:(l=e,v===0&&$(je)),l!==e)for(;l!==e;)t.push(l),l=n.charAt(r),Be.test(l)?r++:(l=e,v===0&&$(je));else t=e;return v--,t===e&&(l=e,v===0&&$(Ys)),t}if(Ee=c(),s.peg$library)return{peg$result:Ee,peg$currPos:r,peg$FAILED:e,peg$maxFailExpected:Te,peg$maxFailPos:le};if(Ee!==e&&r===n.length)return Ee;throw Ee!==e&&r<n.length&&$(ro()),lo(Te,le<n.length?n.charAt(le):null,le<n.length?tt(le,le+1):tt(le,le))}const Ce=new Set(["ALA","ARG","ASN","ASP","CYS","GLN","GLU","GLY","HIS","ILE","LEU","LYS","MET","PHE","PRO","SER","THR","TRP","TYR","VAL","MSE","SEC","PYL","ASX","GLX"]),Fe=new Set(["HOH","WAT","H2O","DOD","TIP","TIP3","SPC"]),Me=new Set([...Fe,"DMSO","DMF","ACN","MeOH","EtOH","IPA","GOL","PEG"]),tn=new Set(["N","CA","C","O"]),nn=new Set(["LI","BE","NA","MG","AL","K","CA","SC","TI","V","CR","MN","FE","CO","NI","CU","ZN","GA","RB","SR","Y","ZR","NB","MO","RU","RH","PD","AG","CD","IN","SN","CS","BA","LA","CE","PR","ND","SM","EU","GD","TB","DY","HO","ER","TM","YB","LU","HF","TA","W","RE","OS","IR","PT","AU","HG","TL","PB","BI"]);function Se(n,s){const e=n.x-s.x,o=n.y-s.y,a=n.z-s.z;return Math.sqrt(e*e+o*o+a*a)}function fl(n){const s=n.replace(/[.+^${}()|[\]\\]/g,"\\$&").replace(/\*/g,".*").replace(/\?/g,".");return new RegExp(`^${s}$`,"i")}function sn(n,s){for(const e of s)if(e.includes("*")||e.includes("?")){if(fl(e).test(n))return!0}else if(n.toUpperCase()===e.toUpperCase())return!0;return!1}function rn(n,s){switch(n.op){case"==":return s===n.value;case"range":return s>=n.low&&s<=n.high;case">=":return s>=n.value;case"<=":return s<=n.value;case">":return s>n.value;case"<":return s<n.value;default:return!1}}function re(n,s){switch(n.type){case"all":return[...s];case"none":return[];case"name":return s.filter(e=>sn(e.atom,n.values));case"resn":return s.filter(e=>sn(e.resn,n.values));case"resi":return s.filter(e=>rn(n,e.resi));case"chain":return s.filter(e=>e.chain===n.value);case"elem":return s.filter(e=>e.elem.toUpperCase()===n.value.toUpperCase());case"index":return s.filter(e=>rn(n,e.serial));case"and":{let e=[...s];for(const o of n.children){const a=new Set(re(o,s));e=e.filter(c=>a.has(c))}return e}case"or":{const e=new Set;for(const o of n.children)for(const a of re(o,s))e.has(a)||e.add(a);return s.filter(o=>e.has(o))}case"not":{const e=new Set(re(n.child,s));return s.filter(o=>!e.has(o))}case"xor":{const e=n.children.map(o=>new Set(re(o,s)));return s.filter(o=>e.reduce((c,d)=>c+(d.has(o)?1:0),0)===1)}case"protein":return s.filter(e=>Ce.has(e.resn));case"water":return s.filter(e=>Fe.has(e.resn));case"solvent":return s.filter(e=>Me.has(e.resn));case"backbone":return s.filter(e=>Ce.has(e.resn)&&tn.has(e.atom));case"sidechain":return s.filter(e=>Ce.has(e.resn)&&!tn.has(e.atom)&&e.atom!=="OXT");case"metal":return s.filter(e=>nn.has(e.elem.toUpperCase()));case"ligand":return s.filter(e=>!Ce.has(e.resn)&&!Fe.has(e.resn)&&!Me.has(e.resn)&&!nn.has(e.elem.toUpperCase()));case"organic":{const e=new Set;for(const o of s)!Ce.has(o.resn)&&!Fe.has(o.resn)&&!Me.has(o.resn)&&o.elem.toUpperCase()==="C"&&e.add(`${o.chain}:${o.resi}`);return s.filter(o=>!Ce.has(o.resn)&&!Fe.has(o.resn)&&!Me.has(o.resn)&&e.has(`${o.chain}:${o.resi}`))}case"hydrogen":return s.filter(e=>e.elem==="H");case"heavy":return s.filter(e=>e.elem!=="H");case"polar_hydrogen":{const e=s.filter(c=>c.elem==="H"),o=s.filter(c=>c.elem!=="H"),a=new Set(["N","O","S"]);return e.filter(c=>{let d=1/0,h=null;for(const u of o){const m=Se(c,u);m<d&&(d=m,h=u.elem)}return h&&a.has(h.toUpperCase())})}case"nonpolar_hydrogen":{const e=s.filter(a=>a.elem==="H"),o=s.filter(a=>a.elem!=="H");return e.filter(a=>{let c=1/0,d=null;for(const h of o){const u=Se(a,h);u<c&&(c=u,d=h.elem)}return d&&d.toUpperCase()==="C"})}case"helix":return s.filter(e=>e.ss==="h");case"sheet":return s.filter(e=>e.ss==="s");case"turn":return s.filter(e=>e.ss==="t");case"loop":return s.filter(e=>e.ss===""||e.ss==="c"||!e.ss);case"around":{const e=re(n.child,s),o=new Set(e),a=n.radius;return s.filter(c=>{if(o.has(c))return!0;for(const d of e)if(Se(c,d)<=a)return!0;return!1})}case"xaround":{const e=re(n.child,s),o=new Set(e),a=n.radius;return s.filter(c=>{if(o.has(c))return!1;for(const d of e)if(Se(c,d)<=a)return!0;return!1})}case"beyond":{const e=re(n.child,s),o=n.radius;return s.filter(a=>{for(const c of e)if(Se(a,c)<=o)return!1;return!0})}case"byres":{const e=re(n.child,s),o=new Set;for(const a of e)o.add(`${a.chain}:${a.resi}`);return s.filter(a=>o.has(`${a.chain}:${a.resi}`))}case"bychain":{const e=re(n.child,s),o=new Set;for(const a of e)o.add(a.chain);return s.filter(a=>o.has(a.chain))}default:throw new Error(`Unknown AST node type: ${n.type}`)}}function Ke(n){switch(n.type){case"name":return{atom:n.values};case"resn":return{resn:n.values};case"resi":return n.op==="=="?{resi:n.value}:null;case"chain":return{chain:n.value};case"elem":return{elem:n.value};case"all":return{};case"and":{const s={};for(const e of n.children){const o=Ke(e);if(o===null)return null;Object.assign(s,o)}return s}default:return null}}function ne(n){const s=(n||"").trim();if(s===""||s.toLowerCase()==="all")return{spec:{}};const e=k(),o=e.selections.get(s);if(o)return{spec:o.spec};const a=e.objects.get(s);if(a)return{spec:{model:a.model}};const c=[...e.selections.keys()].filter(g=>g.startsWith(s)),d=[...e.objects.keys()].filter(g=>g.startsWith(s)),h=[...c,...d];if(h.length===1){const g=h[0];return c.length===1?{spec:e.selections.get(g).spec}:{spec:{model:e.objects.get(g).model}}}if(h.length>1)throw new Error(`Ambiguous name "${s}": ${h.join(", ")}`);let u;try{u=ht(s)}catch(g){throw new Error(`Invalid selection "${s}": ${g.message}`)}const m=Ke(u);if(m){const g=Xt(m);if(!g||g.length===0)throw new Error(`No atoms match the selection "${s}"`);return{spec:m}}const p=Xt({});if(!p||p.length===0)throw new Error(`Selection "${s}" requires atom-level evaluation but no atoms are loaded`);const b=re(u,p);if(b.length===0)throw new Error(`No atoms match the selection "${s}"`);return{atoms:b}}function ae(n){return n.spec?n.spec:{serial:n.atoms.map(s=>s.serial)}}const $e={cartoon:"cartoon",stick:"stick",sticks:"stick",line:"line",lines:"line",sphere:"sphere",spheres:"sphere",surface:"surface",cross:"cross",crosses:"cross",ribbon:"ribbon",ribbons:"ribbon",everything:"everything"};function on(n){const s=n.toLowerCase(),e=$e[s];if(e)return e;const o=Object.keys($e).filter(a=>a.startsWith(s));if(o.length===1)return $e[o[0]];if(o.length>1){const a=[...new Set(o.map(c=>$e[c]))];throw new Error(`Ambiguous representation "${n}": ${a.join(", ")}`)}throw new Error(`Unknown representation "${n}". Valid: ${[...new Set(Object.values($e))].join(", ")}`)}function pl(n){n.register("show",{handler:(s,e)=>{const o=te(s);if(o.length===0)throw new Error("Usage: show <representation> [, selection]");const a=on(o[0]),c=o.slice(1).join(", ")||null,d=ne(c),h=ae(d),u=L(),m=k(),p=[];if(c){if(d.spec&&d.spec.model)for(const[,C]of m.objects)C.model===d.spec.model&&p.push(C)}else for(const[,C]of m.objects)p.push(C);const b=a==="line"&&p.some(C=>C.representations.has("stick")),g=a==="stick"&&p.some(C=>C.representations.has("line"));for(const C of p)C.representations.add(a);if(!b)if(g){u.setStyle(h,{});for(const[,C]of m.objects)if(C.visible)for(const w of C.representations)w==="line"&&C.representations.has("stick")||u.addStyle(h,W(w))}else u.addStyle(h,W(a));u.render(),Q(),e.terminal.print(`Showing ${a}${c?` for ${c}`:""}`,"result")},usage:"show <representation> [, selection]",help:"Show a representation (cartoon, stick, line, sphere, surface, cross, ribbon)."}),n.register("hide",{handler:(s,e)=>{const o=te(s);if(o.length===0)throw new Error("Usage: hide <representation> [, selection]");const a=o[0].trim(),c=on(a),d=o.slice(1).join(", ")||null,h=ne(d),u=ae(h),m=L(),p=k();if(c==="everything")if(m.setStyle(u,{}),d){if(h.spec&&h.spec.model)for(const[,b]of p.objects)b.model===h.spec.model&&b.representations.clear()}else for(const[,b]of p.objects)b.representations.clear();else if(m.setStyle(u,{}),d){if(h.spec&&h.spec.model){for(const[,b]of p.objects)if(b.model===h.spec.model&&b.representations.delete(c),b.visible)for(const g of b.representations)g==="line"&&b.representations.has("stick")||m.addStyle(u,W(g))}else for(const[,b]of p.objects)if(b.visible)for(const g of b.representations)g!==c&&(g==="line"&&b.representations.has("stick")||m.addStyle(u,W(g)))}else for(const[,b]of p.objects)if(b.representations.delete(c),b.visible)for(const g of b.representations)g==="line"&&b.representations.has("stick")||m.addStyle(u,W(g));m.render(),Q(),e.terminal.print(`Hiding ${a.toLowerCase()}${d?` for ${d}`:""}`,"result")},usage:"hide <representation> [, selection]",help:'Hide a representation. Use "hide everything" to clear all styles.'}),n.register("enable",{handler:(s,e)=>{const o=s.trim();if(!o)throw new Error("Usage: enable <object_name>");const c=k().objects.get(o);if(!c)throw new Error(`Object "${o}" not found`);c.model.show(),c.visible=!0,L().render(),Q(),e.terminal.print(`Enabled "${o}"`,"result")},usage:"enable <object_name>",help:"Show a hidden molecular object."}),n.register("disable",{handler:(s,e)=>{const o=s.trim();if(!o)throw new Error("Usage: disable <object_name>");const c=k().objects.get(o);if(!c)throw new Error(`Object "${o}" not found`);c.model.hide(),c.visible=!1,L().render(),Q(),e.terminal.print(`Disabled "${o}"`,"result")},usage:"disable <object_name>",help:"Hide a molecular object without removing it."})}const ln={red:"#FF0000",green:"#00FF00",blue:"#0000FF",yellow:"#FFFF00",cyan:"#00FFFF",magenta:"#FF00FF",orange:"#FFA500",white:"#FFFFFF",grey:"#808080",gray:"#808080",salmon:"#FA8072",lime:"#00FF00",pink:"#FFC0CB",purple:"#800080",turquoise:"#30D5C8",coral:"#FF7F50",teal:"#008080",sage:"#B2AC88",lavender:"#E6E6FA",mustard:"#FFDB58",aquamarine:"#7FFFD4",feijoa:"#A5D785",rose:"#FF007F",paleturquoise:"#AFEEEE",lightcoral:"#F08080",lightgreen:"#90EE90",lightyellow:"#FFFFE0",lightorange:"#FFA07A",lightpink:"#FFB6C1",robinsegg:"#00CCCC",cerulean:"#007BA7",periwinkle:"#CCCCFF",canary:"#FBF8CC",orangecream:"#FDE4CF",peach:"#FFCFD2",lightpurple:"#F1C0E8",purpleblue:"#A3C4F3",lightblue:"#8EECF5",marine:"#98F5E1",pastelgreen:"#B9FBC0",pastelblue:"#90DBF4",pastelpurple:"#CFBAF0"},Ze={};function He(n){const s=n.trim().toLowerCase();return Ze[s]?Ze[s]:ln[s]?ln[s]:s.startsWith("0x")?"#"+s.substring(2):s.startsWith("#")&&(s.length===4||s.length===7)?s:null}function ml(n){n.register("color",{handler:(s,e)=>{const o=te(s);if(o.length===0)throw new Error("Usage: color <color|scheme> [, selection]");const a=o[0].trim().toLowerCase(),c=o.slice(1).join(", ")||null,d=ne(c),h=ae(d),u=L();if(["element","elem","cpk","chain","ss","secondary_structure","spectrum","b","bfactor"].includes(a)){["element","elem","cpk"].includes(a)?u.setStyle(h,{cartoon:{colorscheme:"Jmol"},stick:{colorscheme:"Jmol"}}):a==="chain"?u.setStyle(h,{cartoon:{colorscheme:"chain"}}):["ss","secondary_structure"].includes(a)?u.setStyle(h,{cartoon:{colorscheme:"ssJmol"}}):["spectrum","b","bfactor"].includes(a)&&u.setStyle(h,{cartoon:{colorscheme:{prop:"b",gradient:"roygb"}}}),u.render(),e.terminal.print(`Colored by ${a}${c?` for ${c}`:""}`,"result");return}const p=He(o[0]);if(!p)throw new Error(`Unknown color "${o[0]}". Use a named color, hex (#RRGGBB), or a scheme (element, chain, ss, spectrum).`);const b=k(),g=new Set;for(const[,w]of b.objects)for(const y of w.representations)g.add(y);g.size===0&&g.add("line");const C={};for(const w of g)C[Ae(w)]={color:p};u.setStyle(h,C),u.render(),e.terminal.print(`Colored ${o[0]}${c?` for ${c}`:""}`,"result")},usage:"color <color|scheme> [, selection]",help:"Color atoms. Use named colors (red, green, blue...), hex (#FF0000), or schemes (element, chain, ss, spectrum)."}),n.register("set_color",{handler:(s,e)=>{const o=te(s);if(o.length<2)throw new Error("Usage: set_color <name>, [<r>, <g>, <b>] or set_color <name>, <hex>");const a=o[0].trim().toLowerCase();if(o.length===3)throw new Error("RGB format requires 3 values: set_color <name>, <r>, <g>, <b>");if(o.length===4){const c=parseInt(o[1],10),d=parseInt(o[2],10),h=parseInt(o[3],10);if(isNaN(c)||isNaN(d)||isNaN(h))throw new Error("RGB values must be numbers (0-255)");if(c<0||c>255||d<0||d>255||h<0||h>255)throw new Error("RGB values must be between 0 and 255");const u=`#${c.toString(16).padStart(2,"0")}${d.toString(16).padStart(2,"0")}${h.toString(16).padStart(2,"0")}`;Ze[a]=u,e.terminal.print(`Defined color "${a}" as ${u}`,"result")}else{const c=He(o[1]);if(!c)throw new Error(`Invalid color value: ${o[1]}`);Ze[a]=c,e.terminal.print(`Defined color "${a}" as ${c}`,"result")}},usage:"set_color <name>, <hex> | set_color <name>, <r>, <g>, <b>",help:"Define a custom named color."}),n.register("bg_color",{handler:(s,e)=>{const o=s.trim();if(!o)throw new Error("Usage: bg_color <color>");const a=He(o);if(!a)throw new Error(`Unknown color "${o}"`);const c=L();c.setBackgroundColor(a),c.render();const d=k();d.settings.bgColor=a,d.settings.userSetBgColor=!0,Q(),e.terminal.print(`Background color set to ${a}`,"result")},usage:"bg_color <color>",help:"Set the viewer background color."}),n.register("set",{handler:(s,e)=>{const o=te(s);if(o.length<2)throw new Error("Usage: set <setting>, <value>");const a=o[0].trim().toLowerCase(),c=o[1].trim(),d=L();switch(a){case"bg_color":{const h=He(c);if(!h)throw new Error(`Unknown color "${c}"`);d.setBackgroundColor(h);const u=k();u.settings.bgColor=h,u.settings.userSetBgColor=!0;break}case"stick_radius":{const h=parseFloat(c);if(isNaN(h))throw new Error("stick_radius must be a number");const u=k();u.settings.stickRadius=h;for(const[,m]of u.objects){if(!m.visible||!m.representations.has("stick"))continue;const p={model:m.model};d.setStyle(p,{});for(const b of m.representations){if(b==="line"&&m.representations.has("stick"))continue;const g=W(b);b==="stick"&&(g.stick=Object.assign({},g.stick,{radius:h})),d.addStyle(p,g)}}break}case"sphere_scale":{const h=parseFloat(c);if(isNaN(h))throw new Error("sphere_scale must be a number");const u=k();u.settings.sphereScale=h;for(const[,m]of u.objects){if(!m.visible||!m.representations.has("sphere"))continue;const p={model:m.model};d.setStyle(p,{});for(const b of m.representations){if(b==="line"&&m.representations.has("stick"))continue;const g=W(b);b==="sphere"&&(g.sphere=Object.assign({},g.sphere,{scale:h})),d.addStyle(p,g)}}break}case"label_size":{const h=parseInt(c,10);if(isNaN(h))throw new Error("label_size must be a number");const u=k();u.settings.labelSize=h;break}default:throw new Error(`Unknown setting "${a}". Valid: bg_color, stick_radius, sphere_scale, label_size`)}d.render(),Q(),e.terminal.print(`Set ${a} = ${c}`,"result")},usage:"set <setting>, <value>",help:"Change a viewer setting. Settings: bg_color, stick_radius, sphere_scale, label_size."}),n.register("cartoon_style",{handler:(s,e)=>{const o=te(s);if(o.length===0)throw new Error(`Usage: cartoon_style <style> [, entry]
Styles: default, rectangle, oval, trace, parabola, edged`);const a=o[0].trim().toLowerCase(),c=o.length>1?o[1].trim():null,d={default:"rectangle",rectangle:"rectangle",oval:"oval",trace:"trace",parabola:"parabola",edged:"edged"},h=d[a];if(!h)throw new Error(`Unknown cartoon style "${a}". Valid: ${Object.keys(d).join(", ")}`);const u=L(),m=k();let p=0;for(const[g,C]of m.objects){if(c&&g!==c||!C.visible||!C.representations.has("cartoon"))continue;const w={model:C.model};u.setStyle(w,{});for(const y of C.representations){if(y==="line"&&C.representations.has("stick"))continue;const S=W(y);y==="cartoon"&&(S.cartoon=Object.assign({},S.cartoon,{style:h})),u.addStyle(w,S)}p++}if(c&&p===0)throw new Error(`Object "${c}" not found or has no cartoon representation`);u.render();const b=c||"all objects";e.terminal.print(`Set cartoon style to ${h} for ${b}`,"result")},usage:"cartoon_style <style> [, entry]",help:"Set cartoon rendering style. Styles: default, rectangle, oval, trace, parabola, edged."}),n.register("bfactor_spectrum",{handler:(s,e)=>{const o=te(s);if(o.length<2)throw new Error("Usage: bfactor_spectrum <min>, <max>");const a=parseFloat(o[0]),c=parseFloat(o[1]);if(isNaN(a)||isNaN(c))throw new Error("min and max must be numbers");if(a>=c)throw new Error("min must be less than max");const d=k();d.settings.bfactorMin=a,d.settings.bfactorMax=c;const h=L(),u=wn(a,c);for(const[,m]of d.objects){if(!m.visible)continue;const p={model:m.model},b=m.representations.size>0?m.representations:new Set(["line"]),g={};for(const C of b)g[Ae(C)]={colorfunc:u};h.setStyle(p,g)}h.render(),Q(),e.terminal.print(`B-factor spectrum set to ${a}–${c} (pastel blue → pastel red)`,"result")},usage:"bfactor_spectrum <min>, <max>",help:"Set B-factor coloring range and apply. Values below min are pastel blue, above max are pastel red."})}function hl(n){n.register("zoom",{handler:(s,e)=>{const o=L();if(s.trim()){const a=ne(s.trim()),c=ae(a);o.zoomTo(c)}else o.zoomTo();o.render(),e.terminal.print("Zoomed to selection","result")},usage:"zoom [selection]",help:"Zoom to fit the selection (or all atoms if none specified)."}),n.register("center",{handler:(s,e)=>{const o=L();if(s.trim()){const a=ne(s.trim()),c=ae(a);o.center(c)}else o.center();o.render(),e.terminal.print("Centered on selection","result")},usage:"center [selection]",help:"Center the view on the selection."}),n.register("orient",{handler:(s,e)=>{if(s.trim()){const o=ne(s.trim()),a=ae(o);we(a)}else we();e.terminal.print("Oriented to selection","result")},usage:"orient [selection]",help:"Align the longest dimension of the molecule with the x-axis, second-longest with y, shortest with z, then zoom to fit."}),n.register("rotate",{handler:(s,e)=>{const o=te(s);if(o.length<2)throw new Error("Usage: rotate <axis>, <angle>");const a=o[0].trim().toLowerCase();if(!["x","y","z"].includes(a))throw new Error("Axis must be x, y, or z");const c=parseFloat(o[1]);if(isNaN(c))throw new Error("Angle must be a number");const d=L();d.rotate(c,a),d.render(),e.terminal.print(`Rotated ${c}° around ${a} axis`,"result")},usage:"rotate <axis>, <angle>",help:"Rotate the view. Axis: x, y, or z. Angle in degrees."}),n.register("translate",{handler:(s,e)=>{const o=te(s);if(o.length<2)throw new Error("Usage: translate <x>, <y>");const a=parseFloat(o[0]),c=parseFloat(o[1]);if(isNaN(a)||isNaN(c))throw new Error("x and y must be numbers");const d=L();d.translate(a,c),d.render(),e.terminal.print(`Translated by (${a}, ${c})`,"result")},usage:"translate <x>, <y>",help:"Translate the view by x, y pixels."}),n.register("clip",{handler:(s,e)=>{const o=te(s);if(o.length<2)throw new Error("Usage: clip <near>, <far>");const a=parseFloat(o[0]),c=parseFloat(o[1]);if(isNaN(a)||isNaN(c))throw new Error("near and far must be numbers");const d=L();d.setSlab(a,c),d.render(),e.terminal.print(`Clipping planes set: near=${a}, far=${c}`,"result")},usage:"clip <near>, <far>",help:"Set clipping planes (near and far distances)."}),n.register("reset",{handler:(s,e)=>{const o=L();o.zoomTo(),o.render(),e.terminal.print("View reset","result")},usage:"reset",help:"Reset the view to show all atoms."})}function gl(n){n.register("sele",{handler:(s,e)=>{const o=s.trim();if(!o)throw new Error("Usage: sele <expression>");let a;try{a=ht(o)}catch(u){throw new Error(`Invalid selection expression: ${u.message}`)}const c=Ke(a);let d,h;if(c){const u=L().selectedAtoms(c);d=c,h=u.length}else{const u=L().selectedAtoms({}),m=re(a,u);d={serial:m.map(p=>p.serial)},h=m.length}De("sele",o,d,h),e.terminal.print(`(sele): ${h} atoms`,"result")},usage:"sele <expression>",help:'Create or overwrite the anonymous "sele" selection.'}),n.register("select",{handler:(s,e)=>{const o=te(s);if(o.length<2)throw new Error("Usage: select <name>, <expression>");const a=o[0].trim(),c=o.slice(1).join(", ").trim();let d;try{d=ht(c)}catch(p){throw new Error(`Invalid selection expression: ${p.message}`)}const h=Ke(d);let u,m;if(h){const p=L().selectedAtoms(h);u=h,m=p.length}else{const p=L().selectedAtoms({}),b=re(d,p);u={serial:b.map(g=>g.serial)},m=b.length}De(a,c,u,m),e.terminal.print(`Selection "${a}" defined: ${m} atoms`,"result")},usage:"select <name>, <expression>",help:"Define a named selection for use in other commands."}),n.register("count_atoms",{handler:(s,e)=>{const o=s.trim()||"all",a=ne(o);let c;a.spec?c=L().selectedAtoms(a.spec).length:c=a.atoms.length,e.terminal.print(`Count: ${c} atoms`,"result")},usage:"count_atoms [selection]",help:"Count the number of atoms matching the selection."}),n.register("get_model",{handler:(s,e)=>{const o=s.trim()||"all",a=ne(o);let c;a.spec?c=L().selectedAtoms(a.spec):c=a.atoms;const d=new Set(c.map(p=>p.chain)),h=new Set(c.map(p=>`${p.chain}:${p.resi}`)),u=new Set,m=k();for(const[p,b]of m.objects){const g=L().selectedAtoms({model:b.model}),C=new Set(g.map(w=>w.serial));c.some(w=>C.has(w.serial))&&u.add(p)}e.terminal.print(`Atoms: ${c.length}`,"result"),e.terminal.print(`Residues: ${h.size}`,"result"),e.terminal.print(`Chains: ${d.size} (${[...d].join(", ")})`,"result"),e.terminal.print(`Objects: ${u.size} (${[...u].join(", ")})`,"result")},usage:"get_model [selection]",help:"Print summary info about the selection: atoms, residues, chains, objects."})}const an=["name","atom","resn","resi","chain","elem","index"],bl={name:"atom",atom:"atom",resn:"resn",resi:"resi",chain:"chain",elem:"elem",index:"serial"};function vl(n){n.register("label",{handler:(s,e)=>{const o=te(s);if(o.length<2)throw new Error("Usage: label <selection>, <property>");const a=o.slice(0,-1).join(", ").trim(),c=o[o.length-1].trim().toLowerCase();if(!an.includes(c))throw new Error(`Unknown label property "${c}". Valid: ${an.join(", ")}`);const d=ne(a),h=L();let u;d.spec?u=h.selectedAtoms(d.spec):u=d.atoms;const m=bl[c];["resn","resi","chain"].includes(c)&&(u=u.filter(p=>p.atom==="CA"));for(const p of u)fn(String(p[m]),{x:p.x,y:p.y,z:p.z});h.render(),e.terminal.print(`Added ${u.length} labels (${c})`,"result")},usage:"label <selection>, <property>",help:"Add labels to atoms. Properties: name, resn, resi, chain, elem, index."}),n.register("unlabel",{handler:(s,e)=>{pn(),L().render(),e.terminal.print("All labels removed","result")},usage:"unlabel",help:"Remove all labels from the viewer."})}function Cl(n){n.register("remove",{handler:(s,e)=>{const o=s.trim();if(!o)throw new Error("Usage: remove <selection>");const a=ne(o),c=ae(a),d=L();let h;if(a.spec?h=d.selectedAtoms(a.spec):h=a.atoms,h.length===0){e.terminal.print("No atoms match the selection","info");return}d.setStyle(c,{}),d.render();const u=h.map(m=>m.index);mt(u),be(),k().activeSelection&&ye(k().activeSelection),e.terminal.print(`Removed ${h.length} atoms`,"result")},usage:"remove <selection>",help:"Remove atoms matching the selection from the viewer."}),n.register("delete",{handler:(s,e)=>{const o=s.trim();if(!o)throw new Error("Usage: delete <name>");const a=k();if(a.selections.has(o)){yt(o),e.terminal.print(`Deleted selection "(${o})"`,"result");return}const c=a.objects.get(o);if(!c)throw new Error(`"${o}" not found`);const d=L(),u=d.selectedAtoms({model:c.model}).map(m=>m.index);d.removeModel(c.model),d.render(),yn(o),mt(u),be(),k().activeSelection&&ye(k().activeSelection),e.terminal.print(`Deleted object "${o}"`,"result")},usage:"delete <name>",help:"Delete a molecular object or named selection."}),n.register("set_name",{handler:(s,e)=>{const o=te(s);if(o.length<2)throw new Error("Usage: set_name <old_name>, <new_name>");const a=o[0].trim(),c=o[1].trim(),d=k();if(d.selections.has(a))En(a,c),e.terminal.print(`Renamed selection "(${a})" to "(${c})"`,"result");else if(d.objects.has(a))Sn(a,c),e.terminal.print(`Renamed "${a}" to "${c}"`,"result");else throw new Error(`"${a}" not found`)},usage:"set_name <old_name>, <new_name>",help:"Rename a molecular object or named selection."})}function wl(n){n.register("png",{handler:(s,e)=>{const o=s.trim()||"screenshot",c=L().pngURI(),d=document.createElement("a");d.href=c,d.download=o.endsWith(".png")?o:`${o}.png`,d.click(),e.terminal.print(`Screenshot saved as "${d.download}"`,"result")},usage:"png [filename]",help:"Export the current view as a PNG image."}),n.register("help",{handler:(s,e)=>{const o=s.trim().toLowerCase();if(o){const a=n.getHelp(o);if(!a)throw new Error(`Unknown command "${o}". Type "help" for a list.`);e.terminal.print(`Usage: ${a.usage}`,"info"),e.terminal.print(a.help,"info")}else{e.terminal.print("Available commands:","info");const a=n.list();for(const c of a){const d=n.getHelp(c);e.terminal.print(`  ${d.usage}`,"info")}e.terminal.print("","info"),e.terminal.print('Type "help <command>" for details.',"info")}},usage:"help [command]",help:"Show available commands or help for a specific command."})}const it=["HOH","WAT","H2O"];function ct(n,s,e){const o=ke.pastel.colors,a=n.selectedAtoms(s),c=[...new Set(a.map(u=>u.chain))].sort(),d=Object.assign({},s,{not:{elem:"C"}}),h={};for(const u of e)h[u]={colorscheme:"Jmol"};n.addStyle(d,h),c.forEach((u,m)=>{const p=o[m%o.length],b=Object.assign({},s,{elem:"C",chain:u}),g={};for(const C of e)g[C]={color:p};n.addStyle(b,g)})}function xe(n,s){return Object.assign({},n,s)}const Ye={simple:{label:"Simple",description:"Element-colored cartoon with per-chain carbons, sticks for ligands",apply(n,s){return n.setStyle(s,{}),n.addStyle(xe(s,{hetflag:!0,not:{resn:it}}),{stick:{colorscheme:"Jmol"}}),ct(n,xe(s,{hetflag:!1}),["cartoon"]),n.render(),new Set(["cartoon","stick"])}},sites:{label:"Sites",description:"Element-colored cartoon with per-chain carbons + sticks near ligands",apply(n,s){n.setStyle(s,{});const e=xe(s,{hetflag:!0,not:{resn:it}});n.addStyle(e,{stick:{colorscheme:"Jmol"}});const o=xe(s,{hetflag:!1});ct(n,o,["cartoon"]);const a=n.selectedAtoms(e);if(a.length>0){const d=n.selectedAtoms(s||{}),h=new Set;for(const u of d)if(!u.hetflag)for(const m of a){const p=u.x-m.x,b=u.y-m.y,g=u.z-m.z;if(p*p+b*b+g*g<=25){h.add(`${u.chain}:${u.resi}`);break}}if(h.size>0){const u=[];for(const m of d)h.has(`${m.chain}:${m.resi}`)&&u.push(m.index);u.length>0&&ct(n,{index:u},["stick"])}}return n.render(),new Set(["cartoon","stick"])}},"ball-and-stick":{label:"Ball-and-Stick",description:"Ball-and-stick for ligands only",apply(n,s){n.setStyle(s,{});const e=xe(s,{hetflag:!0,not:{resn:it}});return n.addStyle(e,W("stick")),n.addStyle(e,{sphere:{scale:.3}}),n.render(),new Set(["stick","sphere"])}}},yl=["simple","sites","ball-and-stick"];function Et(n,s,e){const o=n.toLowerCase(),a=Ye[o];if(!a){const c=yl.map(d=>Ye[d].label).join(", ");throw new Error(`Unknown preset "${n}". Available: ${c}`)}return a.apply(s,e||{})}function El(n){n.register("preset",{handler:(s,e)=>{const o=te(s);if(o.length===0)throw new Error(`Usage: preset <style> [, selection]
Styles: Simple, Sites, Ball-and-Stick`);const a=o[0].trim(),c=o.slice(1).join(", ")||null;let d={};if(c){const b=ne(c);d=ae(b)}const h=L(),u=Et(a,h,d),m=k();if(!c)for(const[,b]of m.objects)b.representations=new Set(u);Q();const p=Ye[a.toLowerCase()].label;e.terminal.print(`Applied preset "${p}"${c?` to ${c}`:""}`,"result")},usage:"preset <style> [, selection]",help:"Apply a preset view. Styles: Simple, Sites, Ball-and-Stick."})}function Sl(n){dl(n),pl(n),ml(n),hl(n),gl(n),vl(n),Cl(n),wl(n),El(n)}function $l(n){const s=document.createElement("div");s.className="modal-overlay";const e=document.createElement("div");e.className="modal";const o=document.createElement("div");o.className="modal-header";const a=document.createElement("span");a.textContent="Load Structure";const c=document.createElement("button");c.className="modal-close",c.textContent="×",c.addEventListener("click",()=>s.remove()),o.appendChild(a),o.appendChild(c),e.appendChild(o);const d=document.createElement("div");d.className="modal-tabs";const h=document.createElement("button");h.className="modal-tab active",h.textContent="Fetch PDB";const u=document.createElement("button");u.className="modal-tab",u.textContent="Local File",d.appendChild(h),d.appendChild(u),e.appendChild(d);const m=document.createElement("div");m.className="modal-body";const p=document.createElement("div");p.className="modal-panel";const b=document.createElement("input");b.type="text",b.className="modal-input",b.placeholder="Enter PDB ID (e.g. 1UBQ)",b.maxLength=4;const g=document.createElement("button");g.className="modal-btn",g.textContent="Fetch",g.addEventListener("click",()=>{const S=b.value.trim().toUpperCase();S.length===4&&(n.onFetch(S),s.remove())}),b.addEventListener("keydown",S=>{S.key==="Enter"&&g.click()}),p.appendChild(b),p.appendChild(g),m.appendChild(p);const C=document.createElement("div");C.className="modal-panel hidden";const w=document.createElement("input");w.type="file",w.accept=".pdb,.sdf,.mol2,.xyz,.cube,.pqr,.gro,.cif,.mmcif";const y=document.createElement("button");y.className="modal-btn",y.textContent="Load",y.addEventListener("click",()=>{const S=w.files[0];if(!S)return;const A=S.name.split(".").pop().toLowerCase(),B=new FileReader;B.onload=O=>{n.onLoad(O.target.result,A,S.name),s.remove()},B.readAsText(S)}),C.appendChild(w),C.appendChild(y),m.appendChild(C),e.appendChild(m),h.addEventListener("click",()=>{h.classList.add("active"),u.classList.remove("active"),p.classList.remove("hidden"),C.classList.add("hidden")}),u.addEventListener("click",()=>{u.classList.add("active"),h.classList.remove("active"),C.classList.remove("hidden"),p.classList.add("hidden")}),s.appendChild(e),s.addEventListener("click",S=>{S.target===s&&s.remove()}),document.body.appendChild(s),b.focus()}function xl(n){const s=document.createElement("div");s.className="modal-overlay";const e=document.createElement("div");e.className="modal";const o=document.createElement("div");o.className="modal-header";const a=document.createElement("span");a.textContent="Export";const c=document.createElement("button");c.className="modal-close",c.textContent="×",c.addEventListener("click",()=>s.remove()),o.appendChild(a),o.appendChild(c),e.appendChild(o);const d=document.createElement("div");d.className="modal-body";const h=document.createElement("div");h.textContent="Export Image",h.style.marginBottom="8px",h.style.fontWeight="bold",d.appendChild(h);const u=document.createElement("div");u.style.display="flex",u.style.gap="8px",u.style.alignItems="center",u.style.marginBottom="12px";const m=L(),p=m&&m.getCanvas?m.getCanvas():null,b=p?p.width:800,g=p?p.height:600,C=document.createElement("input");C.type="number",C.className="modal-input",C.value=b,C.style.width="80px";const w=document.createElement("span");w.textContent=" × ";const y=document.createElement("input");y.type="number",y.className="modal-input",y.value=g,y.style.width="80px",u.appendChild(C),u.appendChild(w),u.appendChild(y),d.appendChild(u);const S=document.createElement("button");S.className="modal-btn",S.textContent="Export PNG",S.addEventListener("click",()=>{const A=parseInt(C.value,10)||b,B=parseInt(y.value,10)||g;n.onExportPNG(A,B),s.remove()}),d.appendChild(S),e.appendChild(d),s.appendChild(e),s.addEventListener("click",A=>{A.target===s&&s.remove()}),document.body.appendChild(s)}function Fl(n){const s=[{cmd:"fetch 1CRN",desc:"Download a structure from the PDB"},{cmd:"show cartoon",desc:"Display as cartoon ribbon"},{cmd:"color chain",desc:"Color by chain assignment"},{cmd:"zoom",desc:"Zoom to fit the molecule"},{cmd:"help",desc:"List all available commands"}],e=document.createElement("div");e.className="quickstart-overlay";const o=document.createElement("div");o.className="quickstart-card";const a=document.createElement("div");a.className="quickstart-title",a.textContent="3Dmol.js GUI";const c=document.createElement("div");c.className="quickstart-subtitle",c.textContent="An interface for molecular visualization";const d=document.createElement("div");d.className="quickstart-commands";for(const{cmd:b,desc:g}of s){const C=document.createElement("div");C.className="quickstart-cmd-row";const w=document.createElement("span");w.className="quickstart-cmd",w.textContent=b;const y=document.createElement("span");y.className="quickstart-cmd-desc",y.textContent=g,C.appendChild(w),C.appendChild(y),d.appendChild(C)}const h=document.createElement("div");h.className="quickstart-actions";const u=document.createElement("button");u.className="quickstart-try-btn",u.textContent="Try it!";const m=document.createElement("button");m.className="quickstart-dismiss",m.textContent="Dismiss",h.appendChild(u),h.appendChild(m),o.appendChild(a),o.appendChild(c),o.appendChild(d),o.appendChild(h),e.appendChild(o),document.body.appendChild(e);function p(){e.parentNode&&e.remove()}return u.addEventListener("click",()=>{p(),n.onTry&&n.onTry()}),m.addEventListener("click",()=>{p()}),p}function cn(n,s){const e=document.createElement("div");e.className="modal-overlay";const o=document.createElement("div");o.className="modal";const a=document.createElement("div");a.className="modal-header";const c=document.createElement("span");c.textContent="Rename";const d=document.createElement("button");d.className="modal-close",d.textContent="×",d.addEventListener("click",()=>e.remove()),a.appendChild(c),a.appendChild(d),o.appendChild(a);const h=document.createElement("div");h.className="modal-body";const u=document.createElement("input");u.type="text",u.className="modal-input",u.value=n,u.addEventListener("keydown",p=>{p.key==="Enter"&&m.click()}),h.appendChild(u);const m=document.createElement("button");m.className="modal-btn",m.textContent="Rename",m.addEventListener("click",()=>{const p=u.value.trim();p&&p!==n&&s(p),e.remove()}),h.appendChild(m),o.appendChild(h),e.appendChild(o),e.addEventListener("click",p=>{p.target===e&&e.remove()}),document.body.appendChild(e),u.select(),u.focus()}const Al={Action:{callbackKey:"onAction",items:[{label:"Center",value:"center"},{label:"Zoom",value:"zoom"}]},Show:{callbackKey:"onShow",items:[{label:"Cartoon",value:"cartoon"},{label:"Sticks",value:"stick"},{label:"Lines",value:"line"},{label:"Spheres",value:"sphere"},{label:"Surface",value:"surface"},{label:"Cross",value:"cross"},{separator:!0},{label:"Simple",value:"view:simple"},{label:"Sites",value:"view:sites"},{label:"Ball-and-Stick",value:"view:ball-and-stick"}]},Hide:{callbackKey:"onHide",items:[{label:"Everything",value:"everything"},{separator:!0},{label:"Cartoon",value:"cartoon"},{label:"Sticks",value:"stick"},{label:"Lines",value:"line"},{label:"Spheres",value:"sphere"},{label:"Surface",value:"surface"},{label:"Cross",value:"cross"}]},Label:{callbackKey:"onLabel",items:[{label:"Atom Name",value:"atom"},{label:"Residue Name",value:"resn"},{label:"Chain ID",value:"chain"},{label:"Element",value:"elem"},{label:"Index",value:"index"},{separator:!0},{label:"Clear",value:"clear"}]},Color:{callbackKey:"onColor",items:[{label:"Solid",value:"solid",submenu:"solid-swatches"},{label:"By Element",value:"element",submenu:"element-swatches"},{label:"By Chain",value:"chain",submenu:"chain-palettes"},{label:"By SS",value:"ss",submenu:"ss-palettes"},{label:"By B-Factor",value:"bfactor"}]}};let qe=null;function ie(){qe&&(qe.remove(),qe=null)}function Ll(n,s){let a=null,c=0;n.addEventListener("mousedown",u=>{u.button===2&&(a={x:u.clientX,y:u.clientY},c=Date.now())}),n.addEventListener("contextmenu",u=>{u.preventDefault()}),n.addEventListener("mouseup",u=>{if(u.button!==2||!a)return;const m=Math.abs(u.clientX-a.x),p=Math.abs(u.clientY-a.y),b=Date.now()-c;if(a=null,m>4||p>4||b>300)return;ie();const g=s.hasSelection(),C=kl(g,s);document.body.appendChild(C),qe=C;const w=C.getBoundingClientRect();let y=u.clientY,S=u.clientX;y+w.height>window.innerHeight&&(y=window.innerHeight-w.height),S+w.width>window.innerWidth&&(S=window.innerWidth-w.width),y<0&&(y=0),S<0&&(S=0),C.style.top=`${y+window.scrollY}px`,C.style.left=`${S+window.scrollX}px`,requestAnimationFrame(()=>{document.addEventListener("click",d,!0),document.addEventListener("contextmenu",h,!0)})});function d(){ie(),document.removeEventListener("click",d,!0),document.removeEventListener("contextmenu",h,!0)}function h(){ie(),document.removeEventListener("click",d,!0),document.removeEventListener("contextmenu",h,!0)}document.addEventListener("keydown",u=>{u.key==="Escape"&&ie()})}function kl(n,s){const e=document.createElement("div");e.className="context-menu";for(const[o,a]of Object.entries(Al)){const c=document.createElement("div");c.className="context-menu-item",n||c.classList.add("disabled");const d=document.createElement("span");d.textContent=o,c.appendChild(d);const h=document.createElement("span");h.className="context-menu-arrow",h.textContent="▶",c.appendChild(h);const u=document.createElement("div");u.className="context-menu-submenu";for(const m of a.items)if(m.separator){const p=document.createElement("div");p.className="context-menu-separator",u.appendChild(p)}else if(m.submenu==="element-swatches"){const p=document.createElement("div");p.className="context-menu-submenu-item context-menu-has-submenu";const b=document.createElement("span");b.textContent=m.label,p.appendChild(b);const g=document.createElement("span");g.className="context-menu-arrow",g.textContent="▶",p.appendChild(g);const C=document.createElement("div");C.className="context-menu-submenu";const w=document.createElement("div");w.className="context-menu-submenu-item",w.textContent="Standard",w.addEventListener("click",A=>{A.stopPropagation(),ie(),n&&s[a.callbackKey]&&s[a.callbackKey](m.value)}),C.appendChild(w);const y=document.createElement("div");y.className="context-menu-separator",C.appendChild(y);const S=document.createElement("div");S.className="swatch-grid";for(const A of vn){const B=document.createElement("div");B.className="swatch-cell",B.style.backgroundColor=A.hex,B.title=`${A.label} (${A.hex})`,B.addEventListener("click",O=>{O.stopPropagation(),ie(),n&&s[a.callbackKey]&&s[a.callbackKey](m.value+":"+A.hex)}),S.appendChild(B)}C.appendChild(S),p.appendChild(C),u.appendChild(p)}else if(m.submenu==="solid-swatches"){const p=document.createElement("div");p.className="context-menu-submenu-item context-menu-has-submenu";const b=document.createElement("span");b.textContent=m.label,p.appendChild(b);const g=document.createElement("span");g.className="context-menu-arrow",g.textContent="▶",p.appendChild(g);const C=document.createElement("div");C.className="context-menu-submenu";const w=document.createElement("div");w.className="swatch-grid";for(const y of Cn){const S=document.createElement("div");S.className="swatch-cell",S.style.backgroundColor=y.hex,S.title=`${y.label} (${y.hex})`,S.addEventListener("click",A=>{A.stopPropagation(),ie(),n&&s[a.callbackKey]&&s[a.callbackKey](y.hex)}),w.appendChild(S)}C.appendChild(w),p.appendChild(C),u.appendChild(p)}else if(m.submenu==="chain-palettes"){const p=document.createElement("div");p.className="context-menu-submenu-item context-menu-has-submenu";const b=document.createElement("span");b.textContent=m.label,p.appendChild(b);const g=document.createElement("span");g.className="context-menu-arrow",g.textContent="▶",p.appendChild(g);const C=document.createElement("div");C.className="context-menu-submenu";for(const[w,y]of Object.entries(ke)){const S=document.createElement("div");S.className="context-menu-submenu-item",S.textContent=y.label,S.addEventListener("click",A=>{A.stopPropagation(),ie(),n&&s[a.callbackKey]&&s[a.callbackKey]("chain:"+w)}),C.appendChild(S)}p.appendChild(C),u.appendChild(p)}else if(m.submenu==="ss-palettes"){const p=document.createElement("div");p.className="context-menu-submenu-item context-menu-has-submenu";const b=document.createElement("span");b.textContent=m.label,p.appendChild(b);const g=document.createElement("span");g.className="context-menu-arrow",g.textContent="▶",p.appendChild(g);const C=document.createElement("div");C.className="context-menu-submenu";for(const w of wt){const y=document.createElement("div");y.className="context-menu-submenu-item ss-palette-item";const S=document.createElement("span");S.textContent="Helix",S.style.color=w.helix,y.appendChild(S),y.appendChild(document.createTextNode(" – "));const A=document.createElement("span");A.textContent="Sheet",A.style.color=w.sheet,y.appendChild(A),y.appendChild(document.createTextNode(" – "));const B=document.createElement("span");B.textContent="Loop",B.style.color=w.loop,y.appendChild(B),y.addEventListener("click",O=>{O.stopPropagation(),ie(),n&&s[a.callbackKey]&&s[a.callbackKey]("ss:"+w.key)}),C.appendChild(y)}p.appendChild(C),u.appendChild(p)}else{const p=document.createElement("div");p.className="context-menu-submenu-item",p.textContent=m.label,p.addEventListener("click",b=>{b.stopPropagation(),ie(),n&&(m.value.startsWith("view:")&&s.onView?s.onView(m.value.slice(5)):s[a.callbackKey]&&s[a.callbackKey](m.value))}),u.appendChild(p)}c.appendChild(u),e.appendChild(c)}return e}const Nl={red:"#FF0000",green:"#00FF00",blue:"#0000FF",yellow:"#FFFF00",cyan:"#00FFFF",magenta:"#FF00FF",orange:"#FFA500",white:"#FFFFFF",grey:"#808080"};function St(n){let s=n,e=null,o=null,a=null;return s.startsWith("element:")?(e=s.slice(8),s="element"):s.startsWith("chain:")?(o=s.slice(6),s="chain"):s.startsWith("ss:")&&(a=s.slice(3),s="ss"),{scheme:s,carbonHex:e,chainPalette:o,ssPalette:a}}function gt(n){const{scheme:s,carbonHex:e,chainPalette:o,ssPalette:a}=St(n);return e?`element (C=${e})`:o?`chain (${o})`:a?`ss (${a})`:s}function $n(n,s,e,o){const a=k(),c=a.settings.bfactorMin??Jt.min,d=a.settings.bfactorMax??Jt.max,h={element:"Jmol",chain:"chain",ss:"ssJmol",bfactor:wn(c,d)};let u=null;if(s&&ke[s]){const m=ke[s].colors,p=L().selectedAtoms(o),b=[...new Set(p.map(C=>C.chain))].sort(),g={};b.forEach((C,w)=>{g[C]=m[w%m.length]}),u={prop:"chain",map:g}}if(e){const m=wt.find(p=>p.key===e);m&&m.key!=="default"&&(u={prop:"ss",map:{h:m.helix,s:m.sheet,c:m.loop,"":m.loop}})}return{schemes:h,customScheme:u}}function xn(n,s,e,o,a,c,d){if(a[o]){const h=c||a[o],u={};for(const m of e){const p=Ae(m);o==="bfactor"?u[p]={colorfunc:h}:u[p]={colorscheme:h}}if(n.setStyle(s,u),d){const m=Object.assign({},s,{elem:"C"}),p={};for(const b of e)p[Ae(b)]={color:d};n.setStyle(m,p)}}else{const h=Nl[o]||o,u={};for(const m of e)u[Ae(m)]={color:h};n.setStyle(s,u)}}function Dl(n,s,e){const o=L(),{scheme:a,carbonHex:c,chainPalette:d,ssPalette:h}=St(e),{schemes:u,customScheme:m}=$n(a,d,h,n),p=s.size>0?s:new Set(["line"]);xn(o,n,p,a,u,m,c),o.render()}function Fn(n,s){const e=L(),o=k(),{scheme:a,carbonHex:c,chainPalette:d,ssPalette:h}=St(s),{schemes:u,customScheme:m}=$n(a,d,h,n);for(const[,p]of o.objects){if(!p.visible)continue;const b=Object.assign({},n,{model:p.model}),g=p.representations.size>0?p.representations:new Set(["line"]);xn(e,b,g,a,u,m,c)}e.render()}function bt(n,s){const e=L();if(s==="clear"){pn(),e.render();return}const a={atom:"atom",resn:"resn",resi:"resi",chain:"chain",elem:"elem",index:"serial"}[s]||s;let c=e.selectedAtoms(n);["resn","resi","chain"].includes(s)&&(c=c.filter(d=>d.atom==="CA"));for(const d of c)fn(String(d[a]),{x:d.x,y:d.y,z:d.z});e.render()}function Bl(n,s,e){const o=L(),a=s==="line"&&e.representations.has("stick"),c=s==="stick"&&e.representations.has("line");if(e.representations.add(s),!a)if(c){o.setStyle(n,{});for(const d of e.representations)d==="line"&&e.representations.has("stick")||o.addStyle(n,W(d))}else o.addStyle(n,W(s));o.render(),Q()}function jl(n,s,e){const o=L();if(s==="everything")o.setStyle(n,{}),e.representations.clear();else{o.setStyle(n,{}),e.representations.delete(s);for(const a of e.representations)a==="line"&&e.representations.has("stick")||o.addStyle(n,W(a))}o.render(),Q()}function An(n,s){const e=L(),o=k();if(s==="everything")e.setStyle(n,{});else for(const[,a]of o.objects){if(!a.visible)continue;const c=Object.assign({},n,{model:a.model});e.setStyle(c,{});for(const d of a.representations)d!==s&&(d==="line"&&a.representations.has("stick")||e.addStyle(c,W(d)))}e.render()}function Xe(n,s){const e=L();return Et(n,e,s)}function Qe(n){const s=Ye[n.toLowerCase()];return s?s.label:n}if(typeof $3Dmol>"u"){const n=document.createElement("div");throw n.style.cssText="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#1e1e1e;color:#ff6b6b;font-family:monospace;font-size:16px;padding:20px;text-align:center;",n.textContent="Error: 3Dmol.js failed to load. Check your network connection or host the library locally. See index.html for instructions.",document.body.appendChild(n),new Error("3Dmol.js not loaded")}const Le=document.getElementById("app");Wo(document.getElementById("viewer-container"));const N=nl(document.getElementById("terminal-container")),$t=Jo(document.getElementById("sidebar-container"),{onToggleVisibility(n){const s=sl(n);s&&(s.visible?s.model.show():s.model.hide(),L().render(),$t.refresh(k()))},onAction(n,s){const o=k().objects.get(n);if(!o)return;const a=L();switch(s){case"center":a.center({model:o.model}),a.render(),N.print(`Centered on "${n}"`,"result");break;case"orient":we({model:o.model}),N.print(`Oriented "${n}"`,"result");break;case"zoom":a.zoomTo({model:o.model}),a.render(),N.print(`Zoomed to "${n}"`,"result");break;case"delete":{const d=a.selectedAtoms({model:o.model}).map(h=>h.index);a.removeModel(o.model),a.render(),yn(n),mt(d);for(const h of d)se.delete(h);be(),k().activeSelection&&ye(k().activeSelection),N.print(`Deleted "${n}"`,"result");break}case"rename":{cn(n,c=>{try{Sn(n,c),N.print(`Renamed "${n}" to "${c}"`,"result")}catch(d){N.print(d.message,"error")}});break}case"duplicate":N.print("Duplicate not yet implemented","info");break}},onShow(n,s){const o=k().objects.get(n);o&&(Bl({model:o.model},s,o),N.print(`Showing ${s} on "${n}"`,"result"))},onHide(n,s){const o=k().objects.get(n);o&&(jl({model:o.model},s,o),N.print(`Hiding ${s} on "${n}"`,"result"))},onLabel(n,s){const o=k().objects.get(n);o&&(bt({model:o.model},s),N.print(s==="clear"?"Labels cleared":`Labeled "${n}" by ${s}`,"result"))},onView(n,s){const o=k().objects.get(n);if(!o)return;const a=Xe(s,{model:o.model});o.representations=new Set(a),Q(),N.print(`Applied "${Qe(s)}" preset to "${n}"`,"result")},onColor(n,s){const o=k().objects.get(n);o&&(Dl({model:o.model},o.representations,s),N.print(`Colored "${n}" by ${gt(s)}`,"result"))},onToggleSelectionVisibility(n){ol(n)},onSelectionAction(n,s){const o=k().selections.get(n);if(o)switch(s){case"delete":yt(n),N.print(`Deleted selection "(${n})"`,"result");break;case"rename":{cn(n,a=>{try{En(n,a),N.print(`Renamed "(${n})" to "(${a})"`,"result")}catch(c){N.print(c.message,"error")}});break}case"center":L().center(o.spec),L().render(),N.print(`Centered on "(${n})"`,"result");break;case"zoom":L().zoomTo(o.spec),L().render(),N.print(`Zoomed to "(${n})"`,"result");break}},onSelectionShow(n,s){const e=k().selections.get(n);e&&(L().addStyle(e.spec,W(s)),L().render(),N.print(`Showing ${s} on "(${n})"`,"result"))},onSelectionHide(n,s){const e=k().selections.get(n);e&&(An(e.spec,s),N.print(`Hiding ${s} on "(${n})"`,"result"))},onSelectionLabel(n,s){const e=k().selections.get(n);e&&(bt(e.spec,s),N.print(s==="clear"?"Labels cleared":`Labeled "(${n})" by ${s}`,"result"))},onSelectionColor(n,s){const e=k().selections.get(n);e&&(Fn(e.spec,s),N.print(`Colored "(${n})" by ${gt(s)}`,"result"))},onSelectionView(n,s){const e=k().selections.get(n);e&&(Xe(s,e.spec),N.print(`Applied "${Qe(s)}" preset to "(${n})"`,"result"))}}),xt=Yo(document.getElementById("menubar-container"),{onLoad(){$l({onFetch:async n=>{N.print(`Fetching PDB ${n}...`,"info");try{const s=await hn(n),e=s.getID?s.getID():null,o=Ne(n,s,e);N.print(`Loaded ${n} as "${o}"`,"result")}catch(s){N.print(`Failed to fetch ${n}: ${s.message}`,"error")}},onLoad:(n,s,e)=>{try{const o=gn(n,s),a=o.getID?o.getID():null,c=e.replace(/\.[^.]+$/,""),d=Ne(c,o,a);N.print(`Loaded "${e}" as "${d}"`,"result")}catch(o){N.print(`Error loading file: ${o.message}`,"error")}}})},onExport(){xl({onExportPNG:(n,s)=>{const o=L().getCanvas();if(!o){N.print("Export failed: no canvas available","error");return}const a=document.createElement("canvas");a.width=n,a.height=s,a.getContext("2d").drawImage(o,0,0,n,s);const d=a.toDataURL("image/png"),h=document.createElement("a");h.href=d,h.download="screenshot.png",h.click(),N.print(`Screenshot exported (${n}x${s})`,"result")}})},onView(n){const s=Xe(n),e=k();for(const[,o]of e.objects)o.representations=new Set(s);Q(),N.print(`Applied "${Qe(n)}" preset`,"result")},onSelectionMode(n){rl(n),N.print(`Selection mode: ${n}`,"info")},onSelect(n){const s=L(),e=["ALA","ARG","ASN","ASP","CYS","GLN","GLU","GLY","HIS","ILE","LEU","LYS","MET","PHE","PRO","SER","THR","TRP","TYR","VAL","HSD","HSE","HSP","HIE","HID","HIP","CYX","MSE"];let o,a;switch(n){case"protein":o={resn:e},a="protein";break;case"ligand":o={hetflag:!0,not:{resn:["HOH","WAT","H2O"]}},a="ligand";break;case"backbone":o={resn:e,atom:["N","CA","C","O"]},a="backbone";break;case"sidechains":o={resn:e,not:{atom:["N","CA","C","O"]}},a="side chains";break;default:return}const c=s.selectedAtoms(o);if(c.length===0){N.print(`No atoms matched for ${a}`,"info");return}se.clear();for(const h of c)se.add(h.index);const d={index:[...se]};be(),ye(d),We(d),De("sele",a,d,c.length),N.print(`Selected ${a} [${c.length} atoms]`,"info")},onExpand(n){const s=k();if(!s.activeSelection){N.print("No active selection to expand","info");return}const e=L(),o=e.selectedAtoms(s.activeSelection);if(o.length===0){N.print("Current selection contains no atoms","info");return}const a=new Set(o.map(u=>u.index)),c=e.selectedAtoms({});let d;switch(n){case"residues":{const u=new Set(o.map(m=>`${m.chain}:${m.resi}`));for(const m of c)u.has(`${m.chain}:${m.resi}`)&&a.add(m.index);d="residues";break}case"chains":{const u=new Set(o.map(m=>m.chain));for(const m of c)u.has(m.chain)&&a.add(m.index);d="chains";break}case"molecules":{const u=new Set(o.map(m=>m.model));for(const m of c)u.has(m.model)&&a.add(m.index);d="molecules";break}case"nearAtoms":{for(const m of c)if(!a.has(m.index))for(const p of o){const b=m.x-p.x,g=m.y-p.y,C=m.z-p.z;if(b*b+g*g+C*C<=25){a.add(m.index);break}}d="near atoms (5Å)";break}case"nearResidues":{const m=new Set([...a]);for(const g of c)if(!m.has(g.index))for(const C of o){const w=g.x-C.x,y=g.y-C.y,S=g.z-C.z;if(w*w+y*y+S*S<=25){m.add(g.index);break}}const p=c.filter(g=>m.has(g.index)),b=new Set(p.map(g=>`${g.chain}:${g.resi}`));for(const g of c)b.has(`${g.chain}:${g.resi}`)&&a.add(g.index);d="near residues (5Å)";break}default:return}se=a;const h={index:[...se]};be(),ye(h),We(h),De("sele",`expand ${d}`,h,a.size),N.print(`Expanded to ${d} [${a.size} atoms]`,"info")},onSelectionAction(n){const s=k();if(!s.activeSelection){N.print("No active selection","info");return}const e=L();switch(n){case"center":e.center(s.activeSelection),e.render(),N.print("Centered on selection","result");break;case"zoom":e.zoomTo(s.activeSelection),e.render(),N.print("Zoomed to selection","result");break}},onToggleSidebar(){Le.classList.toggle("sidebar-hidden"),L().resize(),L().render()},onToggleTerminal(){Le.classList.toggle("terminal-hidden"),L().resize(),L().render()},onToggleCompact(n){xt.setCompact(n)},onThemeChange(n){const s=k();if(s.settings.theme=n,document.body.dataset.theme=n==="light"?"light":"",!s.settings.userSetBgColor){const e=n==="light"?"#ffffff":"#000000";s.settings.bgColor=e,L().setBackgroundColor(e)}mn(),L().render(),Q();try{localStorage.setItem("3dmol-gui-theme",n)}catch{}}});{let n="dark";try{n=localStorage.getItem("3dmol-gui-theme")||"dark"}catch{}if(n==="light"){const s=k();s.settings.theme="light",document.body.dataset.theme="light",xt.setTheme("light"),s.settings.userSetBgColor||(s.settings.bgColor="#ffffff",L().setBackgroundColor("#ffffff"),L().render())}}const Je=il(),Ln=cl({viewer:L(),terminal:N,sidebar:$t,state:k()});Sl(Je);let se=new Set,vt=!1;function Tl(n,s){const e=s.selectionMode;let o,a;switch(e){case"atoms":o={serial:n.serial},a=`atom ${n.atom} (${n.resn} ${n.chain}:${n.resi})`;break;case"residues":o={chain:n.chain,resi:n.resi},a=`residue ${n.resn} ${n.chain}:${n.resi}`;break;case"chains":o={chain:n.chain},a=`chain ${n.chain}`;break;case"molecules":{let c={};for(const[d,h]of s.objects)if((h.model.getID?h.model.getID():h.modelIndex)===n.model){c={model:h.model},a=`molecule "${d}"`;break}a||(a="all atoms"),o=c;break}default:o={serial:n.serial},a=`atom ${n.atom}`}return{selSpec:o,description:a}}function kn(n,s,e){vt=!0;const o=k(),a=o.selectionMode,c=e&&e.shiftKey,{selSpec:d,description:h}=Tl(n,o),u=s.selectedAtoms(d);c||se.clear();for(const g of u)se.add(g.index);const m={index:[...se]};be(),ye(m),We(m),De("sele","click selection",m,se.size);const p=c?"Added":"Selected",b=se.size;N.print(`${p} ${h} [mode: ${a}, ${b} atom${b!==1?"s":""} total]`,"info")}bn(kn);{let s=null;const e=document.getElementById("viewer-container");e.addEventListener("mousedown",o=>{s={x:o.clientX,y:o.clientY}}),e.addEventListener("click",o=>{const a=s&&(Math.abs(o.clientX-s.x)>4||Math.abs(o.clientY-s.y)>4);s=null,!a&&setTimeout(()=>{!vt&&se.size>0&&(se.clear(),be(),We(null),yt("sele")),vt=!1},0)})}Ll(document.getElementById("viewer-container"),{hasSelection(){return k().activeSelection!==null},onAction(n){const s=L(),e=k().activeSelection;if(e)switch(n){case"center":s.center(e),s.render(),N.print("Centered on selection","result");break;case"zoom":s.zoomTo(e),s.render(),N.print("Zoomed to selection","result");break}},onView(n){const s=k().activeSelection;s&&(Xe(n,s),N.print(`Applied "${Qe(n)}" preset to selection`,"result"))},onShow(n){const s=L(),e=k().activeSelection;e&&(s.addStyle(e,W(n)),s.render(),N.print(`Showing ${n} on selection`,"result"))},onHide(n){const s=k().activeSelection;s&&(An(s,n),N.print(`Hiding ${n} on selection`,"result"))},onLabel(n){const s=k().activeSelection;s&&(bt(s,n),N.print(n==="clear"?"Labels cleared":`Labeled selection by ${n}`,"result"))},onColor(n){const s=k().activeSelection;s&&(Fn(s,n),N.print(`Colored selection by ${gt(n)}`,"result"))}});N.setCompleter((n,s)=>{if(s)return Je.completions(n);const e=k(),o=n.toLowerCase();return[...e.objects.keys(),...e.selections.keys()].filter(c=>c.toLowerCase().startsWith(o)).sort()});ll(()=>$t.refresh(k()));let Ve=null;const H=window.__C3D_INIT__;if(H){const n=L(),s=H.molecules||[];for(const e of s)try{const o=n.addModel(e.data,e.format),a=o.getID?o.getID():null,c=Ne(e.name||e.format,o,a);if(e.disabled){const h=k().objects.get(c);h&&(h.visible=!1,o.hide())}}catch(o){N.print(`Failed to load "${e.name||e.format}": ${o.message}`,"error")}if(bn(kn),n.setStyle({},{}),H.preset){const e=Et(H.preset,n),o=k();for(const[,a]of o.objects)a.representations=new Set(e);Q()}else{const e=H.styles||[];if(e.length>0)for(const o of e){let a;if(typeof o.selection=="string"){const c=ne(o.selection);a=ae(c)}else a=o.selection||{};n.addStyle(a,o.style||{})}else n.setStyle({},W("line"))}if(H.ui&&(H.ui.sidebar===!1&&Le.classList.add("sidebar-hidden"),H.ui.terminal===!1&&Le.classList.add("terminal-hidden"),H.ui.menubar===!1&&Le.classList.add("menubar-hidden")),H.theme==="light"||H.theme==="dark"){const e=k();if(e.settings.theme=H.theme,document.body.dataset.theme=H.theme==="light"?"light":"",xt.setTheme(H.theme),!e.settings.userSetBgColor){const o=H.theme==="light"?"#ffffff":"#000000";e.settings.bgColor=o,n.setBackgroundColor(o)}mn(),Q()}if(H.background){n.setBackgroundColor(H.background);const e=k();e.settings.bgColor=H.background,e.settings.userSetBgColor=!0,Q()}try{if(H.orient!==void 0&&H.orient!==null&&H.orient!==!1)if(H.orient===!0)we();else if(typeof H.orient=="string"){const e=ne(H.orient),o=ae(e);we(o)}else we(H.orient);else if(H.zoomTo!==void 0&&H.zoomTo!==null)if(typeof H.zoomTo=="string"){const e=ne(H.zoomTo),o=ae(e);n.zoomTo(o)}else n.zoomTo(H.zoomTo);else n.zoomTo()}catch(e){N.print(`Zoom failed: ${e.message}`,"error"),n.zoomTo()}n.render(),N.print(`Loaded ${s.length} molecule(s) from initialization`,"info")}else N.print('3Dmol.js GUI ready. Type "help" for commands.',"info"),Ve=Fl({async onTry(){N.print("> fetch 1CRN","command");try{await Je.execute("fetch 1CRN",Ln)}catch(n){N.print(n.message,"error")}},onDismiss(){}});N.onCommand(async n=>{Ve&&(Ve(),Ve=null),N.print(`> ${n}`,"command");try{await Je.execute(n,Ln)}catch(s){N.print(s.message,"error")}});
