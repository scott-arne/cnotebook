(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))l(a);new MutationObserver(a=>{for(const c of a)if(c.type==="childList")for(const f of c.addedNodes)f.tagName==="LINK"&&f.rel==="modulepreload"&&l(f)}).observe(document,{childList:!0,subtree:!0});function e(a){const c={};return a.integrity&&(c.integrity=a.integrity),a.referrerPolicy&&(c.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?c.credentials="include":a.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function l(a){if(a.ep)return;a.ep=!0;const c=e(a);fetch(a.href,c)}})();const Ho={line:{_useStick:!0,radius:.05,singleBonds:!0}},zo=500;function Q(n){const s=Ho[n];if(s&&s._useStick){const{_useStick:e,...l}=s;return{stick:l}}return{[n]:s||{}}}let Me=[];function rn(){return{backgroundOpacity:0,borderThickness:0,fontColor:document.body.dataset.theme==="light"?"#000000":"#FFFFFF",fontSize:12,bold:!0}}function on(n,s){Me.push({text:n,position:s}),R.addLabel(n,{position:s,...rn()})}function ln(){R.removeAllLabels(),Me=[]}function Mo(){if(Me.length===0)return;R.removeAllLabels();const n=rn();for(const s of Me)R.addLabel(s.text,{position:s.position,...n});R.render()}let R=null,ve=null;function Uo(n){ve=document.createElement("div"),ve.id="viewer-canvas",ve.style.width="100%",ve.style.height="100%",n.appendChild(ve),R=$3Dmol.createViewer(ve,{backgroundColor:"#000000",antialias:!0});let s=null;return new ResizeObserver(()=>{s||(s=requestAnimationFrame(()=>{R.resize(),R.render(),s=null}))}).observe(n),R}function A(){return R}async function an(n){const s=`https://files.rcsb.org/download/${n}.pdb`,e=await fetch(s);if(!e.ok)throw new Error(`Failed to fetch PDB "${n}": ${e.status} ${e.statusText}`);const l=await e.text(),a=R.addModel(l,"pdb");return R.setStyle({model:a},{cartoon:{}}),R.zoomTo(),gt(),R.render(),a}function ht(n,s){const e=R.addModel(n,s);return R.setStyle({model:e},{cartoon:{}}),R.zoomTo(),gt(),R.render(),e}function qt(n){return R.selectedAtoms(n||{})}let Re=[],at=!1,it=null,ct=null;function gt(){ct&&R&&R.setClickable({},!0,function(n,s,e){ct(n,s,e)})}function Go(n){ct=n,gt(),R.render()}function ge(){if(at&&it){R.removeAllShapes(),at=!1,it=null,R.render();return}if(Re.length!==0){for(const n of Re)R.removeShape(n);Re=[],R.render()}}function we(n){const s=R.selectedAtoms(n);if(s.length>=zo){R.addStyle(n,{sphere:{radius:.4,color:"yellow",opacity:.35}}),at=!0,it=n,R.render();return}for(const e of s){const l=R.addSphere({center:{x:e.x,y:e.y,z:e.z},radius:.5,color:"#FFFF00",alpha:.5});Re.push(l)}R.render()}const Wt=["atoms","residues","chains","molecules"];function Vo(n,s){let e="atoms",l=!0,a=!0,c=!1,f="dark",h=null,u=null,p=null;function m(){h&&(h.remove(),h=null),u&&(u.classList.remove("active"),u=null),b()}function b(){p&&(p.remove(),p=null)}function g(x,{checked:I=!1,onClick:z}={}){const M=document.createElement("div");return M.className="menubar-dropdown-item",I&&M.classList.add("checked"),M.textContent=x,M.addEventListener("click",W=>{W.stopPropagation(),z&&z(M)}),M}function C(){const x=document.createElement("div");return x.className="menubar-dropdown",x.appendChild(g("Load...",{onClick:()=>{m(),s.onLoad&&s.onLoad()}})),x.appendChild(g("Export Image...",{onClick:()=>{m(),s.onExport&&s.onExport()}})),x}function w(x,I){const z=document.createElement("div");z.className="menubar-dropdown-section-header",z.textContent=I,x.appendChild(z)}function $(x){const I=document.createElement("div");I.className="menubar-dropdown-separator",x.appendChild(I)}function S(){const x=document.createElement("div");x.className="menubar-dropdown",w(x,"Selections");const I=[{label:"Protein",value:"protein"},{label:"Ligand",value:"ligand"},{label:"Backbone",value:"backbone"},{label:"Side Chains",value:"sidechains"}];for(const W of I)x.appendChild(g(W.label,{onClick:()=>{m(),s.onSelect&&s.onSelect(W.value)}}));$(x),w(x,"Expand");const z=[{label:"Residues",value:"residues"},{label:"Chains",value:"chains"},{label:"Molecules",value:"molecules"},{label:"Near Atoms (5Å)",value:"nearAtoms"},{label:"Near Residues (5Å)",value:"nearResidues"}];for(const W of z)x.appendChild(g(W.label,{onClick:()=>{m(),s.onExpand&&s.onExpand(W.value)}}));$(x),w(x,"Action");const M=[{label:"Center",value:"center"},{label:"Zoom",value:"zoom"}];for(const W of M)x.appendChild(g(W.label,{onClick:()=>{m(),s.onSelectionAction&&s.onSelectionAction(W.value)}}));return x}function N(){const x=document.createElement("div");x.className="menubar-dropdown";const I=[{label:"Simple",value:"simple"},{label:"Sites",value:"sites"},{label:"Ball-and-Stick",value:"ball-and-stick"}];for(const z of I)x.appendChild(g(z.label,{onClick:()=>{m(),s.onView&&s.onView(z.value)}}));return x}function j(){const x=document.createElement("div");x.className="menubar-dropdown";const I=g("Sidebar",{checked:l,onClick:X=>{l=!l,X.classList.toggle("checked",l),m(),s.onToggleSidebar&&s.onToggleSidebar()}});x.appendChild(I);const z=g("Terminal",{checked:a,onClick:X=>{a=!a,X.classList.toggle("checked",a),m(),s.onToggleTerminal&&s.onToggleTerminal()}});x.appendChild(z);const M=document.createElement("div");M.className="menubar-dropdown-separator",x.appendChild(M);const W=g("Compact Menu",{checked:c,onClick:X=>{c=!c,X.classList.toggle("checked",c),m(),s.onToggleCompact&&s.onToggleCompact(c)}});x.appendChild(W),$(x),w(x,"Theme");const pe=[{label:"Dark",value:"dark"},{label:"Light",value:"light"}];for(const X of pe)x.appendChild(g(X.label,{checked:f===X.value,onClick:()=>{f=X.value,m(),s.onThemeChange&&s.onThemeChange(X.value)}}));return x}const _={File:C,View:N,Select:S,Window:j},H=[];for(const x of Object.keys(_)){const I=document.createElement("div");I.className="menubar-item",I.textContent=x,I.addEventListener("click",z=>{if(z.stopPropagation(),u===I){m();return}m();const M=_[x]();I.appendChild(M),I.classList.add("active"),h=M,u=I}),n.appendChild(I),H.push(I)}const U=document.createElement("div");U.className="menubar-mode-picker";const Z=document.createElement("span");Z.textContent=e.charAt(0).toUpperCase()+e.slice(1),U.appendChild(Z);const q=document.createElement("span");q.className="menubar-mode-arrow",q.textContent="▼",U.appendChild(q),U.addEventListener("click",x=>{if(x.stopPropagation(),u===U){m();return}m();const I=document.createElement("div");I.className="menubar-dropdown",I.style.right="0",I.style.left="auto";for(const z of Wt){const M=z.charAt(0).toUpperCase()+z.slice(1);I.appendChild(g(M,{checked:z===e,onClick:()=>{e=z,Z.textContent=M,m(),s.onSelectionMode&&s.onSelectionMode(z)}}))}U.appendChild(I),h=I,u=U}),n.appendChild(U);const V=document.createElement("div");return V.className="menubar-hamburger",V.textContent="☰",V.style.display="none",V.addEventListener("click",x=>{if(x.stopPropagation(),p){b();return}const I=document.createElement("div");I.className="menubar-dropdown menubar-hamburger-dropdown";for(const z of Object.keys(_)){const M=document.createElement("div");M.className="menubar-hamburger-menu-item";const W=document.createElement("span");W.textContent=z,M.appendChild(W);const pe=document.createElement("span");pe.className="menubar-hamburger-arrow",pe.textContent="▶",M.appendChild(pe);const X=_[z]();X.className="menubar-hamburger-submenu",M.appendChild(X),I.appendChild(M)}V.appendChild(I),p=I}),n.insertBefore(V,n.firstChild),document.addEventListener("click",()=>{m()}),document.addEventListener("keydown",x=>{x.key==="Escape"&&m()}),{getElement(){return n},setSelectionMode(x){Wt.includes(x)&&(e=x,Z.textContent=x.charAt(0).toUpperCase()+x.slice(1))},setTheme(x){(x==="dark"||x==="light")&&(f=x)},setCompact(x){if(c=x,x){V.style.display="";for(const I of H)I.style.display="none"}else{V.style.display="none";for(const I of H)I.style.display="";b()}}}}const cn=[{label:"Cyan",hex:"#00FFFF"},{label:"Pink",hex:"#FFC0CB"},{label:"Turquoise",hex:"#30D5C8"},{label:"Teal",hex:"#008080"},{label:"Sage",hex:"#B2AC88"},{label:"Lavender",hex:"#E6E6FA"},{label:"Aquamarine",hex:"#7FFFD4"},{label:"Pale Turquoise",hex:"#AFEEEE"},{label:"Light Pink",hex:"#FFB6C1"},{label:"Robin's Egg",hex:"#00CCCC"},{label:"Cerulean",hex:"#007BA7"},{label:"Periwinkle",hex:"#CCCCFF"},{label:"Orange Cream",hex:"#FDE4CF"},{label:"Peach",hex:"#FFCFD2"},{label:"Purple Blue",hex:"#A3C4F3"},{label:"Light Blue",hex:"#8EECF5"},{label:"Marine",hex:"#98F5E1"},{label:"Pastel Blue",hex:"#90DBF4"}],dn=[{label:"Red",hex:"#FF0000"},{label:"Coral",hex:"#FF7F50"},{label:"Salmon",hex:"#FA8072"},{label:"Rose",hex:"#FF007F"},{label:"Light Coral",hex:"#F08080"},{label:"Peach",hex:"#FFCFD2"},{label:"Orange",hex:"#FFA500"},{label:"Light Orange",hex:"#FFA07A"},{label:"Orange Cream",hex:"#FDE4CF"},{label:"Mustard",hex:"#FFDB58"},{label:"Yellow",hex:"#FFFF00"},{label:"Light Yellow",hex:"#FFFFE0"},{label:"Green",hex:"#00FF00"},{label:"Light Green",hex:"#90EE90"},{label:"Pastel Green",hex:"#B9FBC0"},{label:"Feijoa",hex:"#A5D785"},{label:"Sage",hex:"#B2AC88"},{label:"Marine",hex:"#98F5E1"},{label:"Cyan",hex:"#00FFFF"},{label:"Teal",hex:"#008080"},{label:"Turquoise",hex:"#30D5C8"},{label:"Aquamarine",hex:"#7FFFD4"},{label:"Pale Turquoise",hex:"#AFEEEE"},{label:"Robin's Egg",hex:"#00CCCC"},{label:"Blue",hex:"#0000FF"},{label:"Cerulean",hex:"#007BA7"},{label:"Pastel Blue",hex:"#90DBF4"},{label:"Light Blue",hex:"#8EECF5"},{label:"Purple Blue",hex:"#A3C4F3"},{label:"Periwinkle",hex:"#CCCCFF"},{label:"Purple",hex:"#800080"},{label:"Magenta",hex:"#FF00FF"},{label:"Light Purple",hex:"#F1C0E8"},{label:"Pastel Purple",hex:"#CFBAF0"},{label:"Lavender",hex:"#E6E6FA"},{label:"Pink",hex:"#FFC0CB"},{label:"Light Pink",hex:"#FFB6C1"},{label:"Canary",hex:"#FBF8CC"},{label:"White",hex:"#FFFFFF"},{label:"Grey",hex:"#808080"}],Fe={pastel:{label:"Pastel",colors:["#A3C4F3","#B9FBC0","#FFCFD2","#FDE4CF","#CFBAF0","#FBF8CC","#90DBF4","#F1C0E8","#98F5E1","#8EECF5"]},bright:{label:"Pastel (Bright)",colors:["#FF6B6B","#4ECDC4","#FFE66D","#95E1D3","#F38181","#AA96DA","#FCE38A","#A8E6CF","#FF8B94","#DCD6F7"]},dark:{label:"Pastel (Dark)",colors:["#4682B4","#2E8B57","#CD5C5C","#DAA520","#6A5ACD","#20B2AA","#BC8F8F","#8FBC8F","#DB7093","#B8860B"]},rainbow:{label:"Rainbow",colors:["#FF0000","#FF7F00","#FFFF00","#00FF00","#00FFFF","#0000FF","#8B00FF","#FF00FF"]},coolwarm:{label:"Coolwarm",colors:["#3B4CC0","#6788EE","#88BBFF","#AADDFF","#DDDDDD","#FFBBAA","#FF8866","#EE5533","#C03030"]},primary:{label:"Primary Colors",colors:["#FF0000","#0000FF","#FFFF00","#00FF00","#FFA500","#800080","#00FFFF","#FF00FF"]}},bt=[{key:"cool",helix:"#90DBF4",sheet:"#F1C0E8",loop:"#FFCFD2"},{key:"warm",helix:"#FF8B94",sheet:"#8EECF5",loop:"#D3D3D3"},{key:"default",helix:"#FF0080",sheet:"#FFC800",loop:"#FFFFFF"},{key:"classic",helix:"#FF8B94",sheet:"#FCE38A",loop:"#B9FBC0"}],Kt={min:10,max:50};function un(n,s){const u=s-n;return function(p){const m=u>0?Math.max(0,Math.min(1,(p.b-n)/u)):0,b=Math.round(144+m*111),g=Math.round(219+m*-80),C=Math.round(244+m*-96);return b<<16|g<<8|C}}let _e=null,dt=null,Oe=null;function ie(){_e&&(_e.remove(),_e=null),dt=null,Oe&&(Oe(),Oe=null)}function nt(n,s,e){if(dt===n){ie();return}ie();const l=document.createElement("div");l.className="popup-menu";for(const b of s)if(b.separator){const g=document.createElement("div");g.className="popup-menu-separator",l.appendChild(g)}else if(b.submenu==="element-swatches"){const g=document.createElement("div");g.className="popup-menu-item popup-menu-has-submenu";const C=document.createElement("span");C.textContent=b.label,g.appendChild(C);const w=document.createElement("span");w.className="popup-menu-arrow",w.textContent="▶",g.appendChild(w);const $=document.createElement("div");$.className="popup-menu-submenu";const S=document.createElement("div");S.className="popup-menu-submenu-item",S.textContent="Standard",S.addEventListener("click",_=>{_.stopPropagation(),ie(),e(b.value)}),$.appendChild(S);const N=document.createElement("div");N.className="popup-menu-separator",$.appendChild(N);const j=document.createElement("div");j.className="swatch-grid";for(const _ of cn){const H=document.createElement("div");H.className="swatch-cell",H.style.backgroundColor=_.hex,H.title=`${_.label} (${_.hex})`,H.addEventListener("click",U=>{U.stopPropagation(),ie(),e(b.value+":"+_.hex)}),j.appendChild(H)}$.appendChild(j),g.appendChild($),l.appendChild(g)}else if(b.submenu==="solid-swatches"){const g=document.createElement("div");g.className="popup-menu-item popup-menu-has-submenu";const C=document.createElement("span");C.textContent=b.label,g.appendChild(C);const w=document.createElement("span");w.className="popup-menu-arrow",w.textContent="▶",g.appendChild(w);const $=document.createElement("div");$.className="popup-menu-submenu";const S=document.createElement("div");S.className="swatch-grid";for(const N of dn){const j=document.createElement("div");j.className="swatch-cell",j.style.backgroundColor=N.hex,j.title=`${N.label} (${N.hex})`,j.addEventListener("click",_=>{_.stopPropagation(),ie(),e(N.hex)}),S.appendChild(j)}$.appendChild(S),g.appendChild($),l.appendChild(g)}else if(b.submenu==="chain-palettes"){const g=document.createElement("div");g.className="popup-menu-item popup-menu-has-submenu";const C=document.createElement("span");C.textContent=b.label,g.appendChild(C);const w=document.createElement("span");w.className="popup-menu-arrow",w.textContent="▶",g.appendChild(w);const $=document.createElement("div");$.className="popup-menu-submenu";for(const[S,N]of Object.entries(Fe)){const j=document.createElement("div");j.className="popup-menu-submenu-item",j.textContent=N.label,j.addEventListener("click",_=>{_.stopPropagation(),ie(),e("chain:"+S)}),$.appendChild(j)}g.appendChild($),l.appendChild(g)}else if(b.submenu==="ss-palettes"){const g=document.createElement("div");g.className="popup-menu-item popup-menu-has-submenu";const C=document.createElement("span");C.textContent=b.label,g.appendChild(C);const w=document.createElement("span");w.className="popup-menu-arrow",w.textContent="▶",g.appendChild(w);const $=document.createElement("div");$.className="popup-menu-submenu";for(const S of bt){const N=document.createElement("div");N.className="popup-menu-submenu-item ss-palette-item";const j=document.createElement("span");j.textContent="Helix",j.style.color=S.helix,N.appendChild(j),N.appendChild(document.createTextNode(" – "));const _=document.createElement("span");_.textContent="Sheet",_.style.color=S.sheet,N.appendChild(_),N.appendChild(document.createTextNode(" – "));const H=document.createElement("span");H.textContent="Loop",H.style.color=S.loop,N.appendChild(H),N.addEventListener("click",U=>{U.stopPropagation(),ie(),e("ss:"+S.key)}),$.appendChild(N)}g.appendChild($),l.appendChild(g)}else{const g=document.createElement("div");g.className="popup-menu-item",g.textContent=b.label,g.addEventListener("click",C=>{C.stopPropagation(),ie(),e(b.value)}),l.appendChild(g)}document.body.appendChild(l),_e=l,dt=n;const a=n.getBoundingClientRect(),c=l.getBoundingClientRect(),f=window.innerHeight;let h;const u=f-a.bottom;u>=c.height||u>=a.top?h=a.bottom:h=a.top-c.height,l.style.position="absolute",l.style.top=`${h+window.scrollY}px`;let p=a.left+window.scrollX;if(p+c.width>window.innerWidth&&(p=a.right+window.scrollX-c.width),p<0&&(p=0),l.style.left=`${p}px`,p+c.width+160>window.innerWidth)for(const b of l.querySelectorAll(".popup-menu-submenu"))b.classList.add("popup-menu-submenu-left");function m(b){!l.contains(b.target)&&b.target!==n&&ie()}requestAnimationFrame(()=>{document.addEventListener("click",m,!0)}),Oe=()=>{document.removeEventListener("click",m,!0)}}const qo=[{label:"Rename...",value:"rename"},{label:"Delete",value:"delete"},{separator:!0},{label:"Center",value:"center"},{label:"Zoom",value:"zoom"}],Wo={S:"onSelectionShow",H:"onSelectionHide",L:"onSelectionLabel",C:"onSelectionColor"},Yt={A:{callbackKey:"onAction",items:[{label:"Rename...",value:"rename"},{label:"Duplicate",value:"duplicate"},{label:"Delete",value:"delete"},{separator:!0},{label:"Center",value:"center"},{label:"Orient",value:"orient"},{label:"Zoom",value:"zoom"}]},S:{callbackKey:"onShow",items:[{label:"Cartoon",value:"cartoon"},{label:"Sticks",value:"stick"},{label:"Lines",value:"line"},{label:"Spheres",value:"sphere"},{label:"Surface",value:"surface"},{label:"Cross",value:"cross"},{separator:!0},{label:"Simple",value:"view:simple"},{label:"Sites",value:"view:sites"},{label:"Ball-and-Stick",value:"view:ball-and-stick"}]},H:{callbackKey:"onHide",items:[{label:"Everything",value:"everything"},{separator:!0},{label:"Cartoon",value:"cartoon"},{label:"Sticks",value:"stick"},{label:"Lines",value:"line"},{label:"Spheres",value:"sphere"},{label:"Surface",value:"surface"},{label:"Cross",value:"cross"}]},L:{callbackKey:"onLabel",items:[{label:"Atom Name",value:"atom"},{label:"Residue Name",value:"resn"},{label:"Chain ID",value:"chain"},{label:"Element",value:"elem"},{label:"Index",value:"index"},{separator:!0},{label:"Clear",value:"clear"}]},C:{callbackKey:"onColor",items:[{label:"Solid",value:"solid",submenu:"solid-swatches"},{label:"By Element",value:"element",submenu:"element-swatches"},{label:"By Chain",value:"chain",submenu:"chain-palettes"},{label:"By SS",value:"ss",submenu:"ss-palettes"},{label:"By B-Factor",value:"bfactor"}]}};function Ko(n,s){n.classList.add("sidebar");function e(a,c){const f=document.createElement("div");f.className="sidebar-object",c.visible||f.classList.add("dimmed"),f.addEventListener("click",()=>{s.onToggleVisibility(a)});const h=document.createElement("div");h.className="sidebar-object-status",c.visible&&h.classList.add("active"),f.appendChild(h);const u=document.createElement("span");u.className="sidebar-object-name",u.textContent=a,f.appendChild(u);const p=document.createElement("div");p.className="sidebar-buttons";for(const m of["A","S","H","L","C"]){const b=document.createElement("button");b.className="sidebar-btn",b.textContent=m;const g=Yt[m];b.addEventListener("click",C=>{C.stopPropagation(),nt(b,g.items,w=>{w.startsWith("view:")&&s.onView?s.onView(a,w.slice(5)):s[g.callbackKey](a,w)})}),p.appendChild(b)}return f.appendChild(p),f}function l(a,c){const f=document.createElement("div");f.className="sidebar-object sidebar-selection",c.visible||f.classList.add("dimmed"),f.addEventListener("click",()=>{s.onToggleSelectionVisibility(a)});const h=document.createElement("div");h.className="sidebar-object-status",c.visible&&h.classList.add("active"),f.appendChild(h);const u=document.createElement("span");u.className="sidebar-object-name",u.textContent=`(${a})`,f.appendChild(u);const p=document.createElement("div");p.className="sidebar-buttons";const m=document.createElement("button");m.className="sidebar-btn",m.textContent="A",m.addEventListener("click",b=>{b.stopPropagation(),nt(m,qo,g=>{s.onSelectionAction(a,g)})}),p.appendChild(m);for(const b of["S","H","L","C"]){const g=document.createElement("button");g.className="sidebar-btn",g.textContent=b;const C=Yt[b],w=Wo[b];g.addEventListener("click",$=>{$.stopPropagation(),nt(g,C.items,S=>{S.startsWith("view:")&&s.onSelectionView?s.onSelectionView(a,S.slice(5)):s[w](a,S)})}),p.appendChild(g)}return f.appendChild(p),f}return{refresh(a){const c=new Set;for(const[u,p]of a.objects){c.add("obj:"+u);let m=n.querySelector(`[data-kind="object"][data-name="${CSS.escape(u)}"]`);if(m){m.classList.toggle("dimmed",!p.visible);const b=m.querySelector(".sidebar-object-status");b&&b.classList.toggle("active",p.visible)}else{m=e(u,p),m.dataset.kind="object",m.dataset.name=u;const b=n.querySelector(".sidebar-separator");b?n.insertBefore(m,b):n.appendChild(m)}}const f=a.selections.size>0;let h=n.querySelector(".sidebar-separator");f&&!h?(h=document.createElement("div"),h.className="sidebar-separator",n.appendChild(h)):!f&&h&&h.remove();for(const[u,p]of a.selections){c.add("sel:"+u);let m=n.querySelector(`[data-kind="selection"][data-name="${CSS.escape(u)}"]`);if(!m)m=l(u,p),m.dataset.kind="selection",m.dataset.name=u,n.appendChild(m);else{m.classList.toggle("dimmed",!p.visible);const b=m.querySelector(".sidebar-object-status");b&&b.classList.toggle("active",p.visible)}}for(const u of[...n.querySelectorAll("[data-kind]")]){const p=u.dataset.kind==="object"?"obj:":"sel:";c.has(p+u.dataset.name)||u.remove()}},hide(){n.classList.add("hidden")},show(){n.classList.remove("hidden")},getElement(){return n}}}const Yo=100,Zo=1e3;function Xo(n){const s=[];let e=-1,l=null,a=null;const c=document.createElement("div");c.className="terminal-output";const f=document.createElement("div");f.className="terminal-input-row";const h=document.createElement("span");h.className="terminal-prompt",h.textContent=">";const u=document.createElement("textarea");u.className="terminal-input",u.rows=1;const p=document.createElement("button");p.className="terminal-send",p.textContent="Send";const m=document.createElement("button");m.className="terminal-collapse",m.textContent="▾",f.appendChild(h),f.appendChild(u),f.appendChild(p),f.appendChild(m),n.appendChild(c),n.appendChild(f);function b(){u.style.height="auto",u.style.height=Math.min(u.scrollHeight,96)+"px"}function g(){u.style.height=""}u.addEventListener("input",b);function C(){const w=u.value;w.trim()!==""&&(s.push(w),s.length>Yo&&s.shift(),e=-1,u.value="",g(),l&&l(w))}return u.addEventListener("keydown",w=>{if(w.key==="Tab"){if(w.preventDefault(),!a)return;const $=u.value,S=u.selectionStart,N=$.substring(0,S),j=$.substring(S),_=!N.includes(" ");let H;if(_)H=0;else for(H=Math.max(N.lastIndexOf(","),N.lastIndexOf(" "))+1;H<S&&N[H]===" ";)H++;const U=N.substring(H);if(!U)return;const Z=a(U,_);if(!Z||Z.length===0)return;if(Z.length===1){const q=Z[0];u.value=N.substring(0,H)+q+" "+j;const V=H+q.length+1;u.selectionStart=u.selectionEnd=V}else{let q=Z[0];for(let V=1;V<Z.length;V++){let x=0;for(;x<q.length&&x<Z[V].length&&q[x]===Z[V][x];)x++;q=q.substring(0,x)}if(q.length>U.length){u.value=N.substring(0,H)+q+j;const V=H+q.length;u.selectionStart=u.selectionEnd=V}}b();return}if(w.key==="Enter"&&!w.shiftKey){w.preventDefault(),C();return}if(w.key==="ArrowUp"){const $=u.value.includes(`
`),S=u.selectionStart===0&&u.selectionEnd===0;(!$||S)&&s.length>0&&(w.preventDefault(),e===-1?e=s.length-1:e>0&&e--,u.value=s[e],b());return}if(w.key==="ArrowDown"){const $=u.value.includes(`
`),S=u.selectionStart===0&&u.selectionEnd===0;(!$||S)&&e!==-1&&(w.preventDefault(),e<s.length-1?(e++,u.value=s[e]):(e=-1,u.value=""),b());return}}),p.addEventListener("click",C),m.addEventListener("click",()=>{const w=c.classList.toggle("collapsed");m.textContent=w?"▸":"▾"}),{print(w,$){const S=document.createElement("div");for(S.className="terminal-line"+($?" "+$:""),S.textContent=w,c.appendChild(S);c.childElementCount>Zo;)c.removeChild(c.firstChild);c.scrollTop=c.scrollHeight},clear(){c.innerHTML=""},getElement(){return n},onCommand(w){l=w},setCompleter(w){a=w},hide(){n.style.display="none"},show(){n.style.display=""}}}const O={objects:new Map,selections:new Map,selectionMode:"atoms",activeSelection:null,settings:{bgColor:"#000000",theme:"dark",userSetBgColor:!1},_listeners:[]};function se(){for(const n of O._listeners)n(O)}function ee(){se()}function L(){return O}function Ae(n,s,e){let l=n;if(O.objects.has(l)){let a=2;for(;O.objects.has(`${n}_${a}`);)a++;l=`${n}_${a}`}return O.objects.set(l,{model:s,modelIndex:e,visible:!0,representations:new Set(["cartoon"])}),se(),l}function fn(n){O.objects.delete(n),se()}function Qo(n){const s=O.objects.get(n);return s&&(s.visible=!s.visible,se()),s}function Jo(n){O.selectionMode=n,se()}function Ue(n,s,e,l){O.selections.set(n,{expression:s,spec:e,atomCount:l,visible:!0}),se()}function vt(n){O.selections.delete(n),se()}function pn(n,s){const e=O.selections.get(n);if(!e)return!1;if(O.selections.has(s))throw new Error(`A selection named "${s}" already exists`);return O.selections.delete(n),O.selections.set(s,e),se(),!0}function mn(n,s){const e=O.objects.get(n);if(!e)return!1;if(O.objects.has(s))throw new Error(`An object named "${s}" already exists`);return O.objects.delete(n),O.objects.set(s,e),se(),!0}function el(n){const s=O.selections.get(n);return s&&(s.visible=!s.visible,se()),s}function ut(n){const s=new Set(n);let e=!1;const l=[];for(const[a,c]of O.selections)if(c.spec&&Array.isArray(c.spec.index)){const f=c.spec.index.filter(h=>!s.has(h));f.length!==c.spec.index.length&&(e=!0,f.length===0?l.push(a):(c.spec={index:f},c.atomCount=f.length))}for(const a of l)O.selections.delete(a);if(O.activeSelection&&Array.isArray(O.activeSelection.index)){const a=O.activeSelection.index.filter(c=>!s.has(c));a.length===0?(O.activeSelection=null,e=!0):a.length!==O.activeSelection.index.length&&(O.activeSelection={index:a},e=!0)}e&&se()}function Ge(n){O.activeSelection=n,se()}function tl(n){O._listeners.push(n)}function nl(n){const s=n.trim(),e=s.indexOf(" ");return e===-1?{name:s.toLowerCase(),args:""}:{name:s.substring(0,e).toLowerCase(),args:s.substring(e+1).trim()}}function J(n){return n?n.split(",").map(s=>s.trim()).filter(s=>s.length>0):[]}function sl(){const n=new Map;return{register(s,{handler:e,usage:l,help:a}){n.set(s.toLowerCase(),{handler:e,usage:l,help:a})},execute(s,e){const{name:l,args:a}=nl(s);let c=n.get(l);if(!c){const f=[...n.keys()].filter(h=>h.startsWith(l));if(f.length===1)c=n.get(f[0]);else throw f.length>1?new Error(`Ambiguous command "${l}": ${f.join(", ")}`):new Error(`Error: unknown command '${l}'`)}return c.handler(a,e)},list(){return[...n.keys()].sort()},getHelp(s){const e=n.get(s.toLowerCase());return e?{usage:e.usage,help:e.help}:null},has(s){return n.has(s.toLowerCase())},completions(s){const e=s.toLowerCase();return[...n.keys()].filter(l=>l.startsWith(e)).sort()}}}function rl({viewer:n,terminal:s,sidebar:e,state:l}){return{viewer:n,terminal:s,sidebar:e,state:l}}let st=!1;function ol(n){n.register("fetch",{handler:async(s,e)=>{const l=s.trim().toUpperCase();if(!/^[A-Z0-9]{4}$/.test(l))throw new Error("Usage: fetch <pdb_id> (must be a 4-character PDB ID)");if(st)throw new Error("A fetch is already in progress. Please wait.");st=!0;try{e.terminal.print(`Fetching PDB ${l}...`,"info");const a=await an(l),c=a.getID?a.getID():null,f=Ae(l,a,c);e.terminal.print(`Loaded ${l} as "${f}"`,"result")}catch(a){throw new Error(`Failed to fetch ${l}: ${a.message}`)}finally{st=!1}},usage:"fetch <pdb_id>",help:"Fetch a structure from the RCSB PDB by ID."}),n.register("load",{handler:(s,e)=>{const l=document.createElement("input");l.type="file",l.style.display="none",l.accept=".pdb,.sdf,.mol2,.xyz,.cube,.pqr,.gro,.cif,.mmcif",l.onchange=a=>{const c=a.target.files[0];if(!c)return;const f=c.name.split(".").pop().toLowerCase(),h=new FileReader;h.onload=u=>{try{const p=ht(u.target.result,f),m=p.getID?p.getID():null,b=c.name.replace(/\.[^.]+$/,""),g=Ae(b,p,m);e.terminal.print(`Loaded "${c.name}" as "${g}"`,"result")}catch(p){e.terminal.print(`Error loading file: ${p.message}`,"error")}},h.onerror=()=>{var u;e.terminal.print(`Error reading file: ${((u=h.error)==null?void 0:u.message)||"unknown error"}`,"error")},h.readAsText(c)},l.click()},usage:"load",help:"Open a file picker to load a local molecular structure file."})}function ll(n,s){function e(){this.constructor=n}e.prototype=s.prototype,n.prototype=new e}function he(n,s,e,l){var a=Error.call(this,n);return Object.setPrototypeOf&&Object.setPrototypeOf(a,he.prototype),a.expected=s,a.found=e,a.location=l,a.name="SyntaxError",a}ll(he,Error);function rt(n,s,e){return e=e||" ",n.length>s?n:(s-=n.length,e+=e.repeat(s),n+e.slice(0,s))}he.prototype.format=function(n){var s="Error: "+this.message;if(this.location){var e=null,l;for(l=0;l<n.length;l++)if(n[l].source===this.location.source){e=n[l].text.split(/\r\n|\n|\r/g);break}var a=this.location.start,c=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(a):a,f=this.location.source+":"+c.line+":"+c.column;if(e){var h=this.location.end,u=rt("",c.line.toString().length," "),p=e[a.line-1],m=a.line===h.line?h.column:p.length+1,b=m-a.column||1;s+=`
 --> `+f+`
`+u+` |
`+c.line+" | "+p+`
`+u+" | "+rt("",a.column-1," ")+rt("",b,"^")}else s+=`
 at `+f}return s};he.buildMessage=function(n,s){var e={literal:function(p){return'"'+a(p.text)+'"'},class:function(p){var m=p.parts.map(function(b){return Array.isArray(b)?c(b[0])+"-"+c(b[1]):c(b)});return"["+(p.inverted?"^":"")+m.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(p){return p.description}};function l(p){return p.charCodeAt(0).toString(16).toUpperCase()}function a(p){return p.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(m){return"\\x0"+l(m)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(m){return"\\x"+l(m)})}function c(p){return p.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(m){return"\\x0"+l(m)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(m){return"\\x"+l(m)})}function f(p){return e[p.type](p)}function h(p){var m=p.map(f),b,g;if(m.sort(),m.length>0){for(b=1,g=1;b<m.length;b++)m[b-1]!==m[b]&&(m[g]=m[b],g++);m.length=g}switch(m.length){case 1:return m[0];case 2:return m[0]+" or "+m[1];default:return m.slice(0,-1).join(", ")+", or "+m[m.length-1]}}function u(p){return p?'"'+a(p)+'"':"end of input"}return"Expected "+h(n)+" but "+u(s)+" found."};function hn(n,s){s=s!==void 0?s:{};var e={},l=s.grammarSource,a={Selection:_t},c=_t,f="around",h="xaround",u="beyond",p="(",m=")",b="byres",g="bychain",C="name",w="resn",$="resi",S="index",N="-",j="chain",_="elem",H="//",U="/",Z="protein",q="ligand",V="water",x="solvent",I="organic",z="backbone",M="bb",W="sidechain",pe="sc",X="metals",Sn="metal",xn="nonpolar_hydrogen",Fn="apolarh",An="polar_hydrogen",Ln="polarh",kn="heavy",Nn="hydrogen",Bn="h",Dn="helix",jn="sheet",In="turn",Tn="loop",Pn="all",Rn="none",_n="and",On="or",Hn="not",zn="xor",yt="+",Et='"',$t=">=",St="<=",Mn=">",Un="<",Gn=".",ce=/^[0-9]/,xt=/^[^"]/,Ft=/^[a-zA-Z0-9*?_\-]/,Vn=/^[a-zA-Z0-9]/,qn=/^[a-zA-Z]/,Wn=/^[a-z]/,Kn=/^[a-zA-Z0-9_]/,Le=/^[ \t\n\r]/,At=B("around",!0),Lt=B("xaround",!0),kt=B("beyond",!0),Yn=B("(",!1),Zn=B(")",!1),Xn=B("byres",!0),Qn=B("bychain",!0),Jn=B("name",!0),es=B("resn",!0),ts=B("resi",!0),ns=B("index",!0),Nt=B("-",!1),ss=B("chain",!0),rs=B("elem",!0),os=B("//",!1),Xe=B("/",!1),de=ue([["0","9"]],!1,!1),ls=B("protein",!0),as=B("ligand",!0),is=B("water",!0),cs=B("solvent",!0),ds=B("organic",!0),us=B("backbone",!0),fs=B("bb",!0),ps=B("sidechain",!0),ms=B("sc",!0),hs=B("metals",!0),gs=B("metal",!0),bs=B("nonpolar_hydrogen",!0),vs=B("apolarh",!0),Cs=B("polar_hydrogen",!0),ws=B("polarh",!0),ys=B("heavy",!0),Es=B("hydrogen",!0),$s=B("h",!0),Ss=B("helix",!0),xs=B("sheet",!0),Fs=B("turn",!0),As=B("loop",!0),Ls=B("all",!0),ks=B("none",!0),Ns=B("and",!0),Bs=B("or",!0),Ds=B("not",!0),js=B("xor",!0),Bt=B("+",!1),Dt=B('"',!1),jt=ue(['"'],!0,!1),It=ue([["a","z"],["A","Z"],["0","9"],"*","?","_","-"],!1,!1),Is=B(">=",!1),Ts=B("<=",!1),Ps=B(">",!1),Rs=B("<",!1),_s=B(".",!1),Os=ue([["a","z"],["A","Z"],["0","9"]],!1,!1),Hs=ue([["a","z"],["A","Z"]],!1,!1),zs=ue([["a","z"]],!1,!1),Ms=ue([["a","z"],["A","Z"],["0","9"],"_"],!1,!1),Us=Pt("optional whitespace"),ke=ue([" ","	",`
`,"\r"],!1,!1),Gs=Pt("required whitespace"),Vs=function(t){return t},qs=function(t,o){return o.length===0?t:{type:"xor",children:[t,...o.map(d=>d[3])]}},Ws=function(t,o){return o.length===0?t:{type:"or",children:[t,...o.map(d=>d[3])]}},Ks=function(t,o){return o.length===0?t:{type:"and",children:[t,...o.map(d=>d[3])]}},Ys=function(t){return{type:"not",child:t}},Zs=function(t,o,i){return{type:o,radius:i,child:t}},Xs=function(){return"around"},Qs=function(){return"xaround"},Js=function(){return"beyond"},er=function(t){return t},tr=function(t){return{type:"byres",child:t}},nr=function(t){return{type:"bychain",child:t}},sr=function(t,o){return{type:"around",radius:t,child:o}},rr=function(t,o){return{type:"xaround",radius:t,child:o}},or=function(t,o){return{type:"beyond",radius:t,child:o}},lr=function(t){return{type:"name",values:t}},ar=function(t){return{type:"resn",values:t}},ir=function(t){return{type:"resi",...t}},cr=function(t){return{type:"index",...t}},dr=function(t,o){return{op:t,value:o}},ur=function(t,o){return{op:"range",low:t,high:o}},fr=function(t){return{op:"==",value:t}},pr=function(t){return{type:"chain",value:t}},mr=function(t){return{type:"elem",value:t}},hr=function(t,o){const i=[];return t&&i.push({type:"chain",value:t}),o.resi!==null&&o.resi!==void 0&&i.push({type:"resi",op:"==",value:o.resi}),o.name&&i.push({type:"name",values:[o.name]}),i.length===0&&Xr("Empty macro specifier"),i.length===1?i[0]:{type:"and",children:i}},gr=function(t,o){return{resi:t,name:o||null}},br=function(t){return{resi:null,name:t||null}},vr=function(t){return{resi:null,name:t}},Cr=function(){return{resi:null,name:null}},wr=function(t){return parseInt(t.join(""),10)},yr=function(){return{type:"protein"}},Er=function(){return{type:"ligand"}},$r=function(){return{type:"water"}},Sr=function(){return{type:"solvent"}},xr=function(){return{type:"organic"}},Fr=function(){return{type:"backbone"}},Ar=function(){return{type:"sidechain"}},Lr=function(){return{type:"metal"}},kr=function(){return{type:"nonpolar_hydrogen"}},Nr=function(){return{type:"polar_hydrogen"}},Br=function(){return{type:"heavy"}},Dr=function(){return{type:"hydrogen"}},jr=function(){return{type:"helix"}},Ir=function(){return{type:"sheet"}},Tr=function(){return{type:"turn"}},Pr=function(){return{type:"loop"}},Rr=function(){return{type:"all"}},_r=function(){return{type:"none"}},Tt=function(t,o){return o},Or=function(t,o){return[t,...o]},Hr=function(t){return t.join("")},zr=function(t){return t.join("")},Mr=function(){return">="},Ur=function(){return"<="},Gr=function(){return">"},Vr=function(){return"<"},qr=function(t){return parseInt(t.join(""),10)},Wr=function(t,o,i){return"."+i.join("")},Kr=function(t,o,i){return parseFloat((t||"")+o.join("")+(i||""))},Yr=function(t){return t},Zr=function(t,o){return t+(o||"")},r=s.peg$currPos|0,F=r,be=[{line:1,column:1}],re=r,Ne=s.peg$maxFailExpected||[],v=s.peg$silentFails|0,ye;if(s.startRule){if(!(s.startRule in a))throw new Error(`Can't start parsing from rule "`+s.startRule+'".');c=a[s.startRule]}function Xr(t,o){throw o=o!==void 0?o:Qe(F,r),Jr(t,o)}function B(t,o){return{type:"literal",text:t,ignoreCase:o}}function ue(t,o,i){return{type:"class",parts:t,inverted:o,ignoreCase:i}}function Qr(){return{type:"end"}}function Pt(t){return{type:"other",description:t}}function Rt(t){var o=be[t],i;if(o)return o;if(t>=be.length)i=be.length-1;else for(i=t;!be[--i];);for(o=be[i],o={line:o.line,column:o.column};i<t;)n.charCodeAt(i)===10?(o.line++,o.column=1):o.column++,i++;return be[t]=o,o}function Qe(t,o,i){var d=Rt(t),y=Rt(o),D={source:l,start:{offset:t,line:d.line,column:d.column},end:{offset:o,line:y.line,column:y.column}};return D}function E(t){r<re||(r>re&&(re=r,Ne=[]),Ne.push(t))}function Jr(t,o){return new he(t,null,null,o)}function eo(t,o,i){return new he(he.buildMessage(t,o),t,o,i)}function _t(){var t,o;return t=r,K(),o=Ot(),o!==e?(K(),F=t,t=Vs(o)):(r=t,t=e),t}function Ot(){var t,o,i,d,y,D,P,G;if(t=r,o=Je(),o!==e){for(i=[],d=r,y=K(),D=Ut(),D!==e?(P=K(),G=Je(),G!==e?(y=[y,D,P,G],d=y):(r=d,d=e)):(r=d,d=e);d!==e;)i.push(d),d=r,y=K(),D=Ut(),D!==e?(P=K(),G=Je(),G!==e?(y=[y,D,P,G],d=y):(r=d,d=e)):(r=d,d=e);F=t,t=qs(o,i)}else r=t,t=e;return t}function Je(){var t,o,i,d,y,D,P,G;if(t=r,o=et(),o!==e){for(i=[],d=r,y=K(),D=Mt(),D!==e?(P=K(),G=et(),G!==e?(y=[y,D,P,G],d=y):(r=d,d=e)):(r=d,d=e);d!==e;)i.push(d),d=r,y=K(),D=Mt(),D!==e?(P=K(),G=et(),G!==e?(y=[y,D,P,G],d=y):(r=d,d=e)):(r=d,d=e);F=t,t=Ws(o,i)}else r=t,t=e;return t}function et(){var t,o,i,d,y,D,P,G;if(t=r,o=Be(),o!==e){for(i=[],d=r,y=K(),D=zt(),D!==e?(P=K(),G=Be(),G!==e?(y=[y,D,P,G],d=y):(r=d,d=e)):(r=d,d=e);d!==e;)i.push(d),d=r,y=K(),D=zt(),D!==e?(P=K(),G=Be(),G!==e?(y=[y,D,P,G],d=y):(r=d,d=e)):(r=d,d=e);F=t,t=Ks(o,i)}else r=t,t=e;return t}function Be(){var t,o,i,d;return t=r,o=Po(),o!==e?(i=Y(),i!==e?(d=Be(),d!==e?(F=t,t=Ys(d)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e),t===e&&(t=to()),t}function to(){var t,o,i,d,y,D;return t=r,o=me(),o!==e?(i=Y(),i!==e?(d=no(),d!==e?(y=Y(),y!==e?(D=Ie(),D!==e?(F=t,t=Zs(o,d,D)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e),t===e&&(t=me()),t}function no(){var t,o,i,d;return t=r,o=n.substr(r,6),o.toLowerCase()===f?r+=6:(o=e,v===0&&E(At)),o!==e?(i=r,v++,d=T(),v--,d===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=Xs()):(r=t,t=e)):(r=t,t=e),t===e&&(t=r,o=n.substr(r,7),o.toLowerCase()===h?r+=7:(o=e,v===0&&E(Lt)),o!==e?(i=r,v++,d=T(),v--,d===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=Qs()):(r=t,t=e)):(r=t,t=e),t===e&&(t=r,o=n.substr(r,6),o.toLowerCase()===u?r+=6:(o=e,v===0&&E(kt)),o!==e?(i=r,v++,d=T(),v--,d===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=Js()):(r=t,t=e)):(r=t,t=e))),t}function me(){var t,o,i,d;return t=r,n.charCodeAt(r)===40?(o=p,r++):(o=e,v===0&&E(Yn)),o!==e?(K(),i=Ot(),i!==e?(K(),n.charCodeAt(r)===41?(d=m,r++):(d=e,v===0&&E(Zn)),d!==e?(F=t,t=er(i)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e),t===e&&(t=so(),t===e&&(t=ro(),t===e&&(t=oo(),t===e&&(t=lo(),t===e&&(t=ao(),t===e&&(t=io(),t===e&&(t=co(),t===e&&(t=uo(),t===e&&(t=po(),t===e&&(t=mo(),t===e&&(t=fo(),t===e&&(t=ho(),t===e&&(t=Fo(),t===e&&(t=Ao(),t===e&&(t=Lo(),t===e&&(t=ko(),t===e&&(t=vo(),t===e&&(t=Co(),t===e&&(t=wo(),t===e&&(t=yo(),t===e&&(t=Eo(),t===e&&(t=$o(),t===e&&(t=So(),t===e&&(t=xo(),t===e&&(t=No(),t===e&&(t=Bo(),t===e&&(t=Do(),t===e&&(t=jo(),t===e&&(t=Io(),t===e&&(t=To())))))))))))))))))))))))))))))),t}function so(){var t,o,i,d,y;return t=r,o=n.substr(r,5),o.toLowerCase()===b?r+=5:(o=e,v===0&&E(Xn)),o!==e?(i=r,v++,d=T(),v--,d===e?i=void 0:(r=i,i=e),i!==e?(d=Y(),d!==e?(y=me(),y!==e?(F=t,t=tr(y)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e),t}function ro(){var t,o,i,d,y;return t=r,o=n.substr(r,7),o.toLowerCase()===g?r+=7:(o=e,v===0&&E(Qn)),o!==e?(i=r,v++,d=T(),v--,d===e?i=void 0:(r=i,i=e),i!==e?(d=Y(),d!==e?(y=me(),y!==e?(F=t,t=nr(y)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e),t}function oo(){var t,o,i,d,y,D,P;return t=r,o=n.substr(r,6),o.toLowerCase()===f?r+=6:(o=e,v===0&&E(At)),o!==e?(i=r,v++,d=T(),v--,d===e?i=void 0:(r=i,i=e),i!==e?(d=Y(),d!==e?(y=Ie(),y!==e?(D=Y(),D!==e?(P=me(),P!==e?(F=t,t=sr(y,P)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e),t}function lo(){var t,o,i,d,y,D,P;return t=r,o=n.substr(r,7),o.toLowerCase()===h?r+=7:(o=e,v===0&&E(Lt)),o!==e?(i=r,v++,d=T(),v--,d===e?i=void 0:(r=i,i=e),i!==e?(d=Y(),d!==e?(y=Ie(),y!==e?(D=Y(),D!==e?(P=me(),P!==e?(F=t,t=rr(y,P)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e),t}function ao(){var t,o,i,d,y,D,P;return t=r,o=n.substr(r,6),o.toLowerCase()===u?r+=6:(o=e,v===0&&E(kt)),o!==e?(i=r,v++,d=T(),v--,d===e?i=void 0:(r=i,i=e),i!==e?(d=Y(),d!==e?(y=Ie(),y!==e?(D=Y(),D!==e?(P=me(),P!==e?(F=t,t=or(y,P)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e),t}function io(){var t,o,i,d,y;return t=r,o=n.substr(r,4),o.toLowerCase()===C?r+=4:(o=e,v===0&&E(Jn)),o!==e?(i=r,v++,d=T(),v--,d===e?i=void 0:(r=i,i=e),i!==e?(d=Y(),d!==e?(y=Gt(),y!==e?(F=t,t=lr(y)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e),t}function co(){var t,o,i,d,y;return t=r,o=n.substr(r,4),o.toLowerCase()===w?r+=4:(o=e,v===0&&E(es)),o!==e?(i=r,v++,d=T(),v--,d===e?i=void 0:(r=i,i=e),i!==e?(d=Y(),d!==e?(y=Gt(),y!==e?(F=t,t=ar(y)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e),t}function uo(){var t,o,i,d,y;return t=r,o=n.substr(r,4),o.toLowerCase()===$?r+=4:(o=e,v===0&&E(ts)),o!==e?(i=r,v++,d=T(),v--,d===e?i=void 0:(r=i,i=e),i!==e?(d=Y(),d!==e?(y=Ht(),y!==e?(F=t,t=ir(y)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e),t}function fo(){var t,o,i,d,y;return t=r,o=n.substr(r,5),o.toLowerCase()===S?r+=5:(o=e,v===0&&E(ns)),o!==e?(i=r,v++,d=T(),v--,d===e?i=void 0:(r=i,i=e),i!==e?(d=Y(),d!==e?(y=Ht(),y!==e?(F=t,t=cr(y)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e),t}function Ht(){var t,o,i,d;return t=r,o=_o(),o!==e?(i=K(),d=je(),d!==e?(F=t,t=dr(o,d)):(r=t,t=e)):(r=t,t=e),t===e&&(t=r,o=je(),o!==e?(n.charCodeAt(r)===45?(i=N,r++):(i=e,v===0&&E(Nt)),i!==e?(d=je(),d!==e?(F=t,t=ur(o,d)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e),t===e&&(t=r,o=je(),o!==e&&(F=t,o=fr(o)),t=o)),t}function po(){var t,o,i,d,y;return t=r,o=n.substr(r,5),o.toLowerCase()===j?r+=5:(o=e,v===0&&E(ss)),o!==e?(i=r,v++,d=T(),v--,d===e?i=void 0:(r=i,i=e),i!==e?(d=Y(),d!==e?(y=Vt(),y!==e?(F=t,t=pr(y)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e),t}function mo(){var t,o,i,d,y;return t=r,o=n.substr(r,4),o.toLowerCase()===_?r+=4:(o=e,v===0&&E(rs)),o!==e?(i=r,v++,d=T(),v--,d===e?i=void 0:(r=i,i=e),i!==e?(d=Y(),d!==e?(y=Oo(),y!==e?(F=t,t=mr(y)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e),t}function ho(){var t,o,i,d,y;return t=r,n.substr(r,2)===H?(o=H,r+=2):(o=e,v===0&&E(os)),o!==e?(i=Vt(),i===e&&(i=null),n.charCodeAt(r)===47?(d=U,r++):(d=e,v===0&&E(Xe)),d!==e?(y=go(),y!==e?(F=t,t=hr(i,y)):(r=t,t=e)):(r=t,t=e)):(r=t,t=e),t}function go(){var t,o,i,d;return t=r,o=bo(),o!==e?(n.charCodeAt(r)===47?(i=U,r++):(i=e,v===0&&E(Xe)),i!==e?(d=De(),d===e&&(d=null),F=t,t=gr(o,d)):(r=t,t=e)):(r=t,t=e),t===e&&(t=r,n.charCodeAt(r)===47?(o=U,r++):(o=e,v===0&&E(Xe)),o!==e?(i=De(),i===e&&(i=null),F=t,t=br(i)):(r=t,t=e),t===e&&(t=r,o=De(),o!==e&&(F=t,o=vr(o)),t=o,t===e&&(t=r,o="",F=t,o=Cr(),t=o))),t}function bo(){var t,o,i;if(t=r,o=[],i=n.charAt(r),ce.test(i)?r++:(i=e,v===0&&E(de)),i!==e)for(;i!==e;)o.push(i),i=n.charAt(r),ce.test(i)?r++:(i=e,v===0&&E(de));else o=e;return o!==e&&(F=t,o=wr(o)),t=o,t}function vo(){var t,o,i,d;return t=r,o=n.substr(r,7),o.toLowerCase()===Z?r+=7:(o=e,v===0&&E(ls)),o!==e?(i=r,v++,d=T(),v--,d===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=yr()):(r=t,t=e)):(r=t,t=e),t}function Co(){var t,o,i,d;return t=r,o=n.substr(r,6),o.toLowerCase()===q?r+=6:(o=e,v===0&&E(as)),o!==e?(i=r,v++,d=T(),v--,d===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=Er()):(r=t,t=e)):(r=t,t=e),t}function wo(){var t,o,i,d;return t=r,o=n.substr(r,5),o.toLowerCase()===V?r+=5:(o=e,v===0&&E(is)),o!==e?(i=r,v++,d=T(),v--,d===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=$r()):(r=t,t=e)):(r=t,t=e),t}function yo(){var t,o,i,d;return t=r,o=n.substr(r,7),o.toLowerCase()===x?r+=7:(o=e,v===0&&E(cs)),o!==e?(i=r,v++,d=T(),v--,d===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=Sr()):(r=t,t=e)):(r=t,t=e),t}function Eo(){var t,o,i,d;return t=r,o=n.substr(r,7),o.toLowerCase()===I?r+=7:(o=e,v===0&&E(ds)),o!==e?(i=r,v++,d=T(),v--,d===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=xr()):(r=t,t=e)):(r=t,t=e),t}function $o(){var t,o,i,d;return t=r,o=n.substr(r,8),o.toLowerCase()===z?r+=8:(o=e,v===0&&E(us)),o===e&&(o=n.substr(r,2),o.toLowerCase()===M?r+=2:(o=e,v===0&&E(fs))),o!==e?(i=r,v++,d=T(),v--,d===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=Fr()):(r=t,t=e)):(r=t,t=e),t}function So(){var t,o,i,d;return t=r,o=n.substr(r,9),o.toLowerCase()===W?r+=9:(o=e,v===0&&E(ps)),o===e&&(o=n.substr(r,2),o.toLowerCase()===pe?r+=2:(o=e,v===0&&E(ms))),o!==e?(i=r,v++,d=T(),v--,d===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=Ar()):(r=t,t=e)):(r=t,t=e),t}function xo(){var t,o,i,d;return t=r,o=n.substr(r,6),o.toLowerCase()===X?r+=6:(o=e,v===0&&E(hs)),o===e&&(o=n.substr(r,5),o.toLowerCase()===Sn?r+=5:(o=e,v===0&&E(gs))),o!==e?(i=r,v++,d=T(),v--,d===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=Lr()):(r=t,t=e)):(r=t,t=e),t}function Fo(){var t,o,i,d;return t=r,o=n.substr(r,17),o.toLowerCase()===xn?r+=17:(o=e,v===0&&E(bs)),o===e&&(o=n.substr(r,7),o.toLowerCase()===Fn?r+=7:(o=e,v===0&&E(vs))),o!==e?(i=r,v++,d=T(),v--,d===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=kr()):(r=t,t=e)):(r=t,t=e),t}function Ao(){var t,o,i,d;return t=r,o=n.substr(r,14),o.toLowerCase()===An?r+=14:(o=e,v===0&&E(Cs)),o===e&&(o=n.substr(r,6),o.toLowerCase()===Ln?r+=6:(o=e,v===0&&E(ws))),o!==e?(i=r,v++,d=T(),v--,d===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=Nr()):(r=t,t=e)):(r=t,t=e),t}function Lo(){var t,o,i,d;return t=r,o=n.substr(r,5),o.toLowerCase()===kn?r+=5:(o=e,v===0&&E(ys)),o!==e?(i=r,v++,d=T(),v--,d===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=Br()):(r=t,t=e)):(r=t,t=e),t}function ko(){var t,o,i,d;return t=r,o=n.substr(r,8),o.toLowerCase()===Nn?r+=8:(o=e,v===0&&E(Es)),o===e&&(o=n.charAt(r),o.toLowerCase()===Bn?r++:(o=e,v===0&&E($s))),o!==e?(i=r,v++,d=T(),v--,d===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=Dr()):(r=t,t=e)):(r=t,t=e),t}function No(){var t,o,i,d;return t=r,o=n.substr(r,5),o.toLowerCase()===Dn?r+=5:(o=e,v===0&&E(Ss)),o!==e?(i=r,v++,d=T(),v--,d===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=jr()):(r=t,t=e)):(r=t,t=e),t}function Bo(){var t,o,i,d;return t=r,o=n.substr(r,5),o.toLowerCase()===jn?r+=5:(o=e,v===0&&E(xs)),o!==e?(i=r,v++,d=T(),v--,d===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=Ir()):(r=t,t=e)):(r=t,t=e),t}function Do(){var t,o,i,d;return t=r,o=n.substr(r,4),o.toLowerCase()===In?r+=4:(o=e,v===0&&E(Fs)),o!==e?(i=r,v++,d=T(),v--,d===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=Tr()):(r=t,t=e)):(r=t,t=e),t}function jo(){var t,o,i,d;return t=r,o=n.substr(r,4),o.toLowerCase()===Tn?r+=4:(o=e,v===0&&E(As)),o!==e?(i=r,v++,d=T(),v--,d===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=Pr()):(r=t,t=e)):(r=t,t=e),t}function Io(){var t,o,i,d;return t=r,o=n.substr(r,3),o.toLowerCase()===Pn?r+=3:(o=e,v===0&&E(Ls)),o!==e?(i=r,v++,d=T(),v--,d===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=Rr()):(r=t,t=e)):(r=t,t=e),t}function To(){var t,o,i,d;return t=r,o=n.substr(r,4),o.toLowerCase()===Rn?r+=4:(o=e,v===0&&E(ks)),o!==e?(i=r,v++,d=T(),v--,d===e?i=void 0:(r=i,i=e),i!==e?(F=t,t=_r()):(r=t,t=e)):(r=t,t=e),t}function zt(){var t,o,i,d;return t=r,o=n.substr(r,3),o.toLowerCase()===_n?r+=3:(o=e,v===0&&E(Ns)),o!==e?(i=r,v++,d=T(),v--,d===e?i=void 0:(r=i,i=e),i!==e?(o=[o,i],t=o):(r=t,t=e)):(r=t,t=e),t}function Mt(){var t,o,i,d;return t=r,o=n.substr(r,2),o.toLowerCase()===On?r+=2:(o=e,v===0&&E(Bs)),o!==e?(i=r,v++,d=T(),v--,d===e?i=void 0:(r=i,i=e),i!==e?(o=[o,i],t=o):(r=t,t=e)):(r=t,t=e),t}function Po(){var t,o,i,d;return t=r,o=n.substr(r,3),o.toLowerCase()===Hn?r+=3:(o=e,v===0&&E(Ds)),o!==e?(i=r,v++,d=T(),v--,d===e?i=void 0:(r=i,i=e),i!==e?(o=[o,i],t=o):(r=t,t=e)):(r=t,t=e),t}function Ut(){var t,o,i,d;return t=r,o=n.substr(r,3),o.toLowerCase()===zn?r+=3:(o=e,v===0&&E(js)),o!==e?(i=r,v++,d=T(),v--,d===e?i=void 0:(r=i,i=e),i!==e?(o=[o,i],t=o):(r=t,t=e)):(r=t,t=e),t}function Gt(){var t,o,i,d,y,D;if(t=r,o=tt(),o!==e){for(i=[],d=r,n.charCodeAt(r)===43?(y=yt,r++):(y=e,v===0&&E(Bt)),y!==e?(D=tt(),D!==e?(F=d,d=Tt(o,D)):(r=d,d=e)):(r=d,d=e);d!==e;)i.push(d),d=r,n.charCodeAt(r)===43?(y=yt,r++):(y=e,v===0&&E(Bt)),y!==e?(D=tt(),D!==e?(F=d,d=Tt(o,D)):(r=d,d=e)):(r=d,d=e);F=t,t=Or(o,i)}else r=t,t=e;return t}function tt(){var t;return t=Ro(),t===e&&(t=De()),t}function Ro(){var t,o,i,d;if(t=r,n.charCodeAt(r)===34?(o=Et,r++):(o=e,v===0&&E(Dt)),o!==e){for(i=[],d=n.charAt(r),xt.test(d)?r++:(d=e,v===0&&E(jt));d!==e;)i.push(d),d=n.charAt(r),xt.test(d)?r++:(d=e,v===0&&E(jt));n.charCodeAt(r)===34?(d=Et,r++):(d=e,v===0&&E(Dt)),d!==e?(F=t,t=Hr(i)):(r=t,t=e)}else r=t,t=e;return t}function De(){var t,o,i;if(t=r,o=[],i=n.charAt(r),Ft.test(i)?r++:(i=e,v===0&&E(It)),i!==e)for(;i!==e;)o.push(i),i=n.charAt(r),Ft.test(i)?r++:(i=e,v===0&&E(It));else o=e;return o!==e&&(F=t,o=zr(o)),t=o,t}function _o(){var t,o;return t=r,n.substr(r,2)===$t?(o=$t,r+=2):(o=e,v===0&&E(Is)),o!==e&&(F=t,o=Mr()),t=o,t===e&&(t=r,n.substr(r,2)===St?(o=St,r+=2):(o=e,v===0&&E(Ts)),o!==e&&(F=t,o=Ur()),t=o,t===e&&(t=r,n.charCodeAt(r)===62?(o=Mn,r++):(o=e,v===0&&E(Ps)),o!==e&&(F=t,o=Gr()),t=o,t===e&&(t=r,n.charCodeAt(r)===60?(o=Un,r++):(o=e,v===0&&E(Rs)),o!==e&&(F=t,o=Vr()),t=o))),t}function je(){var t,o,i;if(t=r,o=[],i=n.charAt(r),ce.test(i)?r++:(i=e,v===0&&E(de)),i!==e)for(;i!==e;)o.push(i),i=n.charAt(r),ce.test(i)?r++:(i=e,v===0&&E(de));else o=e;return o!==e&&(F=t,o=qr(o)),t=o,t}function Ie(){var t,o,i,d,y,D,P;if(t=r,n.charCodeAt(r)===45?(o=N,r++):(o=e,v===0&&E(Nt)),o===e&&(o=null),i=[],d=n.charAt(r),ce.test(d)?r++:(d=e,v===0&&E(de)),d!==e)for(;d!==e;)i.push(d),d=n.charAt(r),ce.test(d)?r++:(d=e,v===0&&E(de));else i=e;if(i!==e){if(d=r,n.charCodeAt(r)===46?(y=Gn,r++):(y=e,v===0&&E(_s)),y!==e){for(D=[],P=n.charAt(r),ce.test(P)?r++:(P=e,v===0&&E(de));P!==e;)D.push(P),P=n.charAt(r),ce.test(P)?r++:(P=e,v===0&&E(de));F=d,d=Wr(o,i,D)}else r=d,d=e;d===e&&(d=null),F=t,t=Kr(o,i,d)}else r=t,t=e;return t}function Vt(){var t,o;return t=r,o=n.charAt(r),Vn.test(o)?r++:(o=e,v===0&&E(Os)),o!==e&&(F=t,o=Yr(o)),t=o,t}function Oo(){var t,o,i;return t=r,o=n.charAt(r),qn.test(o)?r++:(o=e,v===0&&E(Hs)),o!==e?(i=n.charAt(r),Wn.test(i)?r++:(i=e,v===0&&E(zs)),i===e&&(i=null),F=t,t=Zr(o,i)):(r=t,t=e),t}function T(){var t;return t=n.charAt(r),Kn.test(t)?r++:(t=e,v===0&&E(Ms)),t}function K(){var t,o;for(v++,t=[],o=n.charAt(r),Le.test(o)?r++:(o=e,v===0&&E(ke));o!==e;)t.push(o),o=n.charAt(r),Le.test(o)?r++:(o=e,v===0&&E(ke));return v--,o=e,v===0&&E(Us),t}function Y(){var t,o;if(v++,t=[],o=n.charAt(r),Le.test(o)?r++:(o=e,v===0&&E(ke)),o!==e)for(;o!==e;)t.push(o),o=n.charAt(r),Le.test(o)?r++:(o=e,v===0&&E(ke));else t=e;return v--,t===e&&(o=e,v===0&&E(Gs)),t}if(ye=c(),s.peg$library)return{peg$result:ye,peg$currPos:r,peg$FAILED:e,peg$maxFailExpected:Ne,peg$maxFailPos:re};if(ye!==e&&r===n.length)return ye;throw ye!==e&&r<n.length&&E(Qr()),eo(Ne,re<n.length?n.charAt(re):null,re<n.length?Qe(re,re+1):Qe(re,re))}const Ce=new Set(["ALA","ARG","ASN","ASP","CYS","GLN","GLU","GLY","HIS","ILE","LEU","LYS","MET","PHE","PRO","SER","THR","TRP","TYR","VAL","MSE","SEC","PYL","ASX","GLX"]),xe=new Set(["HOH","WAT","H2O","DOD","TIP","TIP3","SPC"]),Te=new Set([...xe,"DMSO","DMF","ACN","MeOH","EtOH","IPA","GOL","PEG"]),Zt=new Set(["N","CA","C","O"]),Xt=new Set(["LI","BE","NA","MG","AL","K","CA","SC","TI","V","CR","MN","FE","CO","NI","CU","ZN","GA","RB","SR","Y","ZR","NB","MO","RU","RH","PD","AG","CD","IN","SN","CS","BA","LA","CE","PR","ND","SM","EU","GD","TB","DY","HO","ER","TM","YB","LU","HF","TA","W","RE","OS","IR","PT","AU","HG","TL","PB","BI"]);function Ee(n,s){const e=n.x-s.x,l=n.y-s.y,a=n.z-s.z;return Math.sqrt(e*e+l*l+a*a)}function al(n){const s=n.replace(/[.+^${}()|[\]\\]/g,"\\$&").replace(/\*/g,".*").replace(/\?/g,".");return new RegExp(`^${s}$`,"i")}function Qt(n,s){for(const e of s)if(e.includes("*")||e.includes("?")){if(al(e).test(n))return!0}else if(n.toUpperCase()===e.toUpperCase())return!0;return!1}function Jt(n,s){switch(n.op){case"==":return s===n.value;case"range":return s>=n.low&&s<=n.high;case">=":return s>=n.value;case"<=":return s<=n.value;case">":return s>n.value;case"<":return s<n.value;default:return!1}}function oe(n,s){switch(n.type){case"all":return[...s];case"none":return[];case"name":return s.filter(e=>Qt(e.atom,n.values));case"resn":return s.filter(e=>Qt(e.resn,n.values));case"resi":return s.filter(e=>Jt(n,e.resi));case"chain":return s.filter(e=>e.chain===n.value);case"elem":return s.filter(e=>e.elem.toUpperCase()===n.value.toUpperCase());case"index":return s.filter(e=>Jt(n,e.serial));case"and":{let e=[...s];for(const l of n.children){const a=new Set(oe(l,s));e=e.filter(c=>a.has(c))}return e}case"or":{const e=new Set;for(const l of n.children)for(const a of oe(l,s))e.has(a)||e.add(a);return s.filter(l=>e.has(l))}case"not":{const e=new Set(oe(n.child,s));return s.filter(l=>!e.has(l))}case"xor":{const e=n.children.map(l=>new Set(oe(l,s)));return s.filter(l=>e.reduce((c,f)=>c+(f.has(l)?1:0),0)===1)}case"protein":return s.filter(e=>Ce.has(e.resn));case"water":return s.filter(e=>xe.has(e.resn));case"solvent":return s.filter(e=>Te.has(e.resn));case"backbone":return s.filter(e=>Ce.has(e.resn)&&Zt.has(e.atom));case"sidechain":return s.filter(e=>Ce.has(e.resn)&&!Zt.has(e.atom)&&e.atom!=="OXT");case"metal":return s.filter(e=>Xt.has(e.elem.toUpperCase()));case"ligand":return s.filter(e=>!Ce.has(e.resn)&&!xe.has(e.resn)&&!Te.has(e.resn)&&!Xt.has(e.elem.toUpperCase()));case"organic":{const e=new Set;for(const l of s)!Ce.has(l.resn)&&!xe.has(l.resn)&&!Te.has(l.resn)&&l.elem.toUpperCase()==="C"&&e.add(`${l.chain}:${l.resi}`);return s.filter(l=>!Ce.has(l.resn)&&!xe.has(l.resn)&&!Te.has(l.resn)&&e.has(`${l.chain}:${l.resi}`))}case"hydrogen":return s.filter(e=>e.elem==="H");case"heavy":return s.filter(e=>e.elem!=="H");case"polar_hydrogen":{const e=s.filter(c=>c.elem==="H"),l=s.filter(c=>c.elem!=="H"),a=new Set(["N","O","S"]);return e.filter(c=>{let f=1/0,h=null;for(const u of l){const p=Ee(c,u);p<f&&(f=p,h=u.elem)}return h&&a.has(h.toUpperCase())})}case"nonpolar_hydrogen":{const e=s.filter(a=>a.elem==="H"),l=s.filter(a=>a.elem!=="H");return e.filter(a=>{let c=1/0,f=null;for(const h of l){const u=Ee(a,h);u<c&&(c=u,f=h.elem)}return f&&f.toUpperCase()==="C"})}case"helix":return s.filter(e=>e.ss==="h");case"sheet":return s.filter(e=>e.ss==="s");case"turn":return s.filter(e=>e.ss==="t");case"loop":return s.filter(e=>e.ss===""||e.ss==="c"||!e.ss);case"around":{const e=oe(n.child,s),l=new Set(e),a=n.radius;return s.filter(c=>{if(l.has(c))return!0;for(const f of e)if(Ee(c,f)<=a)return!0;return!1})}case"xaround":{const e=oe(n.child,s),l=new Set(e),a=n.radius;return s.filter(c=>{if(l.has(c))return!1;for(const f of e)if(Ee(c,f)<=a)return!0;return!1})}case"beyond":{const e=oe(n.child,s),l=n.radius;return s.filter(a=>{for(const c of e)if(Ee(a,c)<=l)return!1;return!0})}case"byres":{const e=oe(n.child,s),l=new Set;for(const a of e)l.add(`${a.chain}:${a.resi}`);return s.filter(a=>l.has(`${a.chain}:${a.resi}`))}case"bychain":{const e=oe(n.child,s),l=new Set;for(const a of e)l.add(a.chain);return s.filter(a=>l.has(a.chain))}default:throw new Error(`Unknown AST node type: ${n.type}`)}}function gn(n){switch(n.type){case"name":return{atom:n.values};case"resn":return{resn:n.values};case"resi":return n.op==="=="?{resi:n.value}:null;case"chain":return{chain:n.value};case"elem":return{elem:n.value};case"all":return{};case"and":{const s={};for(const e of n.children){const l=gn(e);if(l===null)return null;Object.assign(s,l)}return s}default:return null}}function le(n){const s=(n||"").trim();if(s===""||s.toLowerCase()==="all")return{spec:{}};const e=L(),l=e.selections.get(s);if(l)return{spec:l.spec};const a=e.objects.get(s);if(a)return{spec:{model:a.model}};const c=[...e.selections.keys()].filter(g=>g.startsWith(s)),f=[...e.objects.keys()].filter(g=>g.startsWith(s)),h=[...c,...f];if(h.length===1){const g=h[0];return c.length===1?{spec:e.selections.get(g).spec}:{spec:{model:e.objects.get(g).model}}}if(h.length>1)throw new Error(`Ambiguous name "${s}": ${h.join(", ")}`);let u;try{u=hn(s)}catch(g){throw new Error(`Invalid selection "${s}": ${g.message}`)}const p=gn(u);if(p){const g=qt(p);if(!g||g.length===0)throw new Error(`No atoms match the selection "${s}"`);return{spec:p}}const m=qt({});if(!m||m.length===0)throw new Error(`Selection "${s}" requires atom-level evaluation but no atoms are loaded`);const b=oe(u,m);if(b.length===0)throw new Error(`No atoms match the selection "${s}"`);return{atoms:b}}function fe(n){return n.spec?n.spec:{index:n.atoms.map(s=>s.index)}}const $e={cartoon:"cartoon",stick:"stick",sticks:"stick",line:"line",lines:"line",sphere:"sphere",spheres:"sphere",surface:"surface",cross:"cross",crosses:"cross",ribbon:"ribbon",ribbons:"ribbon",everything:"everything"};function en(n){const s=n.toLowerCase(),e=$e[s];if(e)return e;const l=Object.keys($e).filter(a=>a.startsWith(s));if(l.length===1)return $e[l[0]];if(l.length>1){const a=[...new Set(l.map(c=>$e[c]))];throw new Error(`Ambiguous representation "${n}": ${a.join(", ")}`)}throw new Error(`Unknown representation "${n}". Valid: ${[...new Set(Object.values($e))].join(", ")}`)}function il(n){n.register("show",{handler:(s,e)=>{const l=J(s);if(l.length===0)throw new Error("Usage: show <representation> [, selection]");const a=en(l[0]),c=l.slice(1).join(", ")||null,f=le(c),h=fe(f),u=A(),p=L(),m=[];if(c){if(f.spec&&f.spec.model)for(const[,C]of p.objects)C.model===f.spec.model&&m.push(C)}else for(const[,C]of p.objects)m.push(C);const b=a==="line"&&m.some(C=>C.representations.has("stick")),g=a==="stick"&&m.some(C=>C.representations.has("line"));for(const C of m)C.representations.add(a);if(!b)if(g){u.setStyle(h,{});for(const[,C]of p.objects)if(C.visible)for(const w of C.representations)w==="line"&&C.representations.has("stick")||u.addStyle(h,Q(w))}else u.addStyle(h,Q(a));u.render(),ee(),e.terminal.print(`Showing ${a}${c?` for ${c}`:""}`,"result")},usage:"show <representation> [, selection]",help:"Show a representation (cartoon, stick, line, sphere, surface, cross, ribbon)."}),n.register("hide",{handler:(s,e)=>{const l=J(s);if(l.length===0)throw new Error("Usage: hide <representation> [, selection]");const a=l[0].trim(),c=en(a),f=l.slice(1).join(", ")||null,h=le(f),u=fe(h),p=A(),m=L();if(c==="everything")if(p.setStyle(u,{}),f){if(h.spec&&h.spec.model)for(const[,b]of m.objects)b.model===h.spec.model&&b.representations.clear()}else for(const[,b]of m.objects)b.representations.clear();else if(p.setStyle(u,{}),f){if(h.spec&&h.spec.model){for(const[,b]of m.objects)if(b.model===h.spec.model&&b.representations.delete(c),b.visible)for(const g of b.representations)g==="line"&&b.representations.has("stick")||p.addStyle(u,Q(g))}else for(const[,b]of m.objects)if(b.visible)for(const g of b.representations)g!==c&&(g==="line"&&b.representations.has("stick")||p.addStyle(u,Q(g)))}else for(const[,b]of m.objects)if(b.representations.delete(c),b.visible)for(const g of b.representations)g==="line"&&b.representations.has("stick")||p.addStyle(u,Q(g));p.render(),ee(),e.terminal.print(`Hiding ${a.toLowerCase()}${f?` for ${f}`:""}`,"result")},usage:"hide <representation> [, selection]",help:'Hide a representation. Use "hide everything" to clear all styles.'}),n.register("enable",{handler:(s,e)=>{const l=s.trim();if(!l)throw new Error("Usage: enable <object_name>");const c=L().objects.get(l);if(!c)throw new Error(`Object "${l}" not found`);c.model.show(),c.visible=!0,A().render(),ee(),e.terminal.print(`Enabled "${l}"`,"result")},usage:"enable <object_name>",help:"Show a hidden molecular object."}),n.register("disable",{handler:(s,e)=>{const l=s.trim();if(!l)throw new Error("Usage: disable <object_name>");const c=L().objects.get(l);if(!c)throw new Error(`Object "${l}" not found`);c.model.hide(),c.visible=!1,A().render(),ee(),e.terminal.print(`Disabled "${l}"`,"result")},usage:"disable <object_name>",help:"Hide a molecular object without removing it."})}const tn={red:"#FF0000",green:"#00FF00",blue:"#0000FF",yellow:"#FFFF00",cyan:"#00FFFF",magenta:"#FF00FF",orange:"#FFA500",white:"#FFFFFF",grey:"#808080",gray:"#808080",salmon:"#FA8072",lime:"#00FF00",pink:"#FFC0CB",purple:"#800080",turquoise:"#30D5C8",coral:"#FF7F50",teal:"#008080",sage:"#B2AC88",lavender:"#E6E6FA",mustard:"#FFDB58",aquamarine:"#7FFFD4",feijoa:"#A5D785",rose:"#FF007F",paleturquoise:"#AFEEEE",lightcoral:"#F08080",lightgreen:"#90EE90",lightyellow:"#FFFFE0",lightorange:"#FFA07A",lightpink:"#FFB6C1",robinsegg:"#00CCCC",cerulean:"#007BA7",periwinkle:"#CCCCFF",canary:"#FBF8CC",orangecream:"#FDE4CF",peach:"#FFCFD2",lightpurple:"#F1C0E8",purpleblue:"#A3C4F3",lightblue:"#8EECF5",marine:"#98F5E1",pastelgreen:"#B9FBC0",pastelblue:"#90DBF4",pastelpurple:"#CFBAF0"},Ve={};function Pe(n){const s=n.trim().toLowerCase();return Ve[s]?Ve[s]:tn[s]?tn[s]:s.startsWith("0x")?"#"+s.substring(2):s.startsWith("#")&&(s.length===4||s.length===7)?s:null}function cl(n){n.register("color",{handler:(s,e)=>{const l=J(s);if(l.length===0)throw new Error("Usage: color <color|scheme> [, selection]");const a=l[0].trim().toLowerCase(),c=l.slice(1).join(", ")||null,f=le(c),h=fe(f),u=A();if(["element","elem","cpk","chain","ss","secondary_structure","spectrum","b","bfactor"].includes(a)){["element","elem","cpk"].includes(a)?u.setStyle(h,{cartoon:{colorscheme:"Jmol"},stick:{colorscheme:"Jmol"}}):a==="chain"?u.setStyle(h,{cartoon:{colorscheme:"chain"}}):["ss","secondary_structure"].includes(a)?u.setStyle(h,{cartoon:{colorscheme:"ssJmol"}}):["spectrum","b","bfactor"].includes(a)&&u.setStyle(h,{cartoon:{colorscheme:{prop:"b",gradient:"roygb"}}}),u.render(),e.terminal.print(`Colored by ${a}${c?` for ${c}`:""}`,"result");return}const m=Pe(l[0]);if(!m)throw new Error(`Unknown color "${l[0]}". Use a named color, hex (#RRGGBB), or a scheme (element, chain, ss, spectrum).`);const b=L(),g=new Set;for(const[,w]of b.objects)for(const $ of w.representations)g.add($);g.size===0&&g.add("cartoon");const C={};for(const w of g)C[w]={color:m};u.setStyle(h,C),u.render(),e.terminal.print(`Colored ${l[0]}${c?` for ${c}`:""}`,"result")},usage:"color <color|scheme> [, selection]",help:"Color atoms. Use named colors (red, green, blue...), hex (#FF0000), or schemes (element, chain, ss, spectrum)."}),n.register("set_color",{handler:(s,e)=>{const l=J(s);if(l.length<2)throw new Error("Usage: set_color <name>, [<r>, <g>, <b>] or set_color <name>, <hex>");const a=l[0].trim().toLowerCase();if(l.length===3)throw new Error("RGB format requires 3 values: set_color <name>, <r>, <g>, <b>");if(l.length===4){const c=parseInt(l[1],10),f=parseInt(l[2],10),h=parseInt(l[3],10);if(isNaN(c)||isNaN(f)||isNaN(h))throw new Error("RGB values must be numbers (0-255)");if(c<0||c>255||f<0||f>255||h<0||h>255)throw new Error("RGB values must be between 0 and 255");const u=`#${c.toString(16).padStart(2,"0")}${f.toString(16).padStart(2,"0")}${h.toString(16).padStart(2,"0")}`;Ve[a]=u,e.terminal.print(`Defined color "${a}" as ${u}`,"result")}else{const c=Pe(l[1]);if(!c)throw new Error(`Invalid color value: ${l[1]}`);Ve[a]=c,e.terminal.print(`Defined color "${a}" as ${c}`,"result")}},usage:"set_color <name>, <hex> | set_color <name>, <r>, <g>, <b>",help:"Define a custom named color."}),n.register("bg_color",{handler:(s,e)=>{const l=s.trim();if(!l)throw new Error("Usage: bg_color <color>");const a=Pe(l);if(!a)throw new Error(`Unknown color "${l}"`);const c=A();c.setBackgroundColor(a),c.render();const f=L();f.settings.bgColor=a,f.settings.userSetBgColor=!0,ee(),e.terminal.print(`Background color set to ${a}`,"result")},usage:"bg_color <color>",help:"Set the viewer background color."}),n.register("set",{handler:(s,e)=>{const l=J(s);if(l.length<2)throw new Error("Usage: set <setting>, <value>");const a=l[0].trim().toLowerCase(),c=l[1].trim(),f=A();switch(a){case"bg_color":{const h=Pe(c);if(!h)throw new Error(`Unknown color "${c}"`);f.setBackgroundColor(h);const u=L();u.settings.bgColor=h,u.settings.userSetBgColor=!0;break}case"stick_radius":{const h=parseFloat(c);if(isNaN(h))throw new Error("stick_radius must be a number");const u=L();u.settings.stickRadius=h;for(const[,p]of u.objects){if(!p.visible||!p.representations.has("stick"))continue;const m={model:p.model};f.setStyle(m,{});for(const b of p.representations){if(b==="line"&&p.representations.has("stick"))continue;const g=Q(b);b==="stick"&&(g.stick=Object.assign({},g.stick,{radius:h})),f.addStyle(m,g)}}break}case"sphere_scale":{const h=parseFloat(c);if(isNaN(h))throw new Error("sphere_scale must be a number");const u=L();u.settings.sphereScale=h;for(const[,p]of u.objects){if(!p.visible||!p.representations.has("sphere"))continue;const m={model:p.model};f.setStyle(m,{});for(const b of p.representations){if(b==="line"&&p.representations.has("stick"))continue;const g=Q(b);b==="sphere"&&(g.sphere=Object.assign({},g.sphere,{scale:h})),f.addStyle(m,g)}}break}case"label_size":{const h=parseInt(c,10);if(isNaN(h))throw new Error("label_size must be a number");const u=L();u.settings.labelSize=h;break}default:throw new Error(`Unknown setting "${a}". Valid: bg_color, stick_radius, sphere_scale, label_size`)}f.render(),ee(),e.terminal.print(`Set ${a} = ${c}`,"result")},usage:"set <setting>, <value>",help:"Change a viewer setting. Settings: bg_color, stick_radius, sphere_scale, label_size."}),n.register("cartoon_style",{handler:(s,e)=>{const l=J(s);if(l.length===0)throw new Error(`Usage: cartoon_style <style> [, entry]
Styles: default, rectangle, oval, trace, parabola, edged`);const a=l[0].trim().toLowerCase(),c=l.length>1?l[1].trim():null,f={default:"rectangle",rectangle:"rectangle",oval:"oval",trace:"trace",parabola:"parabola",edged:"edged"},h=f[a];if(!h)throw new Error(`Unknown cartoon style "${a}". Valid: ${Object.keys(f).join(", ")}`);const u=A(),p=L();let m=0;for(const[g,C]of p.objects){if(c&&g!==c||!C.visible||!C.representations.has("cartoon"))continue;const w={model:C.model};u.setStyle(w,{});for(const $ of C.representations){if($==="line"&&C.representations.has("stick"))continue;const S=Q($);$==="cartoon"&&(S.cartoon=Object.assign({},S.cartoon,{style:h})),u.addStyle(w,S)}m++}if(c&&m===0)throw new Error(`Object "${c}" not found or has no cartoon representation`);u.render();const b=c||"all objects";e.terminal.print(`Set cartoon style to ${h} for ${b}`,"result")},usage:"cartoon_style <style> [, entry]",help:"Set cartoon rendering style. Styles: default, rectangle, oval, trace, parabola, edged."}),n.register("bfactor_spectrum",{handler:(s,e)=>{const l=J(s);if(l.length<2)throw new Error("Usage: bfactor_spectrum <min>, <max>");const a=parseFloat(l[0]),c=parseFloat(l[1]);if(isNaN(a)||isNaN(c))throw new Error("min and max must be numbers");if(a>=c)throw new Error("min must be less than max");const f=L();f.settings.bfactorMin=a,f.settings.bfactorMax=c;const h=A(),u=un(a,c);for(const[,p]of f.objects){if(!p.visible)continue;const m={model:p.model},b=p.representations.size>0?p.representations:new Set(["cartoon"]),g={};for(const C of b)g[C]={colorfunc:u};h.setStyle(m,g)}h.render(),ee(),e.terminal.print(`B-factor spectrum set to ${a}–${c} (pastel blue → pastel red)`,"result")},usage:"bfactor_spectrum <min>, <max>",help:"Set B-factor coloring range and apply. Values below min are pastel blue, above max are pastel red."})}function dl(n){n.register("zoom",{handler:(s,e)=>{const l=A();if(s.trim()){const a=le(s.trim()),c=fe(a);l.zoomTo(c)}else l.zoomTo();l.render(),e.terminal.print("Zoomed to selection","result")},usage:"zoom [selection]",help:"Zoom to fit the selection (or all atoms if none specified)."}),n.register("center",{handler:(s,e)=>{const l=A();if(s.trim()){const a=le(s.trim()),c=fe(a);l.center(c)}else l.center();l.render(),e.terminal.print("Centered on selection","result")},usage:"center [selection]",help:"Center the view on the selection."}),n.register("orient",{handler:(s,e)=>{const l=A();if(s.trim()){const a=le(s.trim()),c=fe(a);l.zoomTo(c)}else l.zoomTo();l.render(),e.terminal.print("Oriented to selection","result")},usage:"orient [selection]",help:"Orient the view to fit the selection."}),n.register("rotate",{handler:(s,e)=>{const l=J(s);if(l.length<2)throw new Error("Usage: rotate <axis>, <angle>");const a=l[0].trim().toLowerCase();if(!["x","y","z"].includes(a))throw new Error("Axis must be x, y, or z");const c=parseFloat(l[1]);if(isNaN(c))throw new Error("Angle must be a number");const f=A();f.rotate(c,a),f.render(),e.terminal.print(`Rotated ${c}° around ${a} axis`,"result")},usage:"rotate <axis>, <angle>",help:"Rotate the view. Axis: x, y, or z. Angle in degrees."}),n.register("translate",{handler:(s,e)=>{const l=J(s);if(l.length<2)throw new Error("Usage: translate <x>, <y>");const a=parseFloat(l[0]),c=parseFloat(l[1]);if(isNaN(a)||isNaN(c))throw new Error("x and y must be numbers");const f=A();f.translate(a,c),f.render(),e.terminal.print(`Translated by (${a}, ${c})`,"result")},usage:"translate <x>, <y>",help:"Translate the view by x, y pixels."}),n.register("clip",{handler:(s,e)=>{const l=J(s);if(l.length<2)throw new Error("Usage: clip <near>, <far>");const a=parseFloat(l[0]),c=parseFloat(l[1]);if(isNaN(a)||isNaN(c))throw new Error("near and far must be numbers");const f=A();f.setSlab(a,c),f.render(),e.terminal.print(`Clipping planes set: near=${a}, far=${c}`,"result")},usage:"clip <near>, <far>",help:"Set clipping planes (near and far distances)."}),n.register("reset",{handler:(s,e)=>{const l=A();l.zoomTo(),l.render(),e.terminal.print("View reset","result")},usage:"reset",help:"Reset the view to show all atoms."})}function ul(n){n.register("select",{handler:(s,e)=>{const l=J(s);if(l.length<2)throw new Error("Usage: select <name>, <expression>");const a=l[0].trim(),c=l.slice(1).join(", ").trim();let f;try{f=hn(c)}catch(m){throw new Error(`Invalid selection expression: ${m.message}`)}const h=A().selectedAtoms({}),u=oe(f,h),p={index:u.map(m=>m.index)};Ue(a,c,p,u.length),e.terminal.print(`Selection "${a}" defined: ${u.length} atoms`,"result")},usage:"select <name>, <expression>",help:"Define a named selection for use in other commands."}),n.register("count_atoms",{handler:(s,e)=>{const l=s.trim()||"all",a=le(l);let c;a.spec?c=A().selectedAtoms(a.spec).length:c=a.atoms.length,e.terminal.print(`Count: ${c} atoms`,"result")},usage:"count_atoms [selection]",help:"Count the number of atoms matching the selection."}),n.register("get_model",{handler:(s,e)=>{const l=s.trim()||"all",a=le(l);let c;a.spec?c=A().selectedAtoms(a.spec):c=a.atoms;const f=new Set(c.map(m=>m.chain)),h=new Set(c.map(m=>`${m.chain}:${m.resi}`)),u=new Set,p=L();for(const[m,b]of p.objects){const g=A().selectedAtoms({model:b.model}),C=new Set(g.map(w=>w.serial));c.some(w=>C.has(w.serial))&&u.add(m)}e.terminal.print(`Atoms: ${c.length}`,"result"),e.terminal.print(`Residues: ${h.size}`,"result"),e.terminal.print(`Chains: ${f.size} (${[...f].join(", ")})`,"result"),e.terminal.print(`Objects: ${u.size} (${[...u].join(", ")})`,"result")},usage:"get_model [selection]",help:"Print summary info about the selection: atoms, residues, chains, objects."})}const nn=["name","atom","resn","resi","chain","elem","index"],fl={name:"atom",atom:"atom",resn:"resn",resi:"resi",chain:"chain",elem:"elem",index:"serial"};function pl(n){n.register("label",{handler:(s,e)=>{const l=J(s);if(l.length<2)throw new Error("Usage: label <selection>, <property>");const a=l.slice(0,-1).join(", ").trim(),c=l[l.length-1].trim().toLowerCase();if(!nn.includes(c))throw new Error(`Unknown label property "${c}". Valid: ${nn.join(", ")}`);const f=le(a),h=A();let u;f.spec?u=h.selectedAtoms(f.spec):u=f.atoms;const p=fl[c];["resn","resi","chain"].includes(c)&&(u=u.filter(m=>m.atom==="CA"));for(const m of u)on(String(m[p]),{x:m.x,y:m.y,z:m.z});h.render(),e.terminal.print(`Added ${u.length} labels (${c})`,"result")},usage:"label <selection>, <property>",help:"Add labels to atoms. Properties: name, resn, resi, chain, elem, index."}),n.register("unlabel",{handler:(s,e)=>{ln(),A().render(),e.terminal.print("All labels removed","result")},usage:"unlabel",help:"Remove all labels from the viewer."})}function ml(n){n.register("remove",{handler:(s,e)=>{const l=s.trim();if(!l)throw new Error("Usage: remove <selection>");const a=le(l),c=fe(a),f=A();let h;if(a.spec?h=f.selectedAtoms(a.spec):h=a.atoms,h.length===0){e.terminal.print("No atoms match the selection","info");return}f.setStyle(c,{}),f.render();const u=h.map(p=>p.index);ut(u),ge(),L().activeSelection&&we(L().activeSelection),e.terminal.print(`Removed ${h.length} atoms`,"result")},usage:"remove <selection>",help:"Remove atoms matching the selection from the viewer."}),n.register("delete",{handler:(s,e)=>{const l=s.trim();if(!l)throw new Error("Usage: delete <name>");const a=L();if(a.selections.has(l)){vt(l),e.terminal.print(`Deleted selection "(${l})"`,"result");return}const c=a.objects.get(l);if(!c)throw new Error(`"${l}" not found`);const f=A(),u=f.selectedAtoms({model:c.model}).map(p=>p.index);f.removeModel(c.model),f.render(),fn(l),ut(u),ge(),L().activeSelection&&we(L().activeSelection),e.terminal.print(`Deleted object "${l}"`,"result")},usage:"delete <name>",help:"Delete a molecular object or named selection."}),n.register("set_name",{handler:(s,e)=>{const l=J(s);if(l.length<2)throw new Error("Usage: set_name <old_name>, <new_name>");const a=l[0].trim(),c=l[1].trim(),f=L();if(f.selections.has(a))pn(a,c),e.terminal.print(`Renamed selection "(${a})" to "(${c})"`,"result");else if(f.objects.has(a))mn(a,c),e.terminal.print(`Renamed "${a}" to "${c}"`,"result");else throw new Error(`"${a}" not found`)},usage:"set_name <old_name>, <new_name>",help:"Rename a molecular object or named selection."})}function hl(n){n.register("png",{handler:(s,e)=>{const l=s.trim()||"screenshot",c=A().pngURI(),f=document.createElement("a");f.href=c,f.download=l.endsWith(".png")?l:`${l}.png`,f.click(),e.terminal.print(`Screenshot saved as "${f.download}"`,"result")},usage:"png [filename]",help:"Export the current view as a PNG image."}),n.register("help",{handler:(s,e)=>{const l=s.trim().toLowerCase();if(l){const a=n.getHelp(l);if(!a)throw new Error(`Unknown command "${l}". Type "help" for a list.`);e.terminal.print(`Usage: ${a.usage}`,"info"),e.terminal.print(a.help,"info")}else{e.terminal.print("Available commands:","info");const a=n.list();for(const c of a){const f=n.getHelp(c);e.terminal.print(`  ${f.usage}`,"info")}e.terminal.print("","info"),e.terminal.print('Type "help <command>" for details.',"info")}},usage:"help [command]",help:"Show available commands or help for a specific command."})}const ot=["HOH","WAT","H2O"];function lt(n,s,e){const l=Fe.pastel.colors,a=n.selectedAtoms(s),c=[...new Set(a.map(u=>u.chain))].sort(),f=Object.assign({},s,{not:{elem:"C"}}),h={};for(const u of e)h[u]={colorscheme:"Jmol"};n.addStyle(f,h),c.forEach((u,p)=>{const m=l[p%l.length],b=Object.assign({},s,{elem:"C",chain:u}),g={};for(const C of e)g[C]={color:m};n.addStyle(b,g)})}function Se(n,s){return Object.assign({},n,s)}const qe={simple:{label:"Simple",description:"Element-colored cartoon with per-chain carbons, sticks for ligands",apply(n,s){return n.setStyle(s,{}),n.addStyle(Se(s,{hetflag:!0,not:{resn:ot}}),{stick:{colorscheme:"Jmol"}}),lt(n,Se(s,{hetflag:!1}),["cartoon"]),n.render(),new Set(["cartoon","stick"])}},sites:{label:"Sites",description:"Element-colored cartoon with per-chain carbons + sticks near ligands",apply(n,s){n.setStyle(s,{});const e=Se(s,{hetflag:!0,not:{resn:ot}});n.addStyle(e,{stick:{colorscheme:"Jmol"}});const l=Se(s,{hetflag:!1});lt(n,l,["cartoon"]);const a=n.selectedAtoms(e);if(a.length>0){const f=n.selectedAtoms(s||{}),h=new Set;for(const u of f)if(!u.hetflag)for(const p of a){const m=u.x-p.x,b=u.y-p.y,g=u.z-p.z;if(m*m+b*b+g*g<=25){h.add(`${u.chain}:${u.resi}`);break}}if(h.size>0){const u=[];for(const p of f)h.has(`${p.chain}:${p.resi}`)&&u.push(p.index);u.length>0&&lt(n,{index:u},["stick"])}}return n.render(),new Set(["cartoon","stick"])}},"ball-and-stick":{label:"Ball-and-Stick",description:"Ball-and-stick for ligands only",apply(n,s){n.setStyle(s,{});const e=Se(s,{hetflag:!0,not:{resn:ot}});return n.addStyle(e,Q("stick")),n.addStyle(e,{sphere:{scale:.3}}),n.render(),new Set(["stick","sphere"])}}},gl=["simple","sites","ball-and-stick"];function bn(n,s,e){const l=n.toLowerCase(),a=qe[l];if(!a){const c=gl.map(f=>qe[f].label).join(", ");throw new Error(`Unknown preset "${n}". Available: ${c}`)}return a.apply(s,e||{})}function bl(n){n.register("preset",{handler:(s,e)=>{const l=J(s);if(l.length===0)throw new Error(`Usage: preset <style> [, selection]
Styles: Simple, Sites, Ball-and-Stick`);const a=l[0].trim(),c=l.slice(1).join(", ")||null;let f={};if(c){const b=le(c);f=fe(b)}const h=A(),u=bn(a,h,f),p=L();if(!c)for(const[,b]of p.objects)b.representations=new Set(u);ee();const m=qe[a.toLowerCase()].label;e.terminal.print(`Applied preset "${m}"${c?` to ${c}`:""}`,"result")},usage:"preset <style> [, selection]",help:"Apply a preset view. Styles: Simple, Sites, Ball-and-Stick."})}function vl(n){ol(n),il(n),cl(n),dl(n),ul(n),pl(n),ml(n),hl(n),bl(n)}function Cl(n){const s=document.createElement("div");s.className="modal-overlay";const e=document.createElement("div");e.className="modal";const l=document.createElement("div");l.className="modal-header";const a=document.createElement("span");a.textContent="Load Structure";const c=document.createElement("button");c.className="modal-close",c.textContent="×",c.addEventListener("click",()=>s.remove()),l.appendChild(a),l.appendChild(c),e.appendChild(l);const f=document.createElement("div");f.className="modal-tabs";const h=document.createElement("button");h.className="modal-tab active",h.textContent="Fetch PDB";const u=document.createElement("button");u.className="modal-tab",u.textContent="Local File",f.appendChild(h),f.appendChild(u),e.appendChild(f);const p=document.createElement("div");p.className="modal-body";const m=document.createElement("div");m.className="modal-panel";const b=document.createElement("input");b.type="text",b.className="modal-input",b.placeholder="Enter PDB ID (e.g. 1UBQ)",b.maxLength=4;const g=document.createElement("button");g.className="modal-btn",g.textContent="Fetch",g.addEventListener("click",()=>{const S=b.value.trim().toUpperCase();S.length===4&&(n.onFetch(S),s.remove())}),b.addEventListener("keydown",S=>{S.key==="Enter"&&g.click()}),m.appendChild(b),m.appendChild(g),p.appendChild(m);const C=document.createElement("div");C.className="modal-panel hidden";const w=document.createElement("input");w.type="file",w.accept=".pdb,.sdf,.mol2,.xyz,.cube,.pqr,.gro,.cif,.mmcif";const $=document.createElement("button");$.className="modal-btn",$.textContent="Load",$.addEventListener("click",()=>{const S=w.files[0];if(!S)return;const N=S.name.split(".").pop().toLowerCase(),j=new FileReader;j.onload=_=>{n.onLoad(_.target.result,N,S.name),s.remove()},j.readAsText(S)}),C.appendChild(w),C.appendChild($),p.appendChild(C),e.appendChild(p),h.addEventListener("click",()=>{h.classList.add("active"),u.classList.remove("active"),m.classList.remove("hidden"),C.classList.add("hidden")}),u.addEventListener("click",()=>{u.classList.add("active"),h.classList.remove("active"),C.classList.remove("hidden"),m.classList.add("hidden")}),s.appendChild(e),s.addEventListener("click",S=>{S.target===s&&s.remove()}),document.body.appendChild(s),b.focus()}function wl(n){const s=document.createElement("div");s.className="modal-overlay";const e=document.createElement("div");e.className="modal";const l=document.createElement("div");l.className="modal-header";const a=document.createElement("span");a.textContent="Export";const c=document.createElement("button");c.className="modal-close",c.textContent="×",c.addEventListener("click",()=>s.remove()),l.appendChild(a),l.appendChild(c),e.appendChild(l);const f=document.createElement("div");f.className="modal-body";const h=document.createElement("div");h.textContent="Export Image",h.style.marginBottom="8px",h.style.fontWeight="bold",f.appendChild(h);const u=document.createElement("div");u.style.display="flex",u.style.gap="8px",u.style.alignItems="center",u.style.marginBottom="12px";const p=A(),m=p&&p.getCanvas?p.getCanvas():null,b=m?m.width:800,g=m?m.height:600,C=document.createElement("input");C.type="number",C.className="modal-input",C.value=b,C.style.width="80px";const w=document.createElement("span");w.textContent=" × ";const $=document.createElement("input");$.type="number",$.className="modal-input",$.value=g,$.style.width="80px",u.appendChild(C),u.appendChild(w),u.appendChild($),f.appendChild(u);const S=document.createElement("button");S.className="modal-btn",S.textContent="Export PNG",S.addEventListener("click",()=>{const N=parseInt(C.value,10)||b,j=parseInt($.value,10)||g;n.onExportPNG(N,j),s.remove()}),f.appendChild(S),e.appendChild(f),s.appendChild(e),s.addEventListener("click",N=>{N.target===s&&s.remove()}),document.body.appendChild(s)}function yl(n){const s=[{cmd:"fetch 1CRN",desc:"Download a structure from the PDB"},{cmd:"show cartoon",desc:"Display as cartoon ribbon"},{cmd:"color chain",desc:"Color by chain assignment"},{cmd:"zoom",desc:"Zoom to fit the molecule"},{cmd:"help",desc:"List all available commands"}],e=document.createElement("div");e.className="quickstart-overlay";const l=document.createElement("div");l.className="quickstart-card";const a=document.createElement("div");a.className="quickstart-title",a.textContent="3Dmol.js GUI";const c=document.createElement("div");c.className="quickstart-subtitle",c.textContent="An interface for molecular visualization";const f=document.createElement("div");f.className="quickstart-commands";for(const{cmd:b,desc:g}of s){const C=document.createElement("div");C.className="quickstart-cmd-row";const w=document.createElement("span");w.className="quickstart-cmd",w.textContent=b;const $=document.createElement("span");$.className="quickstart-cmd-desc",$.textContent=g,C.appendChild(w),C.appendChild($),f.appendChild(C)}const h=document.createElement("div");h.className="quickstart-actions";const u=document.createElement("button");u.className="quickstart-try-btn",u.textContent="Try it!";const p=document.createElement("button");p.className="quickstart-dismiss",p.textContent="Dismiss",h.appendChild(u),h.appendChild(p),l.appendChild(a),l.appendChild(c),l.appendChild(f),l.appendChild(h),e.appendChild(l),document.body.appendChild(e);function m(){e.parentNode&&e.remove()}return u.addEventListener("click",()=>{m(),n.onTry&&n.onTry()}),p.addEventListener("click",()=>{m()}),m}function sn(n,s){const e=document.createElement("div");e.className="modal-overlay";const l=document.createElement("div");l.className="modal";const a=document.createElement("div");a.className="modal-header";const c=document.createElement("span");c.textContent="Rename";const f=document.createElement("button");f.className="modal-close",f.textContent="×",f.addEventListener("click",()=>e.remove()),a.appendChild(c),a.appendChild(f),l.appendChild(a);const h=document.createElement("div");h.className="modal-body";const u=document.createElement("input");u.type="text",u.className="modal-input",u.value=n,u.addEventListener("keydown",m=>{m.key==="Enter"&&p.click()}),h.appendChild(u);const p=document.createElement("button");p.className="modal-btn",p.textContent="Rename",p.addEventListener("click",()=>{const m=u.value.trim();m&&m!==n&&s(m),e.remove()}),h.appendChild(p),l.appendChild(h),e.appendChild(l),e.addEventListener("click",m=>{m.target===e&&e.remove()}),document.body.appendChild(e),u.select(),u.focus()}const El={Action:{callbackKey:"onAction",items:[{label:"Center",value:"center"},{label:"Zoom",value:"zoom"}]},Show:{callbackKey:"onShow",items:[{label:"Cartoon",value:"cartoon"},{label:"Sticks",value:"stick"},{label:"Lines",value:"line"},{label:"Spheres",value:"sphere"},{label:"Surface",value:"surface"},{label:"Cross",value:"cross"},{separator:!0},{label:"Simple",value:"view:simple"},{label:"Sites",value:"view:sites"},{label:"Ball-and-Stick",value:"view:ball-and-stick"}]},Hide:{callbackKey:"onHide",items:[{label:"Everything",value:"everything"},{separator:!0},{label:"Cartoon",value:"cartoon"},{label:"Sticks",value:"stick"},{label:"Lines",value:"line"},{label:"Spheres",value:"sphere"},{label:"Surface",value:"surface"},{label:"Cross",value:"cross"}]},Label:{callbackKey:"onLabel",items:[{label:"Atom Name",value:"atom"},{label:"Residue Name",value:"resn"},{label:"Chain ID",value:"chain"},{label:"Element",value:"elem"},{label:"Index",value:"index"},{separator:!0},{label:"Clear",value:"clear"}]},Color:{callbackKey:"onColor",items:[{label:"Solid",value:"solid",submenu:"solid-swatches"},{label:"By Element",value:"element",submenu:"element-swatches"},{label:"By Chain",value:"chain",submenu:"chain-palettes"},{label:"By SS",value:"ss",submenu:"ss-palettes"},{label:"By B-Factor",value:"bfactor"}]}};let He=null;function ae(){He&&(He.remove(),He=null)}function $l(n,s){n.addEventListener("contextmenu",a=>{a.preventDefault(),ae();const c=s.hasSelection(),f=Sl(c,s);document.body.appendChild(f),He=f;const h=f.getBoundingClientRect();let u=a.clientY,p=a.clientX;u+h.height>window.innerHeight&&(u=window.innerHeight-h.height),p+h.width>window.innerWidth&&(p=window.innerWidth-h.width),u<0&&(u=0),p<0&&(p=0),f.style.top=`${u+window.scrollY}px`,f.style.left=`${p+window.scrollX}px`,requestAnimationFrame(()=>{document.addEventListener("click",e,!0),document.addEventListener("contextmenu",l,!0)})});function e(){ae(),document.removeEventListener("click",e,!0),document.removeEventListener("contextmenu",l,!0)}function l(){ae(),document.removeEventListener("click",e,!0),document.removeEventListener("contextmenu",l,!0)}document.addEventListener("keydown",a=>{a.key==="Escape"&&ae()})}function Sl(n,s){const e=document.createElement("div");e.className="context-menu";for(const[l,a]of Object.entries(El)){const c=document.createElement("div");c.className="context-menu-item",n||c.classList.add("disabled");const f=document.createElement("span");f.textContent=l,c.appendChild(f);const h=document.createElement("span");h.className="context-menu-arrow",h.textContent="▶",c.appendChild(h);const u=document.createElement("div");u.className="context-menu-submenu";for(const p of a.items)if(p.separator){const m=document.createElement("div");m.className="context-menu-separator",u.appendChild(m)}else if(p.submenu==="element-swatches"){const m=document.createElement("div");m.className="context-menu-submenu-item context-menu-has-submenu";const b=document.createElement("span");b.textContent=p.label,m.appendChild(b);const g=document.createElement("span");g.className="context-menu-arrow",g.textContent="▶",m.appendChild(g);const C=document.createElement("div");C.className="context-menu-submenu";const w=document.createElement("div");w.className="context-menu-submenu-item",w.textContent="Standard",w.addEventListener("click",N=>{N.stopPropagation(),ae(),n&&s[a.callbackKey]&&s[a.callbackKey](p.value)}),C.appendChild(w);const $=document.createElement("div");$.className="context-menu-separator",C.appendChild($);const S=document.createElement("div");S.className="swatch-grid";for(const N of cn){const j=document.createElement("div");j.className="swatch-cell",j.style.backgroundColor=N.hex,j.title=`${N.label} (${N.hex})`,j.addEventListener("click",_=>{_.stopPropagation(),ae(),n&&s[a.callbackKey]&&s[a.callbackKey](p.value+":"+N.hex)}),S.appendChild(j)}C.appendChild(S),m.appendChild(C),u.appendChild(m)}else if(p.submenu==="solid-swatches"){const m=document.createElement("div");m.className="context-menu-submenu-item context-menu-has-submenu";const b=document.createElement("span");b.textContent=p.label,m.appendChild(b);const g=document.createElement("span");g.className="context-menu-arrow",g.textContent="▶",m.appendChild(g);const C=document.createElement("div");C.className="context-menu-submenu";const w=document.createElement("div");w.className="swatch-grid";for(const $ of dn){const S=document.createElement("div");S.className="swatch-cell",S.style.backgroundColor=$.hex,S.title=`${$.label} (${$.hex})`,S.addEventListener("click",N=>{N.stopPropagation(),ae(),n&&s[a.callbackKey]&&s[a.callbackKey]($.hex)}),w.appendChild(S)}C.appendChild(w),m.appendChild(C),u.appendChild(m)}else if(p.submenu==="chain-palettes"){const m=document.createElement("div");m.className="context-menu-submenu-item context-menu-has-submenu";const b=document.createElement("span");b.textContent=p.label,m.appendChild(b);const g=document.createElement("span");g.className="context-menu-arrow",g.textContent="▶",m.appendChild(g);const C=document.createElement("div");C.className="context-menu-submenu";for(const[w,$]of Object.entries(Fe)){const S=document.createElement("div");S.className="context-menu-submenu-item",S.textContent=$.label,S.addEventListener("click",N=>{N.stopPropagation(),ae(),n&&s[a.callbackKey]&&s[a.callbackKey]("chain:"+w)}),C.appendChild(S)}m.appendChild(C),u.appendChild(m)}else if(p.submenu==="ss-palettes"){const m=document.createElement("div");m.className="context-menu-submenu-item context-menu-has-submenu";const b=document.createElement("span");b.textContent=p.label,m.appendChild(b);const g=document.createElement("span");g.className="context-menu-arrow",g.textContent="▶",m.appendChild(g);const C=document.createElement("div");C.className="context-menu-submenu";for(const w of bt){const $=document.createElement("div");$.className="context-menu-submenu-item ss-palette-item";const S=document.createElement("span");S.textContent="Helix",S.style.color=w.helix,$.appendChild(S),$.appendChild(document.createTextNode(" – "));const N=document.createElement("span");N.textContent="Sheet",N.style.color=w.sheet,$.appendChild(N),$.appendChild(document.createTextNode(" – "));const j=document.createElement("span");j.textContent="Loop",j.style.color=w.loop,$.appendChild(j),$.addEventListener("click",_=>{_.stopPropagation(),ae(),n&&s[a.callbackKey]&&s[a.callbackKey]("ss:"+w.key)}),C.appendChild($)}m.appendChild(C),u.appendChild(m)}else{const m=document.createElement("div");m.className="context-menu-submenu-item",m.textContent=p.label,m.addEventListener("click",b=>{b.stopPropagation(),ae(),n&&(p.value.startsWith("view:")&&s.onView?s.onView(p.value.slice(5)):s[a.callbackKey]&&s[a.callbackKey](p.value))}),u.appendChild(m)}c.appendChild(u),e.appendChild(c)}return e}const xl={red:"#FF0000",green:"#00FF00",blue:"#0000FF",yellow:"#FFFF00",cyan:"#00FFFF",magenta:"#FF00FF",orange:"#FFA500",white:"#FFFFFF",grey:"#808080"};function Ct(n){let s=n,e=null,l=null,a=null;return s.startsWith("element:")?(e=s.slice(8),s="element"):s.startsWith("chain:")?(l=s.slice(6),s="chain"):s.startsWith("ss:")&&(a=s.slice(3),s="ss"),{scheme:s,carbonHex:e,chainPalette:l,ssPalette:a}}function ft(n){const{scheme:s,carbonHex:e,chainPalette:l,ssPalette:a}=Ct(n);return e?`element (C=${e})`:l?`chain (${l})`:a?`ss (${a})`:s}function vn(n,s,e,l){const a=L(),c=a.settings.bfactorMin??Kt.min,f=a.settings.bfactorMax??Kt.max,h={element:"Jmol",chain:"chain",ss:"ssJmol",bfactor:un(c,f)};let u=null;if(s&&Fe[s]){const p=Fe[s].colors,m=A().selectedAtoms(l),b=[...new Set(m.map(C=>C.chain))].sort(),g={};b.forEach((C,w)=>{g[C]=p[w%p.length]}),u={prop:"chain",map:g}}if(e){const p=bt.find(m=>m.key===e);p&&p.key!=="default"&&(u={prop:"ss",map:{h:p.helix,s:p.sheet,c:p.loop,"":p.loop}})}return{schemes:h,customScheme:u}}function Cn(n,s,e,l,a,c,f){if(a[l]){const h=c||a[l],u={};for(const p of e)l==="bfactor"?u[p]={colorfunc:h}:u[p]={colorscheme:h};if(n.setStyle(s,u),f){const p=Object.assign({},s,{elem:"C"}),m={};for(const b of e)m[b]={color:f};n.setStyle(p,m)}}else{const h=xl[l]||l,u={};for(const p of e)u[p]={color:h};n.setStyle(s,u)}}function Fl(n,s,e){const l=A(),{scheme:a,carbonHex:c,chainPalette:f,ssPalette:h}=Ct(e),{schemes:u,customScheme:p}=vn(a,f,h,n),m=s.size>0?s:new Set(["cartoon"]);Cn(l,n,m,a,u,p,c),l.render()}function wn(n,s){const e=A(),l=L(),{scheme:a,carbonHex:c,chainPalette:f,ssPalette:h}=Ct(s),{schemes:u,customScheme:p}=vn(a,f,h,n);for(const[,m]of l.objects){if(!m.visible)continue;const b=Object.assign({},n,{model:m.model}),g=m.representations.size>0?m.representations:new Set(["cartoon"]);Cn(e,b,g,a,u,p,c)}e.render()}function pt(n,s){const e=A();if(s==="clear"){ln(),e.render();return}const a={atom:"atom",resn:"resn",resi:"resi",chain:"chain",elem:"elem",index:"serial"}[s]||s;let c=e.selectedAtoms(n);["resn","resi","chain"].includes(s)&&(c=c.filter(f=>f.atom==="CA"));for(const f of c)on(String(f[a]),{x:f.x,y:f.y,z:f.z});e.render()}function Al(n,s,e){const l=A(),a=s==="line"&&e.representations.has("stick"),c=s==="stick"&&e.representations.has("line");if(e.representations.add(s),!a)if(c){l.setStyle(n,{});for(const f of e.representations)f==="line"&&e.representations.has("stick")||l.addStyle(n,Q(f))}else l.addStyle(n,Q(s));l.render(),ee()}function Ll(n,s,e){const l=A();if(s==="everything")l.setStyle(n,{}),e.representations.clear();else{l.setStyle(n,{}),e.representations.delete(s);for(const a of e.representations)a==="line"&&e.representations.has("stick")||l.addStyle(n,Q(a))}l.render(),ee()}function yn(n,s){const e=A(),l=L();if(s==="everything")e.setStyle(n,{});else for(const[,a]of l.objects){if(!a.visible)continue;const c=Object.assign({},n,{model:a.model});e.setStyle(c,{});for(const f of a.representations)f!==s&&(f==="line"&&a.representations.has("stick")||e.addStyle(c,Q(f)))}e.render()}function We(n,s){const e=A();return bn(n,e,s)}function Ke(n){const s=qe[n.toLowerCase()];return s?s.label:n}if(typeof $3Dmol>"u"){const n=document.createElement("div");throw n.style.cssText="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#1e1e1e;color:#ff6b6b;font-family:monospace;font-size:16px;padding:20px;text-align:center;",n.textContent="Error: 3Dmol.js failed to load. Check your network connection or host the library locally. See index.html for instructions.",document.body.appendChild(n),new Error("3Dmol.js not loaded")}const Ye=document.getElementById("app");Uo(document.getElementById("viewer-container"));const k=Xo(document.getElementById("terminal-container")),wt=Ko(document.getElementById("sidebar-container"),{onToggleVisibility(n){const s=Qo(n);s&&(s.visible?s.model.show():s.model.hide(),A().render(),wt.refresh(L()))},onAction(n,s){const l=L().objects.get(n);if(!l)return;const a=A();switch(s){case"center":a.center({model:l.model}),a.render(),k.print(`Centered on "${n}"`,"result");break;case"orient":case"zoom":a.zoomTo({model:l.model}),a.render(),k.print(`Zoomed to "${n}"`,"result");break;case"delete":{const f=a.selectedAtoms({model:l.model}).map(h=>h.index);a.removeModel(l.model),a.render(),fn(n),ut(f);for(const h of f)ne.delete(h);ge(),L().activeSelection&&we(L().activeSelection),k.print(`Deleted "${n}"`,"result");break}case"rename":{sn(n,c=>{try{mn(n,c),k.print(`Renamed "${n}" to "${c}"`,"result")}catch(f){k.print(f.message,"error")}});break}case"duplicate":k.print("Duplicate not yet implemented","info");break}},onShow(n,s){const l=L().objects.get(n);l&&(Al({model:l.model},s,l),k.print(`Showing ${s} on "${n}"`,"result"))},onHide(n,s){const l=L().objects.get(n);l&&(Ll({model:l.model},s,l),k.print(`Hiding ${s} on "${n}"`,"result"))},onLabel(n,s){const l=L().objects.get(n);l&&(pt({model:l.model},s),k.print(s==="clear"?"Labels cleared":`Labeled "${n}" by ${s}`,"result"))},onView(n,s){const l=L().objects.get(n);if(!l)return;const a=We(s,{model:l.model});l.representations=new Set(a),ee(),k.print(`Applied "${Ke(s)}" preset to "${n}"`,"result")},onColor(n,s){const l=L().objects.get(n);l&&(Fl({model:l.model},l.representations,s),k.print(`Colored "${n}" by ${ft(s)}`,"result"))},onToggleSelectionVisibility(n){el(n)},onSelectionAction(n,s){const l=L().selections.get(n);if(l)switch(s){case"delete":vt(n),k.print(`Deleted selection "(${n})"`,"result");break;case"rename":{sn(n,a=>{try{pn(n,a),k.print(`Renamed "(${n})" to "(${a})"`,"result")}catch(c){k.print(c.message,"error")}});break}case"center":A().center(l.spec),A().render(),k.print(`Centered on "(${n})"`,"result");break;case"zoom":A().zoomTo(l.spec),A().render(),k.print(`Zoomed to "(${n})"`,"result");break}},onSelectionShow(n,s){const e=L().selections.get(n);e&&(A().addStyle(e.spec,Q(s)),A().render(),k.print(`Showing ${s} on "(${n})"`,"result"))},onSelectionHide(n,s){const e=L().selections.get(n);e&&(yn(e.spec,s),k.print(`Hiding ${s} on "(${n})"`,"result"))},onSelectionLabel(n,s){const e=L().selections.get(n);e&&(pt(e.spec,s),k.print(s==="clear"?"Labels cleared":`Labeled "(${n})" by ${s}`,"result"))},onSelectionColor(n,s){const e=L().selections.get(n);e&&(wn(e.spec,s),k.print(`Colored "(${n})" by ${ft(s)}`,"result"))},onSelectionView(n,s){const e=L().selections.get(n);e&&(We(s,e.spec),k.print(`Applied "${Ke(s)}" preset to "(${n})"`,"result"))}}),En=Vo(document.getElementById("menubar-container"),{onLoad(){Cl({onFetch:async n=>{k.print(`Fetching PDB ${n}...`,"info");try{const s=await an(n),e=s.getID?s.getID():null,l=Ae(n,s,e);k.print(`Loaded ${n} as "${l}"`,"result")}catch(s){k.print(`Failed to fetch ${n}: ${s.message}`,"error")}},onLoad:(n,s,e)=>{try{const l=ht(n,s),a=l.getID?l.getID():null,c=e.replace(/\.[^.]+$/,""),f=Ae(c,l,a);k.print(`Loaded "${e}" as "${f}"`,"result")}catch(l){k.print(`Error loading file: ${l.message}`,"error")}}})},onExport(){wl({onExportPNG:(n,s)=>{const l=A().getCanvas();if(!l){k.print("Export failed: no canvas available","error");return}const a=document.createElement("canvas");a.width=n,a.height=s,a.getContext("2d").drawImage(l,0,0,n,s);const f=a.toDataURL("image/png"),h=document.createElement("a");h.href=f,h.download="screenshot.png",h.click(),k.print(`Screenshot exported (${n}x${s})`,"result")}})},onView(n){const s=We(n),e=L();for(const[,l]of e.objects)l.representations=new Set(s);ee(),k.print(`Applied "${Ke(n)}" preset`,"result")},onSelectionMode(n){Jo(n),k.print(`Selection mode: ${n}`,"info")},onSelect(n){const s=A(),e=["ALA","ARG","ASN","ASP","CYS","GLN","GLU","GLY","HIS","ILE","LEU","LYS","MET","PHE","PRO","SER","THR","TRP","TYR","VAL","HSD","HSE","HSP","HIE","HID","HIP","CYX","MSE"];let l,a;switch(n){case"protein":l={resn:e},a="protein";break;case"ligand":l={hetflag:!0,not:{resn:["HOH","WAT","H2O"]}},a="ligand";break;case"backbone":l={resn:e,atom:["N","CA","C","O"]},a="backbone";break;case"sidechains":l={resn:e,not:{atom:["N","CA","C","O"]}},a="side chains";break;default:return}const c=s.selectedAtoms(l);if(c.length===0){k.print(`No atoms matched for ${a}`,"info");return}ne.clear();for(const h of c)ne.add(h.index);const f={index:[...ne]};ge(),we(f),Ge(f),Ue("sele",a,f,c.length),k.print(`Selected ${a} [${c.length} atoms]`,"info")},onExpand(n){const s=L();if(!s.activeSelection){k.print("No active selection to expand","info");return}const e=A(),l=e.selectedAtoms(s.activeSelection);if(l.length===0){k.print("Current selection contains no atoms","info");return}const a=new Set(l.map(u=>u.index)),c=e.selectedAtoms({});let f;switch(n){case"residues":{const u=new Set(l.map(p=>`${p.chain}:${p.resi}`));for(const p of c)u.has(`${p.chain}:${p.resi}`)&&a.add(p.index);f="residues";break}case"chains":{const u=new Set(l.map(p=>p.chain));for(const p of c)u.has(p.chain)&&a.add(p.index);f="chains";break}case"molecules":{const u=new Set(l.map(p=>p.model));for(const p of c)u.has(p.model)&&a.add(p.index);f="molecules";break}case"nearAtoms":{for(const p of c)if(!a.has(p.index))for(const m of l){const b=p.x-m.x,g=p.y-m.y,C=p.z-m.z;if(b*b+g*g+C*C<=25){a.add(p.index);break}}f="near atoms (5Å)";break}case"nearResidues":{const p=new Set([...a]);for(const g of c)if(!p.has(g.index))for(const C of l){const w=g.x-C.x,$=g.y-C.y,S=g.z-C.z;if(w*w+$*$+S*S<=25){p.add(g.index);break}}const m=c.filter(g=>p.has(g.index)),b=new Set(m.map(g=>`${g.chain}:${g.resi}`));for(const g of c)b.has(`${g.chain}:${g.resi}`)&&a.add(g.index);f="near residues (5Å)";break}default:return}ne=a;const h={index:[...ne]};ge(),we(h),Ge(h),Ue("sele",`expand ${f}`,h,a.size),k.print(`Expanded to ${f} [${a.size} atoms]`,"info")},onSelectionAction(n){const s=L();if(!s.activeSelection){k.print("No active selection","info");return}const e=A();switch(n){case"center":e.center(s.activeSelection),e.render(),k.print("Centered on selection","result");break;case"zoom":e.zoomTo(s.activeSelection),e.render(),k.print("Zoomed to selection","result");break}},onToggleSidebar(){Ye.classList.toggle("sidebar-hidden"),A().resize(),A().render()},onToggleTerminal(){Ye.classList.toggle("terminal-hidden"),A().resize(),A().render()},onToggleCompact(n){En.setCompact(n)},onThemeChange(n){const s=L();if(s.settings.theme=n,document.body.dataset.theme=n==="light"?"light":"",!s.settings.userSetBgColor){const e=n==="light"?"#ffffff":"#000000";s.settings.bgColor=e,A().setBackgroundColor(e)}Mo(),A().render(),ee();try{localStorage.setItem("3dmol-gui-theme",n)}catch{}}});{let n="dark";try{n=localStorage.getItem("3dmol-gui-theme")||"dark"}catch{}if(n==="light"){const s=L();s.settings.theme="light",document.body.dataset.theme="light",En.setTheme("light"),s.settings.userSetBgColor||(s.settings.bgColor="#ffffff",A().setBackgroundColor("#ffffff"),A().render())}}const Ze=sl(),$n=rl({viewer:A(),terminal:k,sidebar:wt,state:L()});vl(Ze);let ne=new Set,mt=!1;function kl(n,s){const e=s.selectionMode;let l,a;switch(e){case"atoms":l={serial:n.serial},a=`atom ${n.atom} (${n.resn} ${n.chain}:${n.resi})`;break;case"residues":l={chain:n.chain,resi:n.resi},a=`residue ${n.resn} ${n.chain}:${n.resi}`;break;case"chains":l={chain:n.chain},a=`chain ${n.chain}`;break;case"molecules":{let c={};for(const[f,h]of s.objects)if((h.model.getID?h.model.getID():h.modelIndex)===n.model){c={model:h.model},a=`molecule "${f}"`;break}a||(a="all atoms"),l=c;break}default:l={serial:n.serial},a=`atom ${n.atom}`}return{selSpec:l,description:a}}function Nl(n,s,e){mt=!0;const l=L(),a=l.selectionMode,c=e&&e.shiftKey,{selSpec:f,description:h}=kl(n,l),u=s.selectedAtoms(f);c||ne.clear();for(const g of u)ne.add(g.index);const p={index:[...ne]};ge(),we(p),Ge(p),Ue("sele","click selection",p,ne.size);const m=c?"Added":"Selected",b=ne.size;k.print(`${m} ${h} [mode: ${a}, ${b} atom${b!==1?"s":""} total]`,"info")}Go(Nl);{let s=null;const e=document.getElementById("viewer-container");e.addEventListener("mousedown",l=>{s={x:l.clientX,y:l.clientY}}),e.addEventListener("click",l=>{const a=s&&(Math.abs(l.clientX-s.x)>4||Math.abs(l.clientY-s.y)>4);s=null,!a&&setTimeout(()=>{!mt&&ne.size>0&&(ne.clear(),ge(),Ge(null),vt("sele")),mt=!1},0)})}$l(document.getElementById("viewer-container"),{hasSelection(){return L().activeSelection!==null},onAction(n){const s=A(),e=L().activeSelection;if(e)switch(n){case"center":s.center(e),s.render(),k.print("Centered on selection","result");break;case"zoom":s.zoomTo(e),s.render(),k.print("Zoomed to selection","result");break}},onView(n){const s=L().activeSelection;s&&(We(n,s),k.print(`Applied "${Ke(n)}" preset to selection`,"result"))},onShow(n){const s=A(),e=L().activeSelection;e&&(s.addStyle(e,Q(n)),s.render(),k.print(`Showing ${n} on selection`,"result"))},onHide(n){const s=L().activeSelection;s&&(yn(s,n),k.print(`Hiding ${n} on selection`,"result"))},onLabel(n){const s=L().activeSelection;s&&(pt(s,n),k.print(n==="clear"?"Labels cleared":`Labeled selection by ${n}`,"result"))},onColor(n){const s=L().activeSelection;s&&(wn(s,n),k.print(`Colored selection by ${ft(n)}`,"result"))}});k.setCompleter((n,s)=>{if(s)return Ze.completions(n);const e=L(),l=n.toLowerCase();return[...e.objects.keys(),...e.selections.keys()].filter(c=>c.toLowerCase().startsWith(l)).sort()});tl(()=>wt.refresh(L()));let ze=null;const te=window.__C3D_INIT__;if(te){const n=te.molecules||[];for(const l of n){const a=ht(l.data,l.format),c=a.getID?a.getID():null;Ae(l.name||l.format,a,c)}const s=A();s.setStyle({},{});const e=te.styles||[];for(const l of e)s.addStyle(l.selection||{},l.style||{});if(te.ui&&(te.ui.sidebar===!1&&Ye.classList.add("sidebar-hidden"),te.ui.terminal===!1&&Ye.classList.add("terminal-hidden"),te.ui.menubar===!1&&(document.getElementById("menubar-container").style.display="none")),te.background){s.setBackgroundColor(te.background);const l=L();l.settings.bgColor=te.background,l.settings.userSetBgColor=!0,ee()}te.zoomTo!==void 0&&te.zoomTo!==null?s.zoomTo(te.zoomTo):s.zoomTo(),s.render(),k.print(`Loaded ${n.length} molecule(s) from initialization`,"info")}else k.print('3Dmol.js GUI ready. Type "help" for commands.',"info"),ze=yl({async onTry(){k.print("> fetch 1CRN","command");try{await Ze.execute("fetch 1CRN",$n)}catch(n){k.print(n.message,"error")}},onDismiss(){}});k.onCommand(async n=>{ze&&(ze(),ze=null),k.print(`> ${n}`,"command");try{await Ze.execute(n,$n)}catch(s){k.print(s.message,"error")}});
